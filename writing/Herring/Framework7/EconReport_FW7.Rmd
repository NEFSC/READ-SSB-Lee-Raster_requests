---
title: "Tables and Reports for Framework 7"
author: Min-Yang Lee
date: "`r format(Sys.time(), '%B %d, %Y')`" 
output:
  pdf_document:
    keep_tex: TRUE
    fig_caption: Yes
  word_document: default
  html_document: 
   self_contained: TRUE
   toc: TRUE
   toc_float: TRUE
urlcolor: blue
editor_options:
  chunk_output_type: console
compact-title: FALSE
---
<!-- 
This is the markdown document used to make the generic report for Herring FW7.  It uses the offshoreWind package
-->

```{r global_options, include=FALSE}

# ### install offshoreWind package from Github if needed
if(!require(offshoreWind)) {
  if(!require(devtools)) {
    install.packages("devtools")
    require(devtools)}
  install_github("dcorvi/offshoreWind")
  require(offshoreWind)}

PKG <- c("foreign", "data.table", "dichromat", "RColorBrewer", "lattice", "scales",  "openxlsx", "sp", "rgdal", "raster","snowfall",
         "ggplot2", "dplyr", "tidyr", "stringr", "knitr", "lubridate", "devtools", "RODBC",  "googledrive", "googlesheets4","rasterVis","classInt", "rgeos")
for (p in PKG) {
  if(!require(p,character.only = TRUE)) {
    install.packages(p)
    require(p,character.only = TRUE)}
}
#############################################################################
#knitr options

knitr::opts_chunk$set(echo=FALSE, warning = FALSE, error = FALSE, message = FALSE, comment = FALSE, cache = FALSE, progress = TRUE, verbose = FALSE, 
											dpi = 600)
options(tinytex.verbose = TRUE)
# options(knitr.table.format = "latex")

# knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'myfile.pdf')) })
#############################################################################


#############################################################################
# figure out the OS 
# Different setups based on whether you are using Windows or Not-windows
desktopUse = ifelse(unname(Sys.info()["sysname"]) == "Windows", TRUE, FALSE)


# We have set network_location_desktop and network_location_remove in  .Rprofile
  if (desktopUse) { # set the root path of the network, based on whether on desktop or server
    network_location = network_location_desktop
    system("ipconfig", intern = TRUE)
  } else {
    network_location = network_location_remote
  }




#############################################################################

#############################################################################
# versioning options
#todaysdate <- Sys.Date()
todaysdate<-"2021-05-18"
#############################################################################
# Paths, names, and locations of inputs and outputs
offshoreWindpath<-file.path(network_location,"home2","mlee","offshoreWind")
project_root_path<-file.path(network_location,"home2","mlee","READ-SSB-Lee-Raster_requests")
wind_area_hard_name = "Herring Framework 7"

raster_manifest_location<-file.path(project_root_path,"raw_data")
#individual.raster.file="raster_manifest_2021-03-15.Rds"
individual.raster.file=paste0("raster_manifest_",todaysdate,".Rds")
payloadRDS=file.path(raster_manifest_location,individual.raster.file)

root.geotiff.path<-file.path(project_root_path,"geotiffs","Herring","Framework7")
root.image.path = file.path(project_root_path,"images","Herring","Framework7")
root.table.path = file.path(project_root_path,"tables","Herring","Framework7")

ML.GIS.PATH<-file.path(network_location,"home2", "mlee", "spatial data")

#############################################################################

# Fire up ROracle if you're on a unix machine.
  if (.Platform$OS.type == "unix") {
     if(!require(ROracle)) {
    install.packages("ROracle")
    require(ROracle)}
#SETUP ROracle connections
source(file.path(project_root_path,"R_code/project_logistics/R_credentials.R"))
  }



#############################################################################
# GIS options, you  probably shouldn't change these. 

BASE.RASTER = raster(file.path(network_location,"work5","socialsci","Geret_Rasters","Data","BASERASTER_AEA_2"))
PROJ.USE = CRS('+proj=aea +lat_1=28 +lat_2=42 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0 ') 
# Albers Equal Area conic (in meters)

#############################################################################


START.YEAR<-2010
#START.YEAR<-2018
END.YEAR<-2019



###################################################################################################
############SETUP RASTER MAPPING AND CONFIDENTIALITY OPTIONS ######################################
###################################################################################################
  #rescale to "total [[ACTIVITY]] per square km" requires dividing by 4 because the grid cells are 0.25 km^2
  rescale_factor<-4

# Seed for subsampling
    set.seed(24601)
# Max nodes for raster confidentiality    
    max.nodes<-8
##################################

### Setting up BINNING options: 

# Number of breaks  -  for classifiying raster values into bins
nbreaks=5

# Subsample for Jenks Natural breaks classifications?  Set sampling-seed later
num_jenks_subs=5000 # Maybe this should be higher; set to 1000 for the map production process. But, the higher the sample the longer it takes to run.

# Here we exclude all cells <=1. (Later we deal with rasters with so few cells above the lower bound value,
    # that we change the sample size to match the number of cells with those values.)
jenks.lowerbound=1/rescale_factor

# Min and Max x and y values set to standardize plot extent # the plot extent is set, but then adjusted based on the location of points in the plotted region
my.ylimit=c(250000,850000)
my.xlimit=c(1900000,2450000)

#cut point options 
#my.at <- seq(10, 2500, 500) #this defines equal intervals from 10 to 2500 by 500 units.

#turn things on or or off 
myscaleopts <- list(draw=FALSE) #Don't draw axes
#myscaleopts <- list(draw=TRUE)


brewer.friendly.ygb <- c("#ffffff", brewer.pal(nbreaks, "YlGnBu"))
my.friendly.YGB=rasterTheme(region=brewer.friendly.ygb)

#color options (par.setting)
mycoloropts <- c(my.friendly.YGB)
our.max.pixels=8e8

# PNG Image Size in pixel units (?) 
png.height<-1800
png.width<-1400

## land color 
mylandfill<- "#d1d1e0"
############################


# Number of color value "bins", plus 0-value will be added too.
numclasses <- 5

# Set Color Ramp Values 
brewer.friendly.bupu <- c("#ffffff", brewer.pal(numclasses, "BuPu")) # Blue to purple  (low to high) 
my.friendly.BUPU <- rasterTheme(region=brewer.friendly.bupu)
 
mycoloropts <-  c(my.friendly.BUPU) 

# Other Plotting Settings 
myckey <- list(labels=list(cex=2)) # Set the size of color ramp labels (?)




###################################################################################################
############END OF SETUP RASTER MAPPING AND CONFIDENTIALITY OPTIONS ###############################
###################################################################################################      
      
# Prep data for this vignette must be created with getCallAreaEffort function in the package
# This must be done seperately from within the vignette and the results placed in a seperate folder 
# because of the amount of time it takes for the function to run for each shape, which can take a couble of hours 
# on the VENUS or MARS R servers or days on an 8 processor laptop, which also depends on the number and size of the requested shapefiles 

# All sections should be able to run independtly from each other after the revenue table is built

```	


```{r getcallArea, include=FALSE, eval = F}  
#Dennis ran this on March 11, 2021
#Plopping this in here, so I know how to find it if I have to update
getCallAreaEffort(raster_folder =
    file.path(network_location,"work5/socialsci/Geret_Rasters/Data/individualrasters",
    shapefile_f = file.path(network_location,"home5/dcorvi/geret_data_request/HerringFW7",
    output_f = file.path(network_location,"home5/dcorvi/geret_data_request/HerringFW7_output_CW",
    start = 2010,
    end = 2019)
```


```{r construct raster manifest, eval = F}  
source(file.path(project_root_path,"R_code/raster_manifest.R"))
```



```{r load_libraries_and_sign_in_to_Google, eval = T}  
#------------------------------- Remember to enter a selection (1 or 0) to sign into Google in this code chunk -------------------------------# 


# During the first run the user will be prompted to complete the OAuth process by signing into a Google account through a browser and create a token for Google access
# the token will expire after a few months - when this happens, the user will get an error and have to detach and reattache (i.e. detach("package:googlesheets4", unload = TRUE) then library(googlesheets4)) the package and should enter 0 when prompted for selection.
# Gsheet_BOEM_lease_area_table_id = "14MdREhJYjORPkb57n6NYEBSEVxeW3_Studsp0dB8KWc" # this is the id of the google sheet. Find the id of a Googe Sheet using googledrive::drive_find("BOEM Lease Area Table") %>% pull(id)

# Project_Areas_12_3_2019_id = "17auz32s3BYk7K30gT45yUCTQ_hnp_s0i" # Google ID of zip of area shapefiles

```

```{r LOAD_EXISTING_GIS_DATA, include=FALSE, eval=T}

##############################################
## SECTION 4 - LOAD EXISTING GIS DATA
#################################################


# STATISTICAL AREAS
my_basemap1 = readOGR(dsn=file.path(ML.GIS.PATH,"nmfs spatial data","corrected_stat_areas"), layer="Statistical_Areas", verbose=F)
my_basemap1 = spTransform(my_basemap1, CRS=PROJ.USE)# Don't project if you're plotting in a lat/lon, not-projected CRS

# Establish "the other"lat lon" projection info
PROJ.LATLON = crs(my_basemap1)

#THIRTY MINUTE SQUARES
basemap_30min = readOGR(dsn=file.path(ML.GIS.PATH,"nmfs spatial data", "Thirty_Minute_Squares"), layer="Thirty_Minute_Squares", verbose=F)
basemap_30min = spTransform(basemap_30min, CRS=PROJ.USE) # Don't project if you're plotting in a lat/lon, not-projected CRS

# EastCoast_states
basemap_eastcoast = readOGR(dsn=file.path(ML.GIS.PATH,"basic spatial data","more_states"), layer="EastCoast_states", verbose=F)
basemap_eastcoast = spTransform(basemap_eastcoast, CRS=PROJ.USE) # Don't project if you're plotting in a lat/lon, not-projected CRS

# EEZ Shapefiles
basemap_EEZ = readOGR(dsn=file.path(ML.GIS.PATH,"nmfs spatial data", "USEEZ"), layer="useez", verbose=F)
basemap_EEZ = spTransform(basemap_EEZ, CRS=PROJ.USE) # Don't project if you're plotting in a lat/lon, not-projected CRS

# Herring Management areas
basemap_herringHMA = readOGR(dsn=file.path(ML.GIS.PATH,"spatial management measures", "garfo gis", "Herring_Management_Areas"), layer="Herring_Management_Areas_mod", verbose=F)
basemap_herringHMA = spTransform(basemap_herringHMA, CRS=PROJ.USE)


#Multispecies Closed Areas CAI, CAII, NLS)
CAI_grnd = readOGR(dsn=file.path(ML.GIS.PATH,"spatial management measures","multispecies closed areas"), layer="mults_ca1", verbose=F)
CAI_grnd = spTransform(CAI_grnd, CRS=PROJ.USE)
CAI_grnd = CAI_grnd[CAI_grnd$id==2,]

CAII_grnd = readOGR(dsn=file.path(ML.GIS.PATH,"spatial management measures","multispecies closed areas"), layer="mults_ca2", verbose=F)
CAII_grnd = spTransform(CAII_grnd, CRS=PROJ.USE)

NLS_grnd = readOGR(dsn=file.path(ML.GIS.PATH,"spatial management measures","multispecies closed areas"), layer="mults_nls", verbose=F)
NLS_grnd = spTransform(NLS_grnd, CRS=PROJ.USE)

Closedgf_04_15 = gUnion(CAI_grnd[CAI_grnd$id==2,],CAII_grnd)
Closedgf_04_15 = gUnion(Closedgf_04_15,NLS_grnd)



```



```{r get_area_overlays, eval = T} 
# Take the overlap files in this code chunk using either an Oracle table or set the filepath to the folder where the .Rdata overlap files are  

###############################################
###### Set the variables below as needed ######
###############################################

# --------------------------------------  Comment out wind_area_name when runing create_reports() -------------------------------------- #

# wind_area_name = "OCS-A 0521 Remainder" # used to describe elements in dynamic text and pull wind area name from Oracle - comment out to run multiple reports from create_reports_for_all_areas.R script

# The overlap_data_path is where effert data (dataset with muliplier column) from the last step (the getCallAreaEffort function) is stored - this folder will be used to combine all .rdata files of area effort together - regex will find year range and area names

overlap_data_source = "folder"
# overlap_data_source = "oracle" 

oracle_overlap_table = "APSD.ALL_WEA_2008_2019@garfo_nefsc.world" #Oracle table to pull overlay files from

overlap_data_path = file.path(network_location, "home5", "dcorvi", "geret_data_request", "HerringFW7_output_CW") # the file path of the folder where the overlap files are

 
# shapefile_path = file.path(network_location,"home5/dcorvi/geret_data_request/HerringFW7")
shapefile_path = "" # file path where a shapefile is to use for the map on the report
shapefile_path = file.path(project_root_path,"input_data/Herring/Framework7")

specific_wind_area = FALSE # this is for querying a specific wind area from a folder of multiple wind areas (for automating multiple reports)

run_nybight_test = FALSE # Pull overlays from NY Bight package data to test formatting
# --------------------------------------------------------------------------------------------------------------------------------------- #


# Set Oracle login credentials
#oracle_username = "bgaluardi"
#oracle_password = "password"
#oracle_server = "fso"


# --------------------------------------------------------------------------------------------------------------------------------------- #
# Query lease table from Google Drive?
query_google_drive_lease_table = FALSE

Gsheet_BOEM_lease_area_table_id = "14MdREhJYjORPkb57n6NYEBSEVxeW3_Studsp0dB8KWc" # this is the id of the google sheet. Find the id of a Googe Sheet using googledrive::drive_find("BOEM Lease Area Table") %>% pull(id)



Project_Areas_12_3_2019_id = "17auz32s3BYk7K30gT45yUCTQ_hnp_s0i" # Google ID of zip of area shapefiles

if (query_google_drive_lease_table) {
  formatted_lease_area_table <- read_sheet(Gsheet_BOEM_lease_area_table_id, sheet = "WEA_State_proj_area") %>% drop_na(`proj_area_file_name`) # remove columns without an equivelent name to reduce data readout issues i.e. pulling Lease names with extra NA vectors
} else {
  formatted_lease_area_table <- offshoreWind::formatted_lease_area_table # or else use the static table in the package
}

# --------------------------------------------------------------------------------------------------------------------------------------- #
# Adding on extra years - for adding an overlay of a particular lease area for any new year(s) outside of 2008-2018 - will use regex to figure out years in folder 
append_year = FALSE
additonal_year_overlap_data_path = paste0(network_location, "home5/dcorvi/All_Lease_Areas_2019_output") # path to folder of overlays for this lease area with any extra years

# Find the file path to the data-raw folder in the package and return error if it cant find it
raw_data_path = file.path(offshoreWindpath,"data-raw")

area_adjective = "" # The adjective that can be assigned before the word 'area' in the dynamic text - default is blank (e.g. "..most revenue from the areas over the five year analysis.." )
# area_adjective = "call"

base_year = 2019 # base year for GDP deflator - Maximum = 2020, Minimum = 1947  - max(GDPDEF_quarterly$Year)
base_quarter = "" # base quarter for GDP deflator e.g. "Q1", "Q2" etc. Maximum = Q1 of 2020, Minimum = Q1 of 1947 - leave blank to query by year
# base_year <- readline(prompt=paste0("What is the base year for adjusting nominal values to real values? \n\n")) #  *** vignettes dont seem to have the ability to prompt the user

# vtr or dmis data source
noaa_data_source = "dmis" # dmis data with clam data join - from 04-06-2020 DMIS table
# noaa_data_source = "vtr" # VTR data used in Gerets original script
# noaa_data_source = "rec" # VTR recreational data

# querying from Oracle for VTR or DMIS data local variables
dmis_table = "APSD.dmis_sfclam_040620@GARFO_NEFSC.WORLD"
query_dmis_table = FALSE # query old or new dmis table from Oracle? True = yes, False = use flatfile in data/
query_rec_table = FALSE # query rec table from Oracle? True = yes, False = use flatfile in data/
query_permits = FALSE # query permit ids for vtr from Oracle? True = yes, False = use flatfile in data/
query_gearids = FALSE # query gearids for dmis from Oracle? True = yes, False = use flatfile in data/

top_fmp_section = TRUE
other_fmp_section = TRUE
top_species_section = TRUE
select_species_section = FALSE
select_gear_section = TRUE
fishery_dependence_section = TRUE

select_gear_custom =TRUE

trip_and_vessel_section = FALSE

single_area_summaries = FALSE # force summary tables even if theres only one area
number_of_top_species = 10 # number of top species for top species section

selectSpecies <- c("BUTTERFISH", "SUMMER FLOUNDER", "INSHORE LONGFIN SQUID", "AMERICAN LOBSTER", "ATLANTIC MACKEREL", "OCEAN QUAHOG", "SCUP", "BLACK SEA BASS", "ILLEX SQUID") # Species in select species section

# sort(unique(SPECIES$SPPNM)) # List of species names

##############################
#### Set Output Variables ####
##############################

save_files = "b" # either c("r","c","b","n") r = Save RData files, c = save csv files, b = save both, n = dont save any files

project_name = "TEST"  # description text that precedes the output file names

output_folder_name = file.path(project_root_path,"raw_data/Herring/Framework7")
# used for naming the folder where files will be saved

# Plot colors
assignedColors <- TRUE # assign unique colors for each margin in plots

paletteName1 <- "Accent" # which color palette to use for plots - check all available pallets with display.brewer.all()

paletteName2 <- "Set3" # which color palette to use for plots - check all available pallets with display.brewer.all()

paletteName3 <- "Paired" # which color palette to use for plots - check all available pallets with display.brewer.all()

# uncomment below to preview the different colors available for plots
# brewer.pal.info # get dataframe of pallettes info
# rownames(brewer.pal.info)
# display.brewer.all() # show list of all palettes
# display.brewer.all(colorblindFriendly = TRUE) # show list of all color blind freindly palettes
# paste0(rownames(brewer.pal.info), collapse ="\', \'") # get vector of all color palettes
# paletteNames <- c("Paired", "YlOrBr", "Set3", "Set2", "Set1") # must useful color palettes

##############################
#### Output Variables end ####
##############################

####################################
#### Change the variables above ####
####################################

################################################################################################################################################################
################################################################################################################################################################
# Processing inputs...
# No need to change anything else below

# oracle_server=params$oracle_server # for using with markdown function params
# oracle_username=params$oracle_username
# oracle_password=params$oracle_password

# CONN <- odbcConnect(dsn=params$oracle_server, uid=params$oracle_username, pwd=params$oracle_password, believeNRows=FALSE)

# Create Oracle connection if querying from Oracle database
if (overlap_data_source == "oracle" | query_dmis_table == TRUE | query_rec_table == TRUE | query_permits == TRUE | query_gearids == TRUE) {
  CONN <- odbcConnect(dsn=oracle_server, uid=oracle_username, pwd=oracle_password, believeNRows=FALSE)
}

# get environmental variable of the ~  - *not used
tilde_path = unname(unclass(Sys.getenv()["R_USER"]))

# get user name - *not used anymore
user_name = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub('\\.', ' ', unname(Sys.info()["user"]))), perl=TRUE)

# create not in function
"%notin%" = function(x,y) (x[!x%in%y])

# create output folder folder outside current environment to place csv and rdata outputs
message("creating output folder: offshorew_package_output ..")
dir.create(output_folder_name, showWarnings = FALSE) # set path to outside package if building vignette
output_f = output_folder_name

raw_data_path = file.path(offshoreWindpath,"data-raw")

# set maximum color number generated by palette name
maxUniqueColors <- brewer.pal.info[paletteName1, "maxcolors"]

# compile area data from output folder of previous step
# pull in data from previous step (step5 - parallel processing)

#--------------------------------------------------------------------------#
# Pull overlays from NY Bight package data to test formgatting
if (run_nybight_test == TRUE  ) {
  wind_area_name = "NY Bight"
  inside_areas_combined <- offshoreWind::NYBIGHT_inside_areas_c
  MGAREA <- unique(inside_areas_combined$Area)
  proj_area_name = "NY Bight"
} else {
#--------------------------------------------------------------------------#

#--------------------------------------------------------------------------#
# Pull overlay data from Oracle

# if (exists("oracle_overlap_table")) {
if (overlap_data_source == "oracle") {
  
  # CONN <- RODBC::odbcConnect(dsn=oracle_server, uid=oracle_username, pwd=oracle_password, believeNRows=FALSE)
  # sqlQuery(CONN, paste0("select distinct(AREA) FROM apsd.all_wea_2011_2018@garfo_nefsc.world;"))
  
  ptm.areaQuery = Sys.time()
  # inside_areas_combined <- sqlQuery(CONN, paste0("select * FROM apsd.all_wea_2011_2018@garfo_nefsc.world WHERE AREA = '", wind_area_name, 
  #                                                "' AND YEAR >= ",min_year," AND YEAR <= ", max_year,";"))
  
  wind_area_name_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("-","_", wind_area_name)), perl=TRUE)
  
  if (length(wind_area_name) > 1) { # pull multiple areas if wind_area_name contains more than 1 vector  
    sql_part_1 <- str_c("SELECT * FROM ", oracle_overlap_table, " WHERE AREA = '", wind_area_name[1])
    sql_part_2 <- str_c(" AND AREA = '", wind_area_name[-1], collapse="")
    query_string <- str_c(sql_part_1, sql_part_2, "';", collapse="")
    inside_areas_combined <- sqlQuery(CONN, query_string)
  } else {
      inside_areas_combined <- sqlQuery(CONN, str_c("select * FROM ", oracle_overlap_table, " WHERE AREA = '", wind_area_name,"';"))
    }
  
  message(paste0("Run time for areas query: ", as.double(round(difftime(Sys.time(), ptm.areaQuery, units='secs'), 2))%/%60," minute(s) ",as.double(round(difftime(Sys.time(), ptm.areaQuery, units='secs'), 2))%%60," second(s)"))
  
  inside_areas_combined <- inside_areas_combined %>%
    dplyr::select(c("IDNUM", "AREA", "YEAR", "INSIDE")) %>% 
    dplyr::rename("Area" = AREA, "Year" = YEAR, "Inside" = INSIDE) %>% 
    mutate("Area" = as.character(Area)) %>%
    mutate("Area" = gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", Area), perl=TRUE)) %>% 
    mutate("Area" = gsub("/","-", Area)) 
  
  if (append_year == TRUE) {
    
    if (any(list.files(additonal_year_overlap_data_path, pattern = paste0(wind_area_name_underscore, ".*\\.RData$")) %>% str_replace(paste0("(.+)_(","\\d{4})", "(.RData)"), "\\1") %in% wind_area_name_underscore) == FALSE) {
      stop("The ", wind_area_name, " wind area does not exist in extra years folder..")
    }
    
    all_years <- list.files(additonal_year_overlap_data_path, pattern = paste0(wind_area_name_underscore, ".*\\.RData$")) %>% str_replace(paste0("(.+)_(","\\d{4})", "(.RData)"), "\\2")
      for (extra_year in all_years) {
        load(paste0(additonal_year_overlap_data_path, "/", wind_area_name_underscore, "_", extra_year, ".RData", sep = '')) # load extra year as ACTIVITY
        YEAR.AREA <- subset(ACTIVITY, select=c(IDNUM,Area,Year,Inside)) %>% 
          mutate("Area" = gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", Area), perl=TRUE))
        YEAR.AREA <- YEAR.AREA[which(YEAR.AREA$Inside!=0),]
        YEAR.AREA$Inside <- as.numeric(as.character(YEAR.AREA$Inside))
        inside_areas_combined <- rbind(inside_areas_combined, YEAR.AREA)
        rm(ACTIVITY,YEAR.AREA) # garbage collection
      }
  }
  
  odbcClose(CONN)
  
  #### detect names of areas from combined areas file - double check
  MGAREA <- unique(inside_areas_combined$Area)
  
  #### Update wind area names
  # ----- I placed the line below in the load libraries chunk because it prompts the user to sign into Google in the middle of the chunk run -----#
  # formatted_lease_area_table <- read_sheet(Gsheet_BOEM_lease_area_table_id, sheet = "WEA_State_proj_area") %>% drop_na(`proj_area_file_name`) # remove columns without an equivelent name to reduce data readout issues i.e. pulling Lease names with extra NA vectors  
  
  if (wind_area_name %in% formatted_lease_area_table$proj_area_file_name) {
    proj_area_name <- wind_area_name
    # wind_area_name <- proj_area_file_name
    wind_area_name <- formatted_lease_area_table %>% 
      filter(proj_area_file_name==wind_area_name) %>% 
      pull(`Lease Name`) # get the reformatted wind area name using the mapped project area file name
    inside_areas_combined <- inside_areas_combined %>%
      mutate("Area" = gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", wind_area_name), perl=TRUE)) %>%
      mutate("Area" = gsub("/","-", Area))
    }
  #### end Update wind area names
  # inside_areas_combined <- inside_areas_combined %>% filter( Year < 2019 & Year >= 2014 ) # set for testing
  # sort(unique(inside_areas_combined$Year))
  # sort(unique(inside_areas_combined %>% filter( Year < 2019 & Year >= 2014 ) %>% select(Year)) %>% pull())

} # end conditional for checking for overlaps Oracle table
#--------------------------------------------------------------------------#


#--------------------------------------------------------------------------#
# Pull overlays from Folder
# if (exists("overlap_data_path")) {
if (overlap_data_source == "folder") {
  
###### get info to be able to loop over overlap file ######
# get areas from overlap_data_path 
MGAREA <- unique(gsub(pattern="(.+)_([0-9]{4})(.RData$)","\\1", ignore.case = TRUE , list.files(path=overlap_data_path, pattern = "(.+)(.RData$)", ignore.case =TRUE, recursive=F, full.names=F)))

years <- unique(gsub(pattern="(.+)_([0-9]{4})(.RData$)","\\2", ignore.case = TRUE , list.files(path=overlap_data_path, pattern = "(.+)(.RData$)", ignore.case =TRUE, recursive=F, full.names=F))) # get years from overlap_data_path

START.YEAR <- min(years)
END.YEAR <- max(years)
rm(years)

if (any(gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("_"," ", MGAREA), perl=TRUE) %in% formatted_lease_area_table$proj_area_file_name)) {
  
  if (specific_wind_area) {
  MGAREA <- MGAREA[MGAREA %in% gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("-","_", wind_area_name)), perl=TRUE)]
  years <- unique(gsub(pattern="(.+)_([0-9]{4})(.RData$)","\\2", ignore.case = TRUE, list.files(path=overlap_data_path, pattern = paste0(MGAREA, "_([0-9]{4})(.RData$)"), ignore.case =TRUE, recursive=F, full.names=F))) # get years from overlap_data_path
  START.YEAR <- min(years)
  END.YEAR <- max(years)
  rm(years)
}
  
  proj_area_name = gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("_"," ", gsub("OCS_A","OCS-A", MGAREA)), perl=TRUE)
  
  wind_area_name <- formatted_lease_area_table %>% # set wind area name as proper lease name
  filter(proj_area_file_name==proj_area_name) %>% 
  pull(`Lease Name`)
  
} else {
  proj_area_name <- wind_area_hard_name 
  wind_area_name <- wind_area_hard_name
}

# MGAREA <- gsub(pattern=".shp$","", ignore.case = TRUE ,
#      list.files(path=shapefile_f,ignore.case =TRUE, pattern="shp$", recursive=F, full.names=F))
# need to move this to getCallAreaEffort function
# MGAREA <- gsub(pattern=" ","_", gsub(pattern="-","_", MGAREA))

# get static file all inside trip area data that was created in overlap file 
test=1
for (YEAR in START.YEAR:END.YEAR) {
  for (AREA in MGAREA){
    load(paste0(overlap_data_path, "/",AREA,"_",YEAR,".RData", sep = ''))
    if (test == 1) {
      inside_areas_combined <- subset(ACTIVITY, select=c(IDNUM,Area,Year,Inside))
      inside_areas_combined$Inside <- as.numeric(as.character(inside_areas_combined$Inside))
      inside_areas_combined <- inside_areas_combined[which(inside_areas_combined$Inside!=0),]
      inside_areas_combined$Inside <- as.numeric(as.character(inside_areas_combined$Inside))
      rm(ACTIVITY) # garbage collection
      test = 2
    }
    else {
      YEAR.AREA <- subset(ACTIVITY, select=c(IDNUM,Area,Year,Inside))
      YEAR.AREA <- YEAR.AREA[which(YEAR.AREA$Inside!=0),]
      YEAR.AREA$Inside <- as.numeric(as.character(YEAR.AREA$Inside))
      inside_areas_combined <- rbind(inside_areas_combined, YEAR.AREA)
      rm(ACTIVITY,YEAR.AREA) # garbage collection
    }
  }
} # end for loop for getting overlap data from folder
  #### Update wind area names
  if (specific_wind_area) {
inside_areas_combined <- inside_areas_combined %>%
      mutate("Area" = gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", wind_area_name), perl=TRUE)) %>%
      mutate("Area" = gsub("/","-", Area))
} else {
    inside_areas_combined <- inside_areas_combined %>%
       # make spaces underscores and
      # mutate("Area" = gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", Area)), perl=TRUE))
      mutate("Area" = gsub("/","-", gsub(" ","_", gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("_"," ", Area), perl=TRUE))))
}
} # end conditional for checking for overlaps folder
} # end conditional for testing for running NY Bight test run 
#--------------------------------------------------------------------------#

#### detect Start and end years from combined areas file
START.YEAR = as.integer(min(inside_areas_combined$Year))
END.YEAR = as.integer(max(inside_areas_combined$Year))

numyear <- offshoreWind::proper(offshoreWind::numbers2words(as.integer(length(START.YEAR:END.YEAR))))

# set global variables to lowercase for better compatibility
noaa_data_source <- tolower(noaa_data_source)
save_files = tolower(save_files)

message(ifelse(save_files == "b", "Saving .csv and .rdata files..", ifelse(save_files == "c", "Saving .csv files..", 
       ifelse(save_files == "r", "Saving .rdata files..", ifelse(save_files == "n", "Not saving any table files..","No save method specified")))))

message("Creating PDF using demonstration data of ", paste0(MGAREA, collapse = ", ")," areas..", appendLF = TRUE)
message("Using ", toupper(noaa_data_source), " data..", appendLF = TRUE)

deflate_by <- if_else(base_quarter == "" , "year", "quarter") # set whether to deflate revenue by quarter or year - default is quarter - this is done in the adjust_nominal_values_to_real_values code chunk

# Add space after area adjective if it is used and if there isnt a space in there already
area_adjective <- ifelse(area_adjective!= "" && str_sub(area_adjective,-1,-1) != " " , paste0(area_adjective," "), area_adjective)

# check what article the adjective needs - "an" if no adjective or if the adjective begin with an 'a' 
a_or_an <- ifelse(area_adjective == "" || tolower(substr(area_adjective, start = 1, stop = 1)) == "a", " an ", " a ")

# Mistype Error Checking:
if ((base_year %in% 1947:2020 == FALSE)) {stop("Base year not between 2020 and 1947 or not given..")}
if ((base_quarter %in%  c("Q1", "Q2", "Q3", "Q4", "") == FALSE)) {stop("Base Quarter not written as Q1, Q2, Q3, Q4..")}
if (deflate_by == "year") {message("Deflating by ", base_year, " dollars..")}
if (deflate_by == "quarter") {message("Deflating by ", base_year, ", ", base_quarter, " dollars..")}

# Setup more helpful error messages
if (rlang::is_empty(MGAREA)) {stop("Didn't, detect any areas. Check that the overlay data is in the ",overlap_data_path," folder.")}

# more helpul connection errors
if (overlap_data_source == "oracle" | query_dmis_table == TRUE | query_rec_table == TRUE | query_permits == TRUE | query_gearids == TRUE) {
  if (CONN==-1) {stop("Not connected to VPN") # conn equals -1 if not connected to vpn
  }
}
if (overlap_data_source == "folder") {
  if (!dir.exists(additonal_year_overlap_data_path) | !dir.exists(overlap_data_path)) {
  stop("Not connected to shared drive or overlap_data_path or additonal_year_overlap_data_path folder doesn't exist") # checks that the overlap path exists to see if the user has entered the password for the shared drive
  }
}

rounded_message <- "All numbers have been rounded to the nearest thousand."

number_of_areas <- length(MGAREA)
# set code chunks to evaluate
eval_create_connection = query_dmis_table | query_permits | query_gearids 
eval_query_DMIS_or_REC = query_dmis_table | query_rec_table 
eval_query_gearids_permits = query_gearids | query_permits 

summary_tables = number_of_areas > 1 # create summary tables if more than 1 area - can change to false to force summaries of single areas

summary_tables <- if_else(single_area_summaries, TRUE, summary_tables) # create summary tables if forced

top_fmp_section_summary = top_fmp_section & summary_tables
other_fmp_section_summary = other_fmp_section & summary_tables
top_species_section_summary = top_species_section & summary_tables
select_species_section_summary = select_species_section & summary_tables
select_gear_section_summary = select_gear_section & summary_tables



# Setup section numbers
section_num = 0

message("Running lease area(s): ", paste0(wind_area_name, collapse = ", "), ", Project Area(s): ", paste0(proj_area_name, collapse = ", ")," ..")

ptm.SCRIPT = Sys.time() #bench marking

# inside_areas_combined_empire_wind_oracle <- inside_areas_combined
# inside_areas_combined_empire_wind_folder <- inside_areas_combined
# offshoreWind::formatted_lease_area_table$proj_area_file_name

# MGAREA


```


```{r create_connection_if_querying, eval = eval_create_connection}  
# this should stop errors from occuring in the case that Oracle credentials are not changed from defaults 
    if (.Platform$OS.type == "windows") { # if os is windows use RODBC
  
  CONN <- RODBC::odbcConnect(dsn=oracle_server, uid=oracle_username, pwd=oracle_password, believeNRows=FALSE)
# CONN <- odbcConnect(dsn= "sole", uid=rstudioapi::askForPassword("Oracle user"),
#                               pwd=rstudioapi::askForPassword("Oracle password"), believeNRows=FALSE) # use r studio api to askf for creds
    }
  
  if (.Platform$OS.type == "unix") { # if os is Linux (i.e. on Venus) use ROracle.  This is set up in the R_credentials.R file.
        CONN <- sole_conn
  }
# Note: In order for ROracle to work the user may need to create a file named ".Renviron" and place into top directory of personal shared drive with the following sequential lines:
# ORACLE_HOME=/ora1/app/oracle/product/11.2.0/dbhome_1
# export ORACLE_HOME


```

```{r query_DMIS_or_REC_if_requested, eval = eval_query_DMIS_or_REC} 
########################################
##### Query DMIS table from Oracle #####
########################################
### load dmis manually from Oracle instead of from flat file to ensure data is up-to-date - may take up to 17 hours on the VPN 

if (noaa_data_source == "dmis") {
  message("Querying DMIS data from Oracle..")
  ptm.DMISQuery = Sys.time()
  APSD_DMIS_2 <- sqlQuery(CONN, paste0("SELECT * FROM ", dmis_table, " WHERE Year >= ",
                                                  START.YEAR, " AND Year <= ", END.YEAR))
  message(paste0("Run time for DMIS query: ", as.double(round(difftime(Sys.time(), ptm.DMISQuery, units='secs'), 2))%/%60," minute(s) ",as.double(round(difftime(Sys.time(), ptm.DMISQuery, units='secs'), 2))%%60," second(s)"))

}

########################################
##### Query REC table from Oracle #####
########################################
### load rec manually from Oracle instead of from flat file to ensure data is up-to-date - may take a long time on the VPN 
if (noaa_data_source == "rec") {
  ptm.RECQ = Sys.time()
  # get vtr data for recreational
for(i in START.YEAR:END.YEAR) {
  print(i)
  CURRENT.QUERY = paste("SELECT VTR.veslog",i,"s.TRIPID,
        				VTR.veslog",i,"t.DATESAIL,
                (to_date(VTR.veslog",i,"t.DATELND1)-to_date(VTR.veslog",i,"t.DATESAIL))+1 as DAS,
        				VTR.veslog",i,"t.TRIPCATG,
        				VTR.veslog",i,"t.PORTLND1,
        				VTR.veslog",i,"t.STATE1,
        				VTR.VLPORTSYN.PORT,
        				VTR.veslog",i,"t.HULLNUM as VESID,
        				VTR.veslog",i,"g.GEARCODE,
        				VTR.vlgear.GEARNM,
        				VTR.veslog",i,"s.QTYKEPT,
                VTR.veslog",i,"s.QTYDISC,
        				VTR.VLSPPSYN.SPPCONV,
                VTR.veslog",i,"s.SPPCODE,
        				VTR.VLSPPSYN.NESPP3,
        				VTR.veslog",i,"g.FZONE,
                VTR.veslog",i,"g.CAREA as AREA,
        				VTR.veslog",i,"g.CLATDEG,
        				VTR.veslog",i,"g.CLATMIN,
        				VTR.veslog",i,"g.CLATSEC,
        				VTR.veslog",i,"g.CLONDEG,
        				VTR.veslog",i,"g.CLONMIN,
        				VTR.veslog",i,"g.CLONSEC,
        				VTR.veslog",i,"g.SERIAL_NUM,
                VTR.veslog",i,"g.GEARID
        				FROM VTR.veslog",i,"s
        				LEFT JOIN VTR.veslog",i,"g ON VTR.veslog",i,"s.GEARID = VTR.veslog",i,"g.GEARID
        				LEFT JOIN VTR.veslog",i,"t ON VTR.veslog",i,"s.TRIPID = VTR.veslog",i,"t.TRIPID
        				LEFT JOIN VTR.vlgear ON VTR.veslog",i,"g.GEARCODE = VTR.vlgear.GEARCODE
        				LEFT JOIN VTR.VLSPPSYN ON VTR.veslog",i,"s.SPPCODE = VTR.VLSPPSYN.SPPSYN
        				LEFT JOIN VTR.VLPORTSYN ON VTR.veslog",i,"t.PORTLND1 = VTR.VLPORTSYN.PORTSYN AND VTR.veslog",i,"t.STATE1 = VTR.VLPORTSYN.STATEABB
                WHERE VTR.veslog",i,"t.TRIPCATG in(2,3)
        				ORDER BY VTR.veslog",i,"t.DATESAIL",sep="")
  YEAR.RESULT = sqlQuery(CONN, CURRENT.QUERY)  ### seems to be a problem with having a "paste" on both sides...

  # Now, the loop compiles the results; the first year must be treated slightly differently###
  if (i==START.YEAR) {
    RESULT.COMPILED = YEAR.RESULT
  } else {
    RESULT.COMPILED = rbind(RESULT.COMPILED, YEAR.RESULT) }
}    # End Main Loop

VTR_REC <- as_tibble(RESULT.COMPILED) # dplyr::rename data to be more explicit

VTR_REC <- VTR_REC %>% # fix data
  dplyr::rename("IDNUM" = GEARID) %>%
  mutate(YEAR = as.integer(format(DATESAIL,"%Y"))) %>% # create column for year
  mutate(MONTH = as.integer(format(DATESAIL,"%m"))) %>% # create column for month
  mutate("LAT" = angle2dec(paste0(VTR_REC$CLATDEG, " ", VTR_REC$CLATMIN, " ", VTR_REC$CLATSEC))) %>%
  mutate("LON" = angle2dec(paste0(VTR_REC$CLONDEG, " ", VTR_REC$CLONMIN, " ", VTR_REC$CLONSEC))) %>%
  mutate("PORTLANDED" = paste0(PORTLND1,", ",STATE1)) %>%
  mutate("NESPP3" = as.integer(NESPP3)) %>%
  mutate("LIVE" = QTYKEPT * SPPCONV) %>%
  left_join(x = ., y = SPECIES, by = "NESPP3") %>% # join species names by NESPP3 from previously created csv file saved as flat file in data/
  mutate("FMP" = Formatted_2) %>% # fix formatting for FMPs
  dplyr::select(-Formatted_2) %>%
  mutate("FMP" = if_else(FMP=="","None", FMP))
  
  message(paste0("Run time for recreation data query and clean: ", as.double(round(difftime(Sys.time(), ptm.RECQ, units='secs'), 2))%/%60," minute(s) ",as.double(round(difftime(Sys.time(), ptm.RECQ, units='secs'), 2))%%60," second(s)"))
}


```

```{r query_gearids_permits_if_requested, eval = eval_query_gearids_permits}  
 
  # ##### option 2 - Query from database 
  # CONN = odbcConnect(dsn="sole",uid="dcorvi",pwd="pw",believeNRows=FALSE)
  # query missing data from Oracle (should take about 2.5 minutes on VPN) and will join in next code block  
  ptm.TOTAL = Sys.time()
  E_Y <- END.YEAR+1
  for(i in START.YEAR:E_Y) {
    ptm.TOT = Sys.time()
    print(i)
    if (noaa_data_source == "vtr") { # get permit variable from Oracle
    CURRENT.QUERY = paste("SELECT unique PERMIT,
                          TRIPID FROM VTR.veslog",i,"t ;"
                          , sep="") } 
    else if (noaa_data_source == "dmis") { # get gearid variable from Oracle
    CURRENT.QUERY = paste("SELECT SERIAL_NUM, GEARID,
                          TRIPID FROM VTR.veslog",i,"g ;" # GEARID is equilivent to IMGID - from data dictionary: GEARID:VESLOG Gear record identifier; Primary key for VESLOGyyyyG. Equivalent to IMGID in VTR IMAGES table
                          , sep="") # stringsAsFactors = FALSE
    }
    # TODO: change RESULT.COMPILED object name bc it is masked by native rstudio methods
    YEAR.RESULT = sqlQuery(CONN, CURRENT.QUERY, stringsAsFactors=FALSE)  ### seems to be a problem with having a "paste" on both sides...
    YEAR.RESULT$YEAR_L <- i
    # Now, the loop compiles the results; the first year must be treated slightly differently###
    if (i==START.YEAR) {
      QUERY_RESULT = YEAR.RESULT
    } else {
      QUERY_RESULT = rbind(QUERY_RESULT,YEAR.RESULT) }
    # Print the results summary:
    print(paste("For year ",i,", ",(NROW(YEAR.RESULT))," records were added.",sep=""))
    print(paste0("After adding year ",i,", total records imported = ", NROW(QUERY_RESULT),"."))
    print(paste0("Run time ",round(difftime(Sys.time(), ptm.TOT, units='secs'), 2), " seconds for ",i))
  }    # End Main Loop
  QUERY_RESULT <- QUERY_RESULT %>% dplyr::rename("IDNUM" = GEARID, "TRIPID_check" = TRIPID) %>% mutate(SERIAL_NUM = as.character(SERIAL_NUM))
  QUERY_RESULT$YEAR_L <- NULL # remove year variable
  print(paste0("Run time ", round(difftime(Sys.time(), ptm.TOTAL, units='secs'), 2), " seconds for ",START.YEAR," to ",E_Y))

  odbcClose(CONN) # garbage collection

```


```{r load_VTR_REC_or_DMIS_flat_files_and_clean, eval = T}  
# run this code chunk to query from Oracle or use in-package data - querying from Oracle takes longer but ensures that everything is up-to-date    
# also renames and cleans DMIS variables and data   
 
#### load data for VTR and filter by years
if (noaa_data_source == "vtr") { 
  message("Loading flat VTR file from package..")
  VTR_FIN <- offshoreWind::VTR_FIN # not needed but keeps code explicit 
  message("VTR observations for all years: ", format(NROW(VTR_FIN), big.mark=",", scientific=FALSE))
  VTR_FIN <- VTR_FIN[ which(VTR_FIN$YEAR >= START.YEAR & VTR_FIN$YEAR <= END.YEAR),] # subset by selected years
  message(START.YEAR, " to ", END.YEAR, " VTR observations: ", format(NROW(VTR_FIN),big.mark=",",scientific=FALSE))
}

if (noaa_data_source == "rec") {
  message("Loading flat VTR recreation file from package..")
  VTR_REC <- offshoreWind::VTR_REC # not needed but keeps code explicit 
  message("VTR observations for all years: ", format(NROW(VTR_REC), big.mark=",", scientific=FALSE))
  VTR_REC <- VTR_REC[ which(VTR_REC$YEAR >= START.YEAR & VTR_REC$YEAR <= END.YEAR),] # subset by selected years
  message(START.YEAR, " to ", END.YEAR, " VTR observations: ", format(NROW(VTR_REC),big.mark=",",scientific=FALSE))
}

##### load data for DMIS filter by years

if (noaa_data_source == "dmis" && query_dmis_table == FALSE) {
  message("Loading flat DMIS file from package..")
  APSD_DMIS <- as_tibble(offshoreWind::APSD_DMIS_2) # load from data/ folder
  message("DMIS observations for all years: ", format(NROW(APSD_DMIS), big.mark=",", scientific=FALSE))
  APSD_DMIS <- APSD_DMIS[ which(APSD_DMIS$YEAR >= START.YEAR & APSD_DMIS$YEAR <= END.YEAR),] # subset by selected years
  message(START.YEAR, " to ", END.YEAR, " DMIS observations: ", format(NROW(APSD_DMIS),big.mark=",",scientific=FALSE))
}

#### change dmis variables to vtr variables and join tables with need variables ####
# save(APSD_DMIS, file="APSD_DMIS.rData")

# write.csv(APSD_DMIS, file="APSD_DMIS.csv")

# offshoreWind::VTR_FIN


# VTR_FIN <- offshoreWind::VTR_FIN %>% # fix data
#   # dplyr::rename("IDNUM" = GEARID) %>%
#   mutate(FY = as.integer(format(DATESAIL,"%Y"))) %>% # create column for year
#   mutate(MONTH = as.integer(format(DATESAIL,"%m"))) %>% # create column for month
#   mutate("PORTLANDED" = paste0(PORTLND1,", ",STATE1)) %>%
#   mutate("NESPP3" = as.integer(NESPP3)) %>%
#   mutate("LIVE" = QTYKEPT * SPPCONV) %>%
#   left_join(x = ., y = SPECIES, by = "NESPP3") %>% # join species names by NESPP3 from previously created csv file saved as flat file in data/
#   mutate("FMP" = Formatted_2) %>% # fix formatting for FMPs
#   dplyr::select(-Formatted_2) %>%
#   mutate("FMP" = if_else(FMP=="","None", FMP))


# remap dmis variables to vtr variables when dmis data source is requested
# TODO: find-replace vtr variables to dmis variables when code is 100% functional
# DMIS missong HULLNUM variable? HULLNUM as VESID
# add gearids from VESLOGyyyyG Oracle table by SERIAL_NUM in next code chunk
# sum(is.na(APSD_DMIS$DAS)) # count NA's

# APSD_DMIS_2 <- offshoreWind::APSD_DMIS_2 # reset data
# as_tibble(APSD_DMIS)
# as_tibble(APSD_DMIS_2)
#### DMIS dataste 2

# as_tibble(APSD_DMIS)

# SPECIES <- offshoreWind::SPECIES[,1:3] #change back to original FMPs without formatting

# SPECIES <- offshoreWind::SPECIES %>% mutate(Formatted_2 = ifelse(NESPP3==710, "No Federal FMP", Formatted_2))

# Note: cannot determine days at sea with dmis/clam data
if (noaa_data_source == "dmis") { #new dmis table with imgids 
  ptm.DMIS = Sys.time()
APSD_DMIS <- as_tibble(
  APSD_DMIS %>% 
    # mutate(SECGEARFISH = if_else(NESPP3=="754","754", SECGEARFISH)) %>% # fix data cleaning isssue with NESPP3 code in clam data 
    # mutate(SECGEARFISH = if_else(NESPP3=="769","769", SECGEARFISH)) %>% 
    # mutate(SPPNAME = if_else(SPPNAME=="QUAHOGS/BUSHEL","DRC", SPPNAME)) %>% # fix data cleaning isssue with Gearcode in clam data
    # mutate(SPPNAME = if_else(SPPNAME=="CLAM, SURF/BUSHEL","DRC", SPPNAME)) %>% 
    # dplyr::select(-c("GEARCODE", "NESPP3")) %>% # remove columns with wrong names
    dplyr::select(-c("GEARCODE")) %>% # remove columns with wrong names
    # dplyr::rename("IDNUM"=IMGID, "PORTLND1"=VTR_PORT, "STATE1"=VTR_STATE, "DATESAIL"=DATE_TRIP, "NESPP3"=SECGEARFISH,
    #        "GEARCODE"=SPPNAME, "REVENUE"=DOLLAR, "QTYKEPT"=LANDED, "LAT"=DDLAT, "LON"=DDLON) %>%
    # dplyr::rename("IDNUM"=IMGID, "PORTLND1"=VTR_PORT, "STATE1"=VTR_STATE, "DATESAIL"=DATE_TRIP, "GEARCODE"=SECGEARFISH,
    #        "SPPNM"=SPPNAME, "REVENUE"=DOLLAR, "LIVE"=POUNDS, "QTYKEPT"=LANDED, "LAT"=DDLAT, "LON"=DDLON) %>% 
    # dplyr::rename("IDNUM"=IMGID, "PORTLND1"=VTR_PORT, "STATE1"=VTR_STATE, "DATESAIL"=DATE_TRIP, "GEARCODE"=SECGEARFISH,
    #        "SPPNM"=SPPNAME, "REVENUE"=DOLLAR, "LIVE"=POUNDS, "QTYKEPT"=LANDED, "LAT"=DDLAT, "LON"=DDLON, "DAS"=TRIP_LENGTH) %>% 
    dplyr::rename("IDNUM"=IMGID, "PORTLND1"=VTR_PORT, "STATE1"=VTR_STATE, "DATESAIL"=DATE_TRIP, "GEARCODE"=SECGEARFISH, 
           "REVENUE"=DOLLAR, "LIVE"=POUNDS, "QTYKEPT"=LANDED, "LAT"=DDLAT, "LON"=DDLON, "DAS"=TRIP_LENGTH) %>% 
    mutate("MONTH" = as.integer(format(DATESAIL,"%m"))) %>% # create column for month 
    mutate("PORTLANDED" = paste0(PORTLND1,", ",STATE1)) %>% 
    mutate("NESPP3" = as.integer(NESPP3)) %>% 
    left_join(x = ., y = SPECIES, by = "NESPP3") %>% # join species names by NESPP3 from previously created csv file saved as flat file in data/ 
    mutate("FMP" = Formatted_2) %>% # fix formatting for FMPs 
    dplyr::select(-Formatted_2) %>% 
    mutate("FMP" = if_else(FMP=="","None", FMP)) %>% #rename blank FMPs 
    # dplyr::rename("SPPNM"=SPPNM.y, "SPPNM_s"=SPPNM.x) %>%
    # mutate("FMP" = if_else(is.na(FMP),"Missing Species Code Mapping", FMP)) %>% # fix missing data for species codes, FMPs and code to species mapping
    mutate("FMP" = if_else(is.na(FMP),"All Others", FMP)) %>% # fix missing data for species codes, FMPs and code to species mapping
    # mutate("SPPNAME" = if_else(is.na(SPPNAME) & is.na(NESPP3), "Missing Species Code", SPPNAME)) %>% 
    # mutate("SPPNAME" = if_else(is.na(SPPNAME), "Species Name Is Null", SPPNAME)) %>% 
    mutate("SPPNM" = if_else(is.na(SPPNM) & is.na(NESPP3), "UNKNOWN", SPPNM)) %>%
    left_join(x = ., y = subset(offshoreWind::VLGEARTABLE, select=c(GEARCODE, GEARNM)), by = "GEARCODE") #add gearnames from VLGEAR table (saved as flat file from Oracle)
  ) 
  message(paste0("Run time for variable replacement and joins in DMIS table: ", as.double(round(difftime(Sys.time(), ptm.DMIS, units='secs'), 2))%/%60," minute(s) ",as.double(round(difftime(Sys.time(), ptm.DMIS, units='secs'), 2))%%60," second(s)"))
}

# sort(unique(APSD_DMIS %>% filter(is.na(FMP)) %>% pull(NESPP3))) %notin% SPECIES$NESPP3
  

# sapply(APSD_DMIS_2, function(x) sum(is.na(x))) # check NAs
# sapply(APSD_DMIS, function(x) comma_format()(sum(is.na(x)))) # check NAs
# 
# comma_format()(nrow(APSD_DMIS_2))
# comma_format()(nrow(APSD_DMIS))
# colnames(APSD_DMIS_2)

# rm(APSD_DMIS)
# library(readr)
# write_csv(tibble::enframe((unique(APSD_DMIS_2$SPPNAME)),name = NULL), "speciescheck.csv")

#### Get finished flat files of gears and species joined VTR REC or DMIS data ####
if (noaa_data_source == "vtr") {
  FIN <- VTR_FIN
} else if (noaa_data_source == "rec" ) {
  FIN <- VTR_REC
} else if (noaa_data_source == "dmis" ) {
  FIN <- APSD_DMIS
} else {
  stop("please enter data source..")
}

#### save raw data of years requested
# if (save_files == "r" | save_files == "b" ) {
#   message("saving raw data..")
#   save(FIN, file=file.path(output_f, paste(project_name, "_RAW.Rdata",sep="")))
# }

#### if not querying from Oracle, get flat files and filter by the years requested 
if (query_gearids == FALSE | query_permits == FALSE) {
  if (noaa_data_source == "vtr" || noaa_data_source == "rec" ) {
    QUERY_RESULT <- offshoreWind::PERMIT_QUERY
  } else if (noaa_data_source == "dmis") {
    QUERY_RESULT <- offshoreWind::GEARID_QUERY
    # QUERY_RESULT <- QUERY_RESULT %>% rename("IDNUM" = GEARID, "TRIPID_check" = TRIPID) %>% mutate(SERIAL_NUM = as.character(SERIAL_NUM)) 
    QUERY_RESULT <- QUERY_RESULT %>% dplyr::rename("IDNUM" = GEARID) %>% mutate(SERIAL_NUM = as.character(SERIAL_NUM)) 
    QUERY_RESULT <- QUERY_RESULT[ which(QUERY_RESULT$YEAR_L >= START.YEAR & QUERY_RESULT$YEAR_L <= END.YEAR+1),]
  }
}

# unique(select_gear_codes  %>% filter(gearcat_new=="[blank]") %>% select(GEARCODE))

FIN_backup <- FIN


```

```{r process_permit_data, eval = T} 
# FIN <- FIN_backup # for resets

QUERY_RESULT$YEAR_L <- NULL # remove year variable

FIN$GEARCAT <- ""
FIN$GEARCAT[FIN$GEARNM=="POT, LOBSTER"] <- "Lobster Pot"
FIN$GEARCAT[FIN$GEARNM %in% c("OTTER TRAWL, BOTTOM,FISH","OTTER TRAWL, BEAM","OTTER TRAWL, BOTTOM,OTHER", "OTTER TRAWL,BOTTOM,TWIN",
                                  "SEINE, DANISH","SEINE, SCOTTISH","PAIR TRAWL, BOTTOM") ] <- "Bottom Trawl"
FIN$GEARCAT[FIN$GEARNM=="GILL NET, SINK"] <- "Sink Gillnet"
FIN$GEARCAT[FIN$GEARNM %in% c("DREDGE, SCALLOP,SEA","DREDGE, SCALLOP-CHAIN MAT","DREDGE,SCALLOP,TURTLE DEFLECT",
                                  "DREDGE, SCALLOP,CHAIN MAT,MOD","OTTER TRAWL, BOTTOM,SCALLOP")] <- "Scallop Gear"
FIN$GEARCAT[FIN$GEARNM=="DREDGE, OCEAN QUAHOG/SURF CLAM"] <- "Clam Dredge"
FIN$GEARCAT[FIN$GEARNM=="OTTER TRAWL, BOTTOM,SHRIMP"] <- "Shrimp Trawl"
FIN$GEARCAT[FIN$GEARNM %in% c("DREDGE, URCHIN","DREDGE, OTHER")] <- "Other Dredge"
FIN$GEARCAT[FIN$GEARNM %in% c("DREDGE, MUSSEL")] <- "Mussel Dredge"
FIN$GEARCAT[FIN$GEARNM %in% c("HAND LINE/ROD & REEL","HARPOON")] <- "Hand Gear"
FIN$GEARCAT[FIN$GEARNM=="LONGLINE, BOTTOM"] <- "Bottom Longline"
FIN$GEARCAT[FIN$GEARNM %in% c("POT, HAG","POT, CRAB","POT, FISH", "POT, CONCH/WHELK", "POT, SHRIMP","POT, OTHER",
                                  "TRAP","POT, EEL","POTS, MIXED")] <- "Other Pot"
FIN$GEARCAT[FIN$GEARNM %in% c("OTTER TRAWL, MIDWATER","PAIR TRAWL, MIDWATER")] <- "Midwater Trawl"
FIN$GEARCAT[FIN$GEARNM %in% c("OTTER TRAWL, HADDOCK SEPARATOR","OTTER TRAWL, RUHLE")] <- "Separator & Ruhle Trawl"
FIN$GEARCAT[FIN$GEARNM %in% c("GILL NET, DRIFT,LARGE MESH","GILL NET, DRIFT,SMALL MESH")] <- "Drift Gillnet"
FIN$GEARCAT[FIN$GEARNM %in% c("FYKE NET","OTHER GEAR", "HAND RAKE", "DIVING GEAR","SEINE, STOP","WEIR","CARRIER VESSEL",
                                  "MIXED GEAR","CASTNET","SEINE,HAUL")] <- "Other Gear"
FIN$GEARCAT[FIN$GEARNM=="LONGLINE, PELAGIC"] <- "Pelagic Longline"
FIN$GEARCAT[FIN$GEARNM=="SEINE, PURSE"] <- "Purse Seine"
FIN$GEARCAT[FIN$GEARNM %in% c("GILL NET, OTHER","GILL NET, RUNAROUND")] <- "Other Gillnet"
FIN$GEARCAT[FIN$GEARCAT==""] <- "Other Gear"
FIN$GEARCAT[which(is.na(FIN$GEARCAT))] <- "Other Gear"

if (noaa_data_source == "vtr"|| noaa_data_source == "rec") {
QUERY_RESULT <- unique(QUERY_RESULT)
TEST_1 <- NROW(FIN)
message("Merging data from step 2 with permit data by TRIPID..")
ptm.TOTAL = Sys.time()
#### merge PERMIT using TRIPID if vtr or rec
FIN <- merge(FIN, QUERY_RESULT, by='TRIPID', all.x = TRUE, all.y = FALSE)
if (NROW(FIN) != TEST_1) stop("Merging Permits increased number of rows, which shouldn't happen")
message(paste0("Run time ", round(difftime(Sys.time(), ptm.TOTAL, units='secs'), 2), " seconds for merge"))
}

if (noaa_data_source == "vtr") {
FIN <- subset(FIN, select=c('PORTLANDED','YEAR','VESID','NESPP3','MONTH','GEARCODE','GEARCAT','SERIAL_NUM','IDNUM','LIVE',
                            'QTYKEPT','QTYDISC','DAS','SPPNM','REVENUE','FMP','LEN','FY','TRIPID','PERMIT','LAT','LON',"STATE1"))
} 

if (noaa_data_source == "rec") {
FIN <- subset(FIN, select=c('TRIPID', 'IDNUM', 'YEAR', 'MONTH', 'DAS', 'SPPNM', 'FMP', 'NANGLERS', 'LIVE', 'QTYKEPT','QTYDISC', 'PORTLANDED',
                            'NESPP3', 'GEARCODE', 'GEARCAT', 'PERMIT', 'VESID', 'SERIAL_NUM', "STATE1", "DATESAIL", 'LAT','LON'))
} 


if (noaa_data_source == "dmis") {
  message("Merging Vessel Log Gear Data by TRIPID..")
  # FIN <- merge(FIN, QUERY_RESULT, by='SERIAL_NUM', all.x = TRUE, all.y = TRUE)
  QUERY_RESULT <- unique(as_tibble(QUERY_RESULT))
  TEST_1 <- NROW(FIN)
  # QUERY_RESULT <- unique(as_tibble(QUERY_RESULT %>% dplyr::rename(TRIPID = TRIPID_check)))
  #### merge GEARID on TRIPID if DMIS
  FIN <- as_tibble(merge(FIN, QUERY_RESULT, by='IDNUM', all.x = TRUE, all.y = FALSE, suffixes = c("",".y")))
  if (NROW(FIN) != TEST_1) stop("Merging Permits increased number of rows, which shouldn't happen")
  # message("Merging gearids based on SERIAL_NUM and matching ", comma_format()(length(intersect::base(FIN$TRIPID, FIN$TRIPID_check)))," TRIPID's")
  # dim(FIN)
  FIN <- subset(FIN, select=c('PORTLANDED', 'PORTLND1', 'YEAR', 'MONTH', 'DATESAIL', 'GEARCODE', 'GEARCAT', 'NESPP3', 'SPPNM', 'QTYKEPT', 'LIVE',
                              'REVENUE', 'FMP', 'IDNUM', 'SERIAL_NUM', "DOCID", 'TRIPID', 'PERMIT', "STATE1", "SOURCE", "DEALNUM", "DAS",'LAT','LON')) # *added STATE1 variable
}

# comma_format()(nrow(FIN))
# save(FIN, file="DMIS2_SERIAL_NUM.Rdata")
# add revenue data using for-hire fees Linear Transformation by multiplying anglers by Average For-Hire Fee
# for_hire_fees <- for_hire_fees %>% mutate(YEAR = as.integer(YEAR))

if (noaa_data_source == "rec") { #create revenue for rec
  # read in for hire data through original excel file instead?
  # for_hire_fees <- as_tibble(read.csv("./data-raw/For-Hire_Fee.csv", as.is = TRUE))
  
  for_hire_fees <- offshoreWind::for_hire_fees %>%  # get clean and ready for join
    dplyr::rename("YEAR" = Year) %>% 
    mutate(YEAR = as.character(YEAR))
  
  FIN <- FIN %>% mutate(YEAR = as.integer(YEAR))
  for_hire_fees <- for_hire_fees %>% mutate(YEAR = as.integer(YEAR))
  # FIN <- FIN %>% dplyr::mutate(STATE1 = replace_na(STATE1, ""))
  # FIN %>% distinct(., STATE1)
  
  FIN <- FIN %>% left_join(for_hire_fees, by = "YEAR") # join for-hire fees based on year to create state columns
  
  FIN <- as.data.frame(FIN)
  # create a single column of for-hire fees based on state columns
  FIN$for_hire_fee <-
    FIN[cbind(
      seq_len(nrow(FIN)),
      match(FIN$STATE1, colnames(FIN))
    )]
  
  message("Multiplying for-hire fees by number of anglers..")
  FIN <- FIN %>% 
    mutate(for_hire_fee = as.double(for_hire_fee)) %>% # make for hire fee a double 
    dplyr::select(-c(setdiff(names(for_hire_fees), "YEAR"))) %>% # remove joined state fee columns except for the YEAR column
    mutate(REVENUE = for_hire_fee*NANGLERS) # create revenue by multiplying for-hire fees by anglers
  message("Done.")

  # join TRIPIDs to overlap GEARIDs
  GEARID_to_TRIPID <- as_tibble(offshoreWind::GEARID_QUERY)
  GEARID_to_TRIPID <- GEARID_to_TRIPID %>% 
    dplyr::select(-SERIAL_NUM) %>% 
    dplyr::rename("IDNUM" = GEARID)
  GEARID_to_TRIPID <- GEARID_to_TRIPID[ which(GEARID_to_TRIPID$YEAR_L >= START.YEAR & GEARID_to_TRIPID$YEAR_L <= END.YEAR+1),]

  inside_areas_combined_trip <- as_tibble(merge(x=inside_areas_combined, y=GEARID_to_TRIPID,
                       by.x=c('IDNUM','Year'), by.y=c('IDNUM','YEAR_L'),
                       all.x=TRUE, all.y=TRUE)) # Old Merge

  inside_areas_combined_trip <- as_tibble(inside_areas_combined_trip %>% 
    dplyr::select(-IDNUM))
  # distinct(inside_areas_combined_trip, Inside)
  
} 


########################################################################################################################################
if (noaa_data_source == "vtr"|| noaa_data_source == "dmis") {
  
# Merge raster overlap with VTR/DMIS data - check if imgids recycle
message("Merging area data with ", ifelse(noaa_data_source=="vtr", "VTR", ifelse(noaa_data_source=="rec", "REC", ifelse(noaa_data_source=="dmis", "DMIS", "DMIS"))), " data by IDNUM and year..")
ptm.TOTAL = Sys.time()
REVENUEFILE <- as_tibble(merge(x=inside_areas_combined, y=FIN, 
                     by.x=c('IDNUM','Year'), by.y=c('IDNUM','YEAR'),
                     all.x=TRUE, all.y=TRUE)) # Old Merge

# REVENUEFILE2 <- as_tibble(merge(inside_areas_combined, FIN, 
#                                by.x=c("IDNUM","Year"), by.y=c("IDNUM","YEAR"), 
#                                all.X=TRUE,all.y=FALSE)) # Merge from Gerets markdown - *** the y join is now false ??right join??
# REVENUEFILE3 <- as_tibble(merge(x=FIN, y=inside_areas_combined, 
#                      by.x=c('IDNUM','YEAR'), by.y=c('IDNUM','Year'),
#                      all.x=TRUE, all.y=TRUE)) # Old Merge with tables switched

# colnames(FIN)
# comma_format()(nrow(REVENUEFILE))
# test <- REVENUEFILE %>% filter(!is.na(Area))

message(paste0("Run time ", round(difftime(Sys.time(), ptm.TOTAL, units='secs'), 2), " seconds for merge"))
message(comma_format()(length(base::intersect(inside_areas_combined$IDNUM, FIN$IDNUM))), " GearID matches from area data..") # number of matches from source data to area data through gearid
}
########################################################################################################################################

########################################################################################################################################
if (noaa_data_source == "rec") {
# Merge raster overlap with REC data - check if imgids recycle
message("Merging area data with REC data by TRIPID and year..")
ptm.TOTAL = Sys.time()

REVENUEFILE <- as_tibble(merge(x=inside_areas_combined_trip, y=FIN,
                     by.x=c('TRIPID','Year'), by.y=c('TRIPID','YEAR'),
                     all.x=TRUE, all.y=TRUE)) # Old Merge


message(paste0("Run time ", round(difftime(Sys.time(), ptm.TOTAL, units='secs'), 2), " seconds for merge"))

# message(comma_format()(length(base::intersect(inside_areas_combined_trip$TRIPID, FIN$TRIPID))), " TRIPID matches from area data..") # number of matches from source data to area data through gearid
message(comma_format()(length(base::intersect(inside_areas_combined$IDNUM, FIN$IDNUM))), " TRIPID matches from area data..") # number of matches from source data

}


# NOTE: The hullnum/vesid is filling in the permit number for clam trips, which don't have a permit attached to the record in the SFCLAM database. This will create NA's in the data
# if (noaa_data_source == "vtr") { # fix hull number and clam data
# REVENUEFILE <- REVENUEFILE[!is.na(REVENUEFILE$IDNUM),]
# REVENUEFILE$PERMIT[which(REVENUEFILE$GEARCODE=='DRC'& is.na(REVENUEFILE$PERMIT) & !is.na(REVENUEFILE$VESID))] <- REVENUEFILE$VESID[which(REVENUEFILE$GEARCODE=='DRC'& is.na(REVENUEFILE$PERMIT) & !is.na(REVENUEFILE$VESID))]
# } else if (noaa_data_source == "dmis1" || noaa_data_source == "dmis") {
# REVENUEFILE <- REVENUEFILE[!is.na(REVENUEFILE$IDNUM),]
# REVENUEFILE$PERMIT[which(REVENUEFILE$GEARCODE=='DRC'& is.na(REVENUEFILE$PERMIT))] <- REVENUEFILE$VESID[which(REVENUEFILE$GEARCODE=='DRC'& is.na(REVENUEFILE$PERMIT))]
# }

#There are a few trips which are left over from the earlier raster processing
# (not in the most recent data for whatever reason) 528 observations, but less trips total.

REVENUEFILE <- REVENUEFILE[!is.na(REVENUEFILE$PERMIT),]
#Dropping observations with pelagic gear

REVENUEFILE$Inside[which(is.na(REVENUEFILE$Inside))] <- 0
REVENUEFILE$InsideREV <- REVENUEFILE$Inside*REVENUEFILE$REVENUE

REVENUEFILE$QTYKEPT[which(is.na(REVENUEFILE$QTYKEPT))] <- 0
REVENUEFILE$InsideLANDED <- REVENUEFILE$Inside*REVENUEFILE$QTYKEPT

REVENUEFILE$Area[which(is.na(REVENUEFILE$Area))] <- 'Other'

# if (noaa_data_source == "vtr" || noaa_data_source == "dmis1") {
  REVENUEFILE$InsideDAS <- REVENUEFILE$Inside*REVENUEFILE$DAS
  REVENUEFILE$LIVE[which(is.na(REVENUEFILE$LIVE))] <- 0
# }

# Need quanty kept and quantity discarted for InsideLanded variable
if (noaa_data_source == "vtr"|| noaa_data_source == "rec") {
REVENUEFILE$QTYDISC[which(is.na(REVENUEFILE$QTYDISC))] <- 0
REVENUEFILE$TOTCATCH <- REVENUEFILE$LIVE+REVENUEFILE$QTYDISC
REVENUEFILE$InsideCATCH <- REVENUEFILE$Inside*REVENUEFILE$TOTCATCH

# Check vessle lengths - need access to permit table to run ship length R script
# REVENUEFILE$vesselcat = "U"
# REVENUEFILE$vesselcat[which(REVENUEFILE$LEN <50)] <- "S"
# REVENUEFILE$vesselcat[which(REVENUEFILE$LEN >=50 & REVENUEFILE$LEN < 70)] <- "M"
# REVENUEFILE$vesselcat[which(REVENUEFILE$LEN >=70)] <- "L"

if (is.na(NROW(REVENUEFILE[which(is.na(REVENUEFILE$TOTCATCH)),]))) stop("Some Total Catch is zero")
  }

REVENUEFILE$BROADZONE <- REVENUEFILE$Area
# change area names ??
# REVENUEFILE$BROADZONE[REVENUEFILE$Area%in%c('Primary_Recommendation','Secondary_Recommendation')] <- "Recommendation"
# REVENUEFILE$BROADZONE[REVENUEFILE$Area%in%MGAREA] <- "Recommendation"

# REVENUEFILE$SPPNM[REVENUEFILE$NESPP3==801] <- "INSHORE LONGFIN SQUID"
REVENUEFILE$SPPNM[REVENUEFILE$NESPP3%in%c(11,12)] <- "MONKFISH" # ***could this be the monkfish issue?
REVENUEFILE$SPPNM[REVENUEFILE$NESPP3%in%c(769)] <- "SURF CLAM"
REVENUEFILE$SPPNM[REVENUEFILE$NESPP3%in%c(754,755)] <- "OCEAN QUAHOG"

#FIN <- REVENUEFILE

# if (save_files == "r" | save_files == "b" ) {
#   save(REVENUEFILE,file=file.path(output_f, paste0(project_name,"_Data.Rdata",sep="")))
# }
# 
# if (save_files == "c" | save_files == "b" ) {
#   write.csv(REVENUEFILE,file=file.path(output_f, paste0(project_name,"_Data.csv",sep="")))
# }


REVENUEFILE_backup <- REVENUEFILE

# TODO: This part was added to troubleshoot an issue and can be refactored
# get character vector of all zones except "Other"
allZones1 <- sort(unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other" ]) 
# as.factor(unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other" ])
allZones <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("_"," ", allZones1), perl=TRUE) # make name pretty


# TODO: add column of areas with underscores to REVENUEFILE to reduce repeated code ???

# min(max(length(unique(nespp3))),7)
 
```

```{r adjust_nominal_values_to_real_values, eval = T} 
# Adjusting nominal values to real values  

# note **** there are NAs in REVENUE

#####################################################################################################################

# Set deflator based on year

# Testing
# deflate_by = "quarter"
# base_year = 2019
# base_quarter = "Q1"
# REVENUEFILE <- REVENUEFILE_backup

if(deflate_by=="year") {
  REVENUEFILE <- REVENUEFILE %>%
    mutate(nominal_revenue = REVENUE)
  
  GDPDEF_annual <- offshoreWind::GDPDEF_annual %>% dplyr::select(GDPDEF, Year) #  reduce columns
  
  REVENUEFILE <- as_tibble(merge(REVENUEFILE, GDPDEF_annual, by="Year", all.x=TRUE))
  
  REVENUEFILE[["REVENUE"]] <- REVENUEFILE[["nominal_revenue"]]*
    unique(GDPDEF_annual$GDPDEF[GDPDEF_annual$Year==base_year])/REVENUEFILE$GDPDEF
  
  REVENUEFILE$GDPDEF <- NULL

  FIN <- FIN %>%
    mutate(nominal_revenue = REVENUE) %>% 
    dplyr::rename("Year"=YEAR)

  GDPDEF_annual <- offshoreWind::GDPDEF_annual %>% dplyr::select(GDPDEF, Year) #  reduce columns
  FIN <- as_tibble(merge(FIN, GDPDEF_annual, by="Year", all.x=TRUE))
  FIN[["REVENUE"]] <- FIN[["nominal_revenue"]]*
    unique(GDPDEF_annual$GDPDEF[GDPDEF_annual$Year==base_year])/FIN$GDPDEF
  FIN$GDPDEF <- NULL
}
# save(REVENUEFILE, file="REVENUEFILE.Rdata")

#####################################################################################################################
# Set deflator based on year and quarter

if(deflate_by=="quarter") {

  REVENUEFILE <- REVENUEFILE %>%
    mutate(nominal_revenue = REVENUE) %>%  # create column for old revenue
    # mutate(MONTH = as.integer(format(DATESAIL,"%m"))) %>% # create column for MONTHth
    mutate(MONTH = as.integer(MONTH)) %>% # make sure MONTH is integer
    mutate(nominal_revenue = REVENUE) %>%  # Setup column for old revenue values
    mutate(Quarter = "") %>% # Create quarters column
    mutate(Quarter = ifelse(MONTH %in% 1:3, "Q1", Quarter)) %>%
    mutate(Quarter = ifelse(MONTH %in% 4:6, "Q2", Quarter)) %>%
    mutate(Quarter = ifelse(MONTH %in% 7:9, "Q3", Quarter)) %>%
    mutate(Quarter = ifelse(MONTH %in% 10:12 , "Q4", Quarter))
  # dplyr::select(-MONTH) # remove MONTHth column

  # REVENUEFILE <- REVENUEFILE %>% dplyr::select(IDNUM, REVENUE, nominal_revenue, Year, DATESAIL, MONTH, Quarter) # testing

  # GDPDEF_quarterly <- offshoreWind::GDPDEF_quarterly %>%
  #   dplyr::select(GDPDEF, Year, MONTH) %>%  #  reduce to relevant columns
  #   mutate(Quarter = "") %>% # Create quarters column
  #   mutate(Quarter = ifelse(MONTH %in% 1:3, "Q1", Quarter)) %>%
  #   mutate(Quarter = ifelse(MONTH %in% 4:6, "Q2", Quarter)) %>%
  #   mutate(Quarter = ifelse(MONTH %in% 7:9, "Q3", Quarter)) %>%
  #   mutate(Quarter = ifelse(MONTH %in% 10:12 , "Q4", Quarter)) %>%
  #   dplyr::select(GDPDEF, Year, Quarter)

  # *** pulled from the online link below instead of a downloaded csv file

  FIN <- FIN %>%
    mutate(nominal_revenue = REVENUE) %>%  # create column for old revenue
    # mutate(MONTH = as.integer(format(DATESAIL,"%m"))) %>% # create column for MONTHth
    mutate(MONTH = as.integer(MONTH)) %>% # make sure MONTH is integer
    mutate(nominal_revenue = REVENUE) %>%  # Setup column for old revenue values
    mutate(Quarter = "") %>% # Create quarters column
    mutate(Quarter = ifelse(MONTH %in% 1:3, "Q1", Quarter)) %>%
    mutate(Quarter = ifelse(MONTH %in% 4:6, "Q2", Quarter)) %>%
    mutate(Quarter = ifelse(MONTH %in% 7:9, "Q3", Quarter)) %>%
    mutate(Quarter = ifelse(MONTH %in% 10:12 , "Q4", Quarter))

  #####################################################################################################################
  #####################################################################################################################
  # pull from online text file at https://fred.stlouisfed.org/data/GDPDEF.txt instead of a flat file
  temp <- tempfile()
  temp.connect <- url("https://fred.stlouisfed.org/data/GDPDEF.txt")
  temp <- data.table(read.delim(temp.connect, fill=FALSE, stringsAsFactors=FALSE, skip = 15))
  temp <- temp %>% separate(col= "DATE..........VALUE", into=c("DATE", "GDPDEF"), sep="  ", convert=TRUE)
  temp$DATE <- as.Date(temp$DATE)
  temp$GDPDEF <- as.double(temp$GDPDEF)

  GDPDEF_quarterly <- as_tibble(temp %>%
                                  mutate(MONTH = as.integer(format(DATE,"%m"))) %>%
                                  mutate(day = as.integer(format(DATE,"%d"))) %>%
                                  mutate(Year = as.integer(format(DATE,"%Y"))) %>%
                                  dplyr::select(GDPDEF, Year, MONTH) %>%  #  reduce to relevant columns
                                  mutate(Quarter = "") %>% # Create quarters column
                                  mutate(Quarter = ifelse(MONTH %in% 1:3, "Q1", Quarter)) %>%
                                  mutate(Quarter = ifelse(MONTH %in% 4:6, "Q2", Quarter)) %>%
                                  mutate(Quarter = ifelse(MONTH %in% 7:9, "Q3", Quarter)) %>%
                                  mutate(Quarter = ifelse(MONTH %in% 10:12 , "Q4", Quarter)) %>%
                                  dplyr::select(GDPDEF, Year, Quarter))

  #####################################################################################################################
  #####################################################################################################################
  # Deflate revenue file using GPD deflator

  REVENUEFILE <- as_tibble(merge(REVENUEFILE, GDPDEF_quarterly, by=c("Year", "Quarter"), all.x=TRUE, all.y=FALSE))

  FIN <- as_tibble(merge(FIN, GDPDEF_quarterly, by=c("Year", "Quarter"), all.x=TRUE, all.y=FALSE))

  # REVENUEFILE %>% # check NAs
  #   dplyr::select(everything()) %>%
  #   summarise_all(list(~ sum(is.na(.))))
  # GDPDEF_quarterly <- GDPDEF_quarterly %>% arrange(desc(Year,Quarter)) # check data

  REVENUEFILE[["REVENUE"]] <- REVENUEFILE[["nominal_revenue"]]*
    unique(GDPDEF_quarterly$GDPDEF[GDPDEF_quarterly$Year==base_year&GDPDEF_quarterly$Quarter==base_quarter])/REVENUEFILE$GDPDEF # apply deflator to nominal revenue

  # REVENUEFILE <- REVENUEFILE %>% dplyr::select(-GDPDEF, -Quarter) # Remove irrelevant columns
  REVENUEFILE <- REVENUEFILE %>% dplyr::select(-GDPDEF) # Remove irrelevant columns


  FIN[["REVENUE"]] <- FIN[["nominal_revenue"]]*
    unique(GDPDEF_quarterly$GDPDEF[GDPDEF_quarterly$Year==base_year&GDPDEF_quarterly$Quarter==base_quarter])/FIN$GDPDEF # apply deflator to nominal revenue

  # REVENUEFILE <- REVENUEFILE %>% dplyr::select(-GDPDEF, -Quarter) # Remove irrelevant columns
  FIN <- FIN %>% dplyr::select(-GDPDEF) # Remove irrelevant columns

}

# create revenue deflation note for vignette:
revenue_deflation_note <- ""
revenue_deflation_note <- paste0("Revenue values have been deflated to ", if_else(deflate_by == "quarter", paste0(base_quarter," "),""), base_year, " dollars." )


# Use the API from Federal Reserve site using 3rd party R package
# library(alfred)
# # Download industrial production index releases from March 2015 for 2013.
# get_alfred_series("INDPRO", "test",
#                   observation_start = "2013-03-01", observation_end = "2013-03-30",
#                   realtime_start = "2015-02-02", realtime_end = "2015-02-02")
# # Wrapper for getting only most recent releases
# get_fred_series("INDPRO", "indpro", observation_start = "2009-03-01", observation_end = "2009-03-01")

# create new folder for section
dir.create(file.path(output_f, "revenuefile"), showWarnings = FALSE)
dir.create(file.path(output_f, "fin"), showWarnings = FALSE)
output_revenuefile = file.path(output_f, "revenuefile")
output_fin = file.path(output_f, "fin")

safe_file_name <- paste0("_",substr(gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("-","_", gsub("/","-", wind_area_name))), perl=TRUE),0,50),".RData")

# if (save_files == "c" | save_files == "b" ) {
#   write.csv(FIN, file=file.path(output_revenuefile, paste0("FIN", safe_file_name)), row.names=FALSE)
#   write.csv(REVENUEFILE, file=file.path(output_fin, paste0("REVENUEFILE", safe_file_name)), row.names=FALSE)
# }

# save(FIN, file=file.path(output_revenuefile, paste0("FIN", safe_file_name)))
# save(REVENUEFILE, file=file.path(output_fin, paste0("REVENUEFILE", safe_file_name)))

# backups for testing
FIN_backup <- FIN
REVENUEFILE_backup <- REVENUEFILE

# create new folder for section
dir.create(file.path(output_f, "REVENUEFILEs"), showWarnings = FALSE)
output_revenue = file.path(output_f, "REVENUEFILEs")

if (length(proj_area_name) == 1) {
  save(REVENUEFILE, file= file.path(output_revenue, paste0("REVENUEFILE_", proj_area_name, ".rdata"))) # save revenuefile if number of areas is 1
} else if(length(proj_area_name) > 1 & overlap_data_source == "folder") {
  save(REVENUEFILE, file= file.path(output_revenue, paste0("REVENUEFILE_", basename(overlap_data_path), ".rdata"))) # save revenuefile if more than 1 area and overlap data comes from a folder - save as name of folder
} else {
  save(REVENUEFILE, file= file.path(output_revenue, paste0("REVENUEFILE_", proj_area_name[1],"_and_other_areas", ".rdata"))) # save revenuefile if more than 1 area and any other edge cases
}




# REVENUEFILE_folder_overlap_source <- REVENUEFILE
# save(REVENUEFILE_folder_overlap_source, file = "REVENUEFILE_folder_overlap_source.rdata")

# REVENUEFILE_oracle_overlap_source <- REVENUEFILE
# save(REVENUEFILE_oracle_overlap_source, file = "REVENUEFILE_oracle_overlap_source.rdata")

# dim(REVENUEFILE_folder_overlap_source)
# dim(REVENUEFILE_oracle_overlap_source)
# rm(REVENUEFILE_folder_overlap_source,REVENUEFILE_oracle_overlap_source)

```

```{r create_map_of_lease_area, eval = T} 
  crs <- CRS("+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0")

# if (params$skip_google_drive_access) {
#   all_areas <- offshoreWind::all_areas
# } else {
# # Download project area shapefiles from Google Drive and load
# temp <- tempfile(fileext = ".zip")
# dl <- drive_download(
#   as_id(Project_Areas_12_3_2019_id), path = temp, overwrite = TRUE)
# out <- unzip(temp, exdir = tempdir())
# 
# all_areas <- rgdal::readOGR(dsn=file.path(dirname(out)[1]), layer="Project_Areas_12_3_2019", verbose=F)
# # all_areas = rgdal::readOGR(dsn=file.path(raw_data_path,"Project_Areas_12_3_2019"), layer="Project_Areas_12_3_2019", verbose=F) # load shapefiles from raw data folder
# }

if (any(proj_area_name %in% formatted_lease_area_table$proj_area_file_name)) {
  
all_areas <- spTransform(offshoreWind::all_areas, CRS=crs)
all_areas <- sf::st_as_sf(all_areas)

lease_area <- all_areas %>% dplyr::filter(NAME == proj_area_name)

states <- map_data("state")
east_coast <- subset(states, region %in% c("maine", "massachusetts", "vermont", "new hampshire","rhode island", "connecticut", "new york", "pennsylvania", 
                                           "new jersey", "maryland", "delaware", "district of columbia", "virginia", "west virginia", "north carolina"))
# Wind area extent
xlim <- c(-78, -70)
ylim <- c(36, 42)

lease_area_map <- ggplot(data = east_coast) + 
  geom_polygon(aes(x = long, y = lat, group = group), fill = "#D1D1E0", color = "black") +
  geom_sf(data = lease_area, fill= "red", color = "red") +
  coord_sf(xlim = xlim, ylim = ylim) +
  ggtitle(wind_area_name) +
  theme(axis.title.y=element_blank(),
        axis.title.x=element_blank(),
        plot.title = element_text(hjust = 0.5))
  # theme(axis.text.x = element_blank(),
  #       axis.text.y = element_blank(),
  #       axis.ticks = element_blank(),
  #       rect = element_blank(),
  #       axis.title.y=element_blank(),
  #       axis.title.x=element_blank())

}

if (any(proj_area_name %in% formatted_lease_area_table$proj_area_file_name) == FALSE & shapefile_path != "") {
  layer_name = unique(gsub(pattern="(.+)(.shp$)","\\1", ignore.case = TRUE , list.files(path=shapefile_path, pattern = "(.+)(.shp$)", ignore.case =TRUE, recursive=F, full.names=F)))
  
  if (length(layer_name)>1) {
  
  file_list <- list.files(shapefile_path, pattern = "*shp$", full.names = TRUE)
  shapefile_list <- lapply(file_list, sf::read_sf)
  # all_areas <- do.call(rbind, shapefile_list)
  all_areas <- sf::st_as_sf(data.table::rbindlist(shapefile_list))
  all_areas <- all_areas[,(names(all_areas) %in% c("Name"))]
  # all_areas <- spTransform(all_areas, CRSobj = crs)
  # raster::aggregate(all_areas, dissolve = TRUE)
  
  #I don't understand the reason for the previous 5 lines of code that define all_areas
  count <- 0
  rm(all_areas)
  for (layer in layer_name) {
    if (count == 0) {
      all_areas <- rgdal::readOGR(dsn=shapefile_path, layer=layer, verbose=F)
      all_areas <- spTransform(all_areas, CRSobj = crs)
      all_areas@data$NAME <- layer[1]
      all_areas <- all_areas[,(names(all_areas) %in% c("NAME"))]
      all_areas
      count <- count + 1
    } else {
      extra_layer <- rgdal::readOGR(dsn=shapefile_path, layer=layer, verbose=F)
      extra_layer <- spTransform(extra_layer, CRSobj = crs)
      extra_layer@data$NAME <- layer[1]
      extra_layer <- extra_layer[,(names(extra_layer) %in% c("NAME"))]
      extra_layer
      # lease_area <- raster::aggregate(ab, dissolve = TRUE)
      all_areas <- raster::union(extra_layer, all_areas) # Combine all lease areas plus maine area into one shapefile
      rm(extra_layer)
    }
  }
  
  } else {
    all_areas <- rgdal::readOGR(dsn=shapefile_path, layer=layer_name, verbose=F)
  }
  
  all_areas <- spTransform(all_areas, CRS=crs)
  lease_area <- sf::st_as_sf(all_areas)
  
  states <- map_data("state")
  east_coast <- subset(states, region %in% c("maine", "massachusetts", "vermont", "new hampshire","rhode island", "connecticut", "new york", "pennsylvania", 
                                             "new jersey", "maryland", "delaware", "district of columbia", "virginia", "west virginia", "north carolina"))
  
  # get extents of shapefile
  xmin <- extent(lease_area)[1]
  xmax <- extent(lease_area)[2]
  ymin <- extent(lease_area)[3]
  ymax <- extent(lease_area)[4]
  
  # Create custom extent if shape is outside (north or east) of wind areas
  if (xmax > -71) {
    new_xmax <- xmax + 3 # fix extent if shape is further out east
    new_xmin <- new_xmax - 8 
    xlim <- c(new_xmin, new_xmax)
  } else {
    xlim <- c(-78, -70)
  }
  
  if (ymax > 41) {
    new_ymax <- ymax + 3 # fix extent if shape is further north
    new_ymin <- new_ymax - 6
    ylim <- c(new_ymin, new_ymax)
  } else {
    ylim <- c(36, 42)
  }
  
  lease_area_map <- ggplot(data = east_coast) + 
    geom_polygon(aes(x = long, y = lat, group = group), fill = "#D1D1E0", color = "black") +
    geom_sf(data = lease_area,  fill = c("green","green","red","khaki2","red","khaki2") )+
    coord_sf(xlim = xlim, ylim = ylim) +
    ggtitle(wind_area_name) +
    theme(axis.title.y=element_blank(),
          axis.title.x=element_blank(),
          plot.title = element_text(hjust = 0.5))
}


```

<!-- Run to here to get REVENUEFILE -->



<!-- Note: The HULLNUM/VESID variable is not used in this dataset to fill in the permit number for clam trips (which don't have a permit attached to the record in the SFCLAM database). This will introduce NA's to the data. -->



<br>

\center
<center>

[Back](https://www.fisheries.noaa.gov/resource/data/socioeconomic-impacts-atlantic-offshore-wind-development)


Descriptions of Selected Fishery Landings and Estimates of Vessel Revenue from Areas: A Planning-level Assessment 
NOTE: These data used to construct these figures have NOT been filtered to the months under consideration.

<br>

Prepared by:  
National Marine Fisheries Service  


<br>

 `r format(Sys.time(), '%B %d, %Y')`

<br>

<br>

```{r map_of_area, results='asis', eval = T} 

if (proj_area_name %in% formatted_lease_area_table$proj_area_file_name | shapefile_path != "") {
print(lease_area_map)
}

```

<br>

<br>

Data sources:  
Commerical Fisheries landings data, Vessel Trip Reports, and Surfclam/OceanQuahog Logbooks

<br>

</center>

**In order to meet requirements of maintaining data confidentiality, these strata are presented individually. In addition, records that did not meet the rule of three (>=3 unique dealers and >= 3 unique permits), values were summarized as ‘ALL OTHERS’.**


Some caveats/notes:

* Values are reported in nominal dollars. Values in 2019 dollars are reported as well (see below for details).
* Pounds are reported in landed (dressed) pounds.
* Data summarized here is based on vessels that are required to provide federal VTRs.
* Federal lobster vessels, with only lobster permits, do not have a VTR requirement. Many Atlantic Highly Migratory Species permitted vessels also do not have a VTR requirement. Trips with no VTR are not reflected in this summary.
* There exist other fisheries in State waters that may not be reflected in data from federal sources (e.g. whelk, bluefish). It is recommended to query state agencies for additional data within state waters.
* All summaries presented here are built from percentages of a trip that overlapped spatially with the WEAs. These percentages were applied to landings and values for that trip and summed. This differs from simply using the self-reported VTR/clam logbook locations as those place all value from that trip at a single point. Use of the VTR raster model is more representative as smoothing reported locations reduces the effect of location inaccuracy.

<br>


References  
[DePiper GS (2014) Statistically assessing the precision of self-reported VTR fishing locations.](https://repository.library.noaa.gov/view/noaa/4806)  
[Benjamin S, Lee MY, DePiper G. 2018. Visualizing fishing data as rasters. NEFSC Ref Doc 18-12; 24 p.](https://repository.library.noaa.gov/view/noaa/23030)


<br>

<br>


<!-- \newenvironment{monoblock}% -->
<!--   {\ttfamily}% -->
<!--   {} -->


\newpage

```{r fmp_top_five_dynamic_text, results='asis', eval = T} 

# sort(names(REVENUEFILE))

# unique(REVENUEFILE$FMP)
# unique(REVENUEFILE$NESPP3)
# test <- REVENUEFILE %>% filter(is.na(FMP))

# Top 5 fmps after pii fix for all areas
top_five_fmp_names <- REVENUEFILE %>%
  filter(Area != "Other") %>% 
  dplyr::select(FMP, Year, InsideREV, InsideLANDED, PERMIT, Area, DEALNUM) %>%
  group_by(Year, FMP, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(FMP_CONF = ifelse(CONF == T, 'All Others', FMP)) %>%
  ungroup() %>%
  group_by(Year, FMP_CONF, Area) %>%
  dplyr::summarize(
    yfa_rev = sum(InsideREV, na.rm = T),
    yfa_land = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("FMP"= FMP_CONF) %>% 
  dplyr::select(FMP, Year, Area, yfa_rev, yfa_land) %>% 
  # group_by(FMP, Area) %>% 
  group_by(FMP) %>% 
  dplyr::summarize(
    allyrtotal_rev = sum(yfa_rev, na.rm = T),
    allyrtotal_land = sum(yfa_land, na.rm = T)) %>% 
  arrange(desc(allyrtotal_rev)) %>% 
  ungroup() %>% 
  top_n(n=5, wt=allyrtotal_rev) %>% 
  pull(FMP)

# Might be an issue of top 5 FMP has 0 revenue

if (any(top_five_fmp_names %in% "No Federal FMP")) {
  topfmp_names <- paste0(top_five_fmp_names[!top_five_fmp_names %in% "No Federal FMP"], collapse = ", ")
  topfmp_names <- paste0(topfmp_names, " and No Federal FMP")
} else {
  topfmp_names <- paste0(top_five_fmp_names %notin%  tail(top_five_fmp_names, n=1), collapse = ", ")
  topfmp_names <-paste0(topfmp_names, " and ", tail(top_five_fmp_names, n=1))
}

# length(unique(REVENUEFILE[which(REVENUEFILE$FMP == "None" & REVENUEFILE$InsideREV > 0),]$SPPNM))

piifmpsppnm_allyrs <- REVENUEFILE %>% 
  filter(Area != "Other") %>% 
  # dplyr::select(FMP, SPPNM, Year, InsideREV, InsideLANDED, PERMIT) %>%
  dplyr::select(FMP, SPPNM, Year, InsideREV, InsideLANDED, PERMIT, DEALNUM) %>% # for dealers
  group_by(FMP, SPPNM) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 = ndealers < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(FMP_CONF = ifelse(CONF == T, 'All Others', FMP)) %>%
  mutate(SPPNM_CONF = ifelse(CONF == T, 'All Others', SPPNM)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("FMP")) %>%
  dplyr::select(InsideREV, InsideLANDED, npermits, FMP_CONF, SPPNM_CONF) %>%
  group_by(FMP_CONF, SPPNM_CONF) %>%
  dplyr::summarize(
    InsideREV_total = sum(InsideREV, na.rm = T),
    InsideLANDED_total = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>%
  arrange(desc( InsideREV_total)) %>%
  dplyr::rename("FMP"= FMP_CONF,"SPPNM"= SPPNM_CONF, "All Year Revenue" = InsideREV_total, "All Year Landings (Pounds)" = InsideLANDED_total)
  
numsp <- length(unique(piifmpsppnm_allyrs$SPPNM))


# -if areas dont have same top FMP ??


```

<!-- ## Sections {.tabset .tabset-fade .tabset-pills} -->

\raggedright
<!-- ### Most Impacted FMPs  -->


<!-- We define “most impacted” as the FMPs deriving the most revenue from the `r if(number_of_areas > 1) {paste0("areas")} else {paste0("area")}` over the `r numbers2words(length(START.YEAR:END.YEAR))` year analysis period of `r START.YEAR` to `r END.YEAR`, indicating the highest potential for impact to industry from a reduction in fishing area.  -->
<!--  The top 5 FMPs by revenue `r if(number_of_areas > 1) {paste0("between all areas")} else {paste0("in ", wind_area_name)}` were `r topfmp_names``r ifelse(any(top_five_fmp_names %in% "No Federal FMP"), paste0(".” The category “No Federal FMP” contains a variety of species that are not federally regulated, such as: smooth and chain dogfish, whelk, and menhaden, (",ifelse(numsp==0,"there were no species", paste0("there are close to ", numsp," species"))," without federal FMPs caught in the ", wind_area_name, " area)"),"")`. `r revenue_deflation_note` `r rounded_message` Specific figures on these FMPs within `r if(number_of_areas > 1) {paste0("each")} else {paste0("the")}` area follow. -->


```{r top_fmp_plots, results='asis', eval = top_fmp_section} 
##########################################################################

cat("### Most Impacted FMPs \n")

cat("We define “most impacted” as the FMPs deriving the most revenue from the", if(number_of_areas > 1) {paste0("areas")} else {paste0("area")}, " over the  ", numbers2words(length(START.YEAR:END.YEAR))," year analysis period of ", START.YEAR," to ", END.YEAR,", indicating the highest potential for impact to industry from a reduction in fishing area.", "The top 5 FMPs by revenue ", if(number_of_areas > 1) {paste0("between all areas")} else {paste0(" in ", wind_area_name)}, " were " , topfmp_names, ifelse(any(top_five_fmp_names %in% "No Federal FMP"), paste0(".” The category “No Federal FMP” contains a variety of species that are not federally regulated, such as: smooth and chain dogfish, whelk, and menhaden, (", ifelse(numsp==0,"there were no species", paste0("there are close to ", numsp," species"))," without federal FMPs caught in the ", wind_area_name, " area)"),""),". ", revenue_deflation_note," ", rounded_message," Specific figures on these FMPs within ", if(number_of_areas > 1) {paste0("each")} else {paste0("the")}," area follow.", sep="")

cat("<br> ")

# testing
# save_files = "n" #dont save files as csv or rdata
# save_files = "c"
# knitr::knit_hooks
# as.data.frame(table(REVENUEFILE$Area))

# create new folder for section
dir.create(file.path(output_f, "topfmp"), showWarnings = FALSE)
output_ftopfmp = file.path(output_f, "topfmp")

##############################
# openxlsx example
# wb <- createWorkbook(creator = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("\\."," ", unname(Sys.info()["user"]))), perl=TRUE), title = NULL) # get user fullname
# ## Add a worksheets
# addWorksheet(wb, "PIIFMP", gridLines = TRUE)
# addWorksheet(wb, "FMP_Total", gridLines = TRUE)
# ## write data to worksheet 1 and 2
# writeData(wb, sheet = "PIIFMP", piifmp, keepNA = TRUE)
# writeData(wb, sheet = "FMP_Total", fmpallyr_total, keepNA = TRUE)
# # save workbook to file
# saveWorkbook(wb, file = file.path(output_f, paste0("TopFMP_",project_name,".xlsx")), overwrite = TRUE)
##############################

section_num = section_num + 1
figure_num = 0

# DO NOT USE THIS TABLE FOR ANYTHING OTHER THAN DETERMINING THE NAMES OF THE TOP FMPS FOR THE AREA(S) - GROUPING FOR PII WILL MESS UP TOTALS 
# Get top revenue FMPs, sorted by revenue, grouped by FMPs for all years and remove PII - ** this list order will be used for all areas
allYearsSum <- REVENUEFILE %>% # FMP NAs are already removed in the DMIS cleaning code chunk
  filter(Area != "Other") %>% 
  # dplyr::select(FMP, InsideREV, InsideLANDED, PERMIT) %>%
  dplyr::select(FMP, InsideREV, InsideLANDED, PERMIT, DEALNUM) %>% # for dealers
  group_by(FMP) %>% # Using only FMP as grouping will mess up uniqueness of dealers and permits
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF = npermits < 3) %>%
  # mutate(CONF2 =  ndealers < 3) %>%
  mutate(CONF = npermits < 3 | ndealers < 3) %>%
  mutate(FMP_CONF = ifelse(CONF == T, 'All Others', FMP)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("FMP")) %>%
  dplyr::select(InsideREV, InsideLANDED, npermits, FMP_CONF) %>%
  group_by(FMP_CONF) %>%
  dplyr::summarize(
    InsideREV_total = sum(InsideREV, na.rm = T),
    InsideLANDED_total = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("FMP"= FMP_CONF)

# PII fixed for all areas
piifmp <- REVENUEFILE %>%
  filter(Area != "Other") %>% 
  # dplyr::select(FMP, Year, InsideREV, InsideLANDED, PERMIT, Area ) %>%
  dplyr::select(FMP, Year, InsideREV, InsideLANDED, PERMIT, Area, DEALNUM) %>% # for dealers
  group_by(Year, FMP, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 =  ndealers < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(FMP_CONF = ifelse(CONF == T, 'All Others', FMP)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("FMP")) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, npermits, FMP_CONF) %>%
  group_by(Year, FMP_CONF, Area) %>%
  dplyr::summarize(
    yfa_rev = sum(InsideREV, na.rm = T),
    yfa_land = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("FMP"= FMP_CONF)

fmpallyr_total <- piifmp %>% dplyr::select(FMP, Year, Area, yfa_rev, yfa_land) %>% 
  group_by(FMP, Area) %>% 
  dplyr::summarize(
    allyrtotal_rev = sum(yfa_rev, na.rm = T),
    allyrtotal_land = sum(yfa_land, na.rm = T)
  )

fmp_merge <- merge(piifmp, fmpallyr_total, by = c("FMP", "Area"))

# write.csv(fmp_merge, file="fmp_merge.csv", row.names=FALSE)

# create workbook object for Excel output outside loop
mostimpactedland_wb <- createWorkbook(creator = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("\\."," ", unname(Sys.info()["user"]))), perl=TRUE), title = "TopFMPLand") # get user full name
mostimpactedrev_wb <- createWorkbook(creator = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("\\."," ", unname(Sys.info()["user"]))), perl=TRUE), title = "TopFMPRev") # get user full name
# write to Excel workbook object - sheet name based on letters of area name and with area order number to differenciate incase of duplicate letters
# add sheet of all years
addWorksheet(mostimpactedland_wb, "TopFMP_AllAreas", gridLines = TRUE)
writeData(mostimpactedland_wb, sheet = "TopFMP_AllAreas", fmp_merge, keepNA = TRUE)
addWorksheet(mostimpactedrev_wb, "TopFMP_AllAreas", gridLines = TRUE)
writeData(mostimpactedrev_wb, sheet = "TopFMP_AllAreas", fmp_merge, keepNA = TRUE)


# create a table with a bunch of differently grouped totals that will be filtered by area during the iteration of the graphs
topFMP_all_areas <- left_join(allYearsSum, fmp_merge, by='FMP') %>% 
  filter(FMP %in% top_five_fmp_names) # top_five_fmp_names is from the summary creater section 


# make FMP names lowercase
# topFMP_all_areas$FMP <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(topFMP_all_areas$FMP), perl=TRUE)
# topFMP_all_areas$FMP[topFMP_all_areas$FMP=="None"] <- "No Federal FMP"

# Replace 'None' with pretty wording 
# REVENUEFILE$FMP[REVENUEFILE$FMP=="None"] <- "No Federal FMP"
##########################################################################
# Top5FMP plot

#################################
#### Set Top FMP Plot Colors ####
#################################
#### create custom color palette for all unique top FMPs - must come before loop

# assignedColors, maxUniqueColors, and paletteName1 variables were set in beginning variable assignment code chunk

# get top 5 fmps by revenue, by area
# top5byArea <- fmp_merge %>% group_by(FMP, Area) %>%
#   dplyr::summarize(
#     REV = sum(yfa_rev, na.rm = T)
#     ) %>%
#   ungroup %>%
#   group_by(Area) %>%
#   top_n(., n=5, wt=REV) %>%
#   arrange(Area, desc(REV)) %>%
#   ungroup %>%
#   mutate(FMP = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(FMP), perl=TRUE)) %>%
#   mutate(FMP = if_else(FMP=="None","No Federal FMP", FMP))
# 
# NumUniqueMargins <- length(unique(top5byArea$FMP))
# 
# UniqueMargins <- unique(top5byArea$FMP)

# count of number of unique FMPs between each area
# top5byArea <- within(top5byArea, { count <- ave(Area, FMP, FUN=function(x) length(unique(x)))})
# pull(top5byArea[top5byArea$count==1,"FMP"]) # get vector of FMPs not shared by all areas

# get top fmps by revenue, overall
top5fmps <- fmp_merge %>% group_by(FMP) %>%
  dplyr::summarize(
    REV = sum(yfa_rev, na.rm = T)
    ) %>% 
  ungroup %>% 
  top_n(., n=5, wt=REV) %>% 
  arrange(desc(REV)) %>% 
  ungroup
  # ungroup %>% 
  # mutate(FMP = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(FMP), perl=TRUE)) %>% 
  # mutate(FMP = if_else(FMP=="None","No Federal FMP", FMP))

# top5fmps <- fmp_merge %>% group_by(FMP) %>%
#   dplyr::summarize(
#     REV = sum(allyrtotal_rev, na.rm = T)
#     ) %>%
#   ungroup %>%
#   top_n(., n=5, wt=REV) %>%
#   arrange(desc(REV)) %>%
#   ungroup()

topfmp_names_wrapped <- str_wrap(unique(top5fmps$FMP), width=30) # change extra long legend names - add a \n to halfway word to match plot

NumUniqueMargins <- length(unique(top5fmps$FMP))

UniqueMargins <- str_wrap(unique(top5fmps$FMP), width=30) # change extra long legend names - add a \n to halfway word to match plot

# make extra colors if more unique FMPs than maximum colors for palette
if (NumUniqueMargins > maxUniqueColors) {
  getPalette = colorRampPalette(brewer.pal(maxUniqueColors, paletteName1))
  myColors <- getPalette(NumUniqueMargins)
} else {
  myColors <- brewer.pal(NumUniqueMargins, paletteName1) # create list of colors using number of unique FMPs from pallettte name
  }

names(myColors) <- UniqueMargins # name colors for color scale

# create custom color scale assigned to each fmp to use on all top fmp plots
uniquefmpScale <- scale_fill_manual(name = NULL, values = myColors, guide = guide_legend(reverse = TRUE))

topfmpColors <- myColors

rm(NumUniqueMargins, UniqueMargins) # garbage collection

# uniquefmpScale <- make_color_scale(top5fmps$FMP, scale_name = paletteName1, maxUniqueColors = maxUniqueColors, wrap_names = TRUE)

# original color scale based on revenue quanities - subjective to areas
quantScale <- scale_fill_brewer(name = NULL, palette = "YlOrBr", 
                    guide = guide_legend(reverse = TRUE))

#####################################
#### Set Top FMP Plot Colors end ####
#####################################

# get vector of all zones except "Other"
# allZones <- sort(unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other" ])
# 
# as.factor(unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other" ])

###########################################################
############ get only data for select area ###########
###########################################################
# broadzone = "Fairways North"
# broadzone = "Fairways_South"
# broadzone = "Hudson_North"
# broadzone = "Hudson_South"
# ### replace underscores with space and capitalize each word (for plot title automation)
# broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE)

# topFMP <- left_join(head(allYearsSum[order(-allYearsSum$InsideREV_total),],5), fmp_merge, by='FMP')

#### get rev and landing plots and tables for all zones
for (broadzone in allZones) {
  figure_num = figure_num + 1
  # broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE) # make name pretty
  # cat("\raggedright")
  # cat(paste0("*", broadzone, "*", "  ", "\n\n"),"  ") # display name of broadzone on vignette
  # broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", broadzone), perl=TRUE) # make spaces underscores in area 
  broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", broadzone)), perl=TRUE) # make spaces underscores and backslashs as dashes in area 
  
# landings area
# revland_area <- fmp_merge %>% filter(Area == broadzone)

# save to csv
# if (save_files == "c" | save_files == "b" ) {
#   write.csv(revland_area, file=file.path(output_ftopfmp,
#                                      paste0(gsub(pattern="[a-z]?", replacement="", broadzone),
#                                             "_revlandagg.csv")), row.names=FALSE)
# }

# set up data frame for by-group processing and calculate the three summary metrics
# topFMP <- left_join(head(allYearsSum[order(-allYearsSum$InsideREV_total),],5), revland_area, by='FMP')
# topFMPNames <- unique(topFMP$FMP)

# make FMP names lowercase
# topFMP$FMP <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(topFMP$FMP), perl=TRUE)
# topFMP$FMP[topFMP$FMP=="None"] <- "No Federal FMP"
  
# broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", allZones[2])), perl=TRUE)

# filter grouped totals table by the current area
topFMP_table <- topFMP_all_areas %>% filter(Area == broadzone_underscore)#create top fmp table without line breaks

#Not sure why we're filling in END.YEAR. Hope its okay.
#This only works if length()==0 or ==1. It will break for length()>=2
if (length(top_five_fmp_names %notin% unique(topFMP_table$FMP)) > 0) { # add a blank row for any missing FMPs so they appear in tables and plots for all areas
  topFMP_table[nrow(topFMP_table)+1,] <- list(top_five_fmp_names %notin% unique(topFMP_table$FMP), 0, 0, 0, broadzone_underscore, as.character(END.YEAR), 0, 0, 0, 0, 0)
}
         



# topFMP_table[nrow(topFMP_table)+1,] <- list(top_five_fmp_names %notin% unique(topFMP_table$FMP), 1, 1, 1, broadzone_underscore, 2119, 1, 1, 1, 1, 1)
# glimpse(topFMP_table)

topFMP <- topFMP_table
# change extra long legend names - add a \n to halfway word 
topFMP$FMP <- str_wrap(topFMP$FMP, width=30)

# topFMP %>% distinct(., FMP)

# write to Excel workbook object - sheet name based on letters of area name and with area order number to differenciate incase of duplicate letters
# addWorksheet(mostimpacted_wb, paste0("TopFMP_", gsub(pattern="[a-z]?", replacement="", broadzone),"_",figure_num), gridLines = TRUE)
# writeData(mostimpacted_wb, sheet = paste0("TopFMP_", gsub(pattern="[a-z]?", replacement="", broadzone),"_",figure_num), topFMP, keepNA = TRUE)

# change order of stack
# topFMPLand$FMP <- reorder(topFMPLand$FMP, topFMPLand$sum_land)
# topFMPLand$FMP <- factor(topFMPLand$FMP, levels=levels(topFMPLand$FMP))

topFMP$FMP <- reorder(topFMP$FMP, topFMP$yfa_rev)
topFMP$FMP <- factor(topFMP$FMP, levels=levels(topFMP$FMP))

# cat("\centering")
cat("Figure ", section_num,".", figure_num, " Landings from Most Impacted FMPs, ", broadzone, "  \n\n", sep = "")

# unique(topFMP$FMP)

# plot
# lp <- ggplot(topFMP, aes(x = Year, y = yfa_land/1000000, fill=str_wrap(FMP,20))) +
# lp <- ggplot(topFMP, aes(x = Year, y = yfa_land/1000000, fill = str_wrap(FMP, width = 30))) +
lp <- ggplot(topFMP, aes(x = Year, y = yfa_land/1000000, fill = FMP)) +
  guides(fill=guide_legend(title=NULL, reverse = TRUE)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Millions of Pounds") +
  # scale_y_continuous() +
  scale_y_continuous(expand=expansion(mult=c(0,0.1))) + 
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
  ggtitle(paste0("Landings from Most Impacted FMPs, ", broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale
if (assignedColors) {
  lp <- lp + uniquefmpScale
} else {
  lp <- lp + quantScale
}

# dispay plot
print(lp)

# save to file
ggsave(filename = file.path(output_ftopfmp, paste0("Top5FMPLand_",substr(broadzone_underscore,0,30),".png")), plot = lp)

# save to file - base functions
# png(paste0(output_ftopfmp,"/Top5FMPLand_",broadzone,".png")
# print(lp)
# dev.off()
rm(lp) # garbage collection - free up memory
# alternatively, save plot as png and call
# knitr::include_graphics("rrtools-steps-carbon.png")

# sort by landings
allyrland_table <- topFMP_table %>%  
  distinct(FMP, allyrtotal_rev, allyrtotal_land) %>%
  arrange(desc(allyrtotal_land)) %>%
  # arrange(desc(allyearland_total)) %>%
  dplyr::select(FMP, allyrtotal_land) %>% 
  dplyr::rename("All Year Total" = allyrtotal_land) %>% 
  ungroup()

# write to Excel workbook object - sheet name based on letters of area name and with area order number to differenciate incase of duplicate letters
addWorksheet(mostimpactedland_wb, paste0("TopFMPL_", gsub(pattern="[a-z]?", replacement="", broadzone_underscore),"_",figure_num), gridLines = TRUE)
writeData(mostimpactedland_wb, sheet = paste0("TopFMPL_", gsub(pattern="[a-z]?", replacement="", broadzone_underscore),"_",figure_num), allyrland_table, keepNA = TRUE)
  
# %>%  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))
# TODO: add number to word function

# convert fmp back to charaters - add totals row - format Landings column w/ $, commas, and rounded for estimation - *non-pipe way
allyrland_table$FMP <- as.character(allyrland_table$FMP)
allyrland_table <- rbind(allyrland_table, c("**Total**", colSums(allyrland_table[,2])))
# allyrland_table$`All Total` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyrland_table$`All Total`))
allyrland_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE))) < 500,"<500", comma_format(trim = TRUE, accuracy = 1000)(as.numeric(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
allyrland_table[nrow(allyrland_table),2] <- paste0("**",allyrland_table[nrow(allyrland_table),2],"**")

# set dynamic varible names (cant use paste0 in rename in tidyverse)

# allyrland_table %>% rename_at()

# names(allyrland_table)[names(allyrland_table) == "All Year Total"] <- paste0(numyear, " Year Total")
names(allyrland_table)[names(allyrland_table) == "All Year Total"] <- paste0(numyear, " Year Landings")

cat("\n\n")

print(kable(allyrland_table, caption = paste0(numyear, ' Year Total Landings (Pounds), Most Impacted FMPs, ', broadzone), align=c('l', 'r')))
  
cat("\n\n\n\n\n\n")
  

#######################################################################################
# revenue area
figure_num = figure_num + 1

# change order of stack
topFMP$FMP <- reorder(topFMP$FMP, topFMP$yfa_rev)
topFMP$FMP <- factor(topFMP$FMP, levels=levels(topFMP$FMP))

cat("Figure ", section_num,".", figure_num, " Revenue from Most Impacted FMPs, ", broadzone, "  \n\n", sep = "")

# plot
# rp <- ggplot(topFMP, aes(x = Year, y = yfa_rev/1000000, fill = str_wrap(FMP, width = 30))) +
rp <- ggplot(topFMP, aes(x = Year, y = yfa_rev/1000000, fill = FMP)) +
  guides(fill=guide_legend(title=NULL, reverse = TRUE)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Revenue in Millions") +
  # scale_y_continuous(labels = dollar_format(prefix="$")) +
  scale_y_continuous(expand=expansion(mult=c(0, 0.1))) +
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
  ggtitle(paste0("Revenue from Most Impacted FMPs, ", broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale
if (assignedColors) {
  rp <- rp + uniquefmpScale
} else {
  rp <- rp + quantScale
}
# dispay plot
print(rp)
# if number of top 5 fmps for all areas are not the same and are more than the maximum number of colors of the RColorBrewer color palette dont use custom
# ifelse(length(unique(top5byArea$FMP)) > 12, print(rp), print(rp + colScale))
# save to file
ggsave(paste0(output_ftopfmp, "/Top5FMPRev_", substr(broadzone_underscore, 0,30),".png"), plot = rp)
# save to file - base functions
# png(paste0(output_ftopfmp,"/Top5FMPRev_",broadzone,".png"))
# print(rp)
# dev.off()
rm(rp)
# alternatively, save plot as png and call
# knitr::include_graphics("rrtools-steps-carbon.png")

# names(topFMP)
# create 5 year (all years) table
allyrrev_table <- topFMP_table %>% distinct(FMP, allyrtotal_rev) %>%
  arrange(desc(allyrtotal_rev)) %>%
  dplyr::rename("All Year Revenue" = allyrtotal_rev) %>% 
  ungroup()
# %>%  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))

# write to Excel workbook object - sheet name based on letters of area name and with area order number to differenciate incase of duplicate letters
addWorksheet(mostimpactedrev_wb, paste0("TopFMPR_", gsub(pattern="[a-z]?", replacement="", broadzone_underscore),"_",figure_num), gridLines = TRUE)
writeData(mostimpactedrev_wb, sheet = paste0("TopFMPR_", gsub(pattern="[a-z]?", replacement="", broadzone_underscore),"_",figure_num), allyrrev_table, keepNA = TRUE)

# convert fmp back to charaters - add totals row - format revenue column w/ $, commas, and rounded for estimation - *non-pipe way
allyrrev_table$FMP <- as.character(allyrrev_table$FMP)
allyrrev_table <- rbind(allyrrev_table, c("**Total**", colSums(allyrrev_table[,2])))
# allyrrev_table$`All Year Revenue` <- comma_format( prefix = "$", trim = FALSE, accuracy = 1000)(as.numeric(allyrrev_table$`All Year Revenue`))
allyrrev_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE))) < 500,"<$500", comma_format(trim = TRUE, accuracy = 1000, prefix="$")(as.numeric(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
allyrrev_table[nrow(allyrrev_table),2] <- paste0("**",allyrrev_table[nrow(allyrrev_table),2],"**")

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(allyrrev_table)[names(allyrrev_table) == "All Year Revenue"] <- paste0(numyear, " Year Revenue")

cat("\n\n")

print(kable(allyrrev_table, caption = paste0(numyear, ' Year Total Revenue for Most Impacted FMPs, ',broadzone), align=c('l', 'r')))

cat("\n\n\n\n")

}
# save workbook to file with sheets of all area
message("writing Excel Spreadsheets for Top FMPs..")
saveWorkbook(mostimpactedland_wb, file = file.path(output_ftopfmp, paste0("TopFMPLand_",project_name,".xlsx")), overwrite = TRUE)
saveWorkbook(mostimpactedrev_wb, file = file.path(output_ftopfmp, paste0("TopFMPRev_",project_name,".xlsx")), overwrite = TRUE)

##########################################################################
# rm(section_num, figure_num)


```


```{r top_fmp_summary, results='asis', eval = top_fmp_section_summary} 

section_name = "Most Impacted FMPs"
section_table <- get("topFMP_all_areas") %>% ungroup()
margin <- "FMP"

cat("<br>") 

cat("*Summary*")

if (single_area_summaries) {
  all_rev <- allyrrev_table %>% filter(.data[[margin]] == '**Total**') %>% select(-.data[[margin]])
  all_land <- allyrland_table %>% filter(.data[[margin]] =="**Total**") %>% select(-.data[[margin]])
  rev_land_total <- cbind(all_rev, all_land)
  row.names(rev_land_total) <- "**Total**"
  print(kable(rev_land_total, caption = paste0(numyear,' Year Landings and Revenue, ', section_name, ' '), align=c('r', 'r')))
} else {
  counter = 1
  for (ar in allZones) {
    if (counter == 1) {
      ar_u <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", ar)), perl=TRUE)
    allyr_table <- as_tibble(section_table %>%  
      select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%     # use .data[[margin]] to refer to column name stored as string
      filter(Area == ar_u) %>% 
      distinct(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%
      arrange(desc(allyrtotal_land)) %>%
      dplyr::select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>% 
      dplyr::rename("All Year Revenue" = allyrtotal_rev, "All Year Landings (Pounds)" = allyrtotal_land) %>% 
      mutate("{margin}" := as.character(.data[[margin]])) %>% # use '"{margin}" :=' to refer to a column as a string
      ungroup()) # have to convert to tibble to add up rows
    allyr_table <- rbind(allyr_table, c("**Total**", ar, colSums(allyr_table[,3]), colSums(allyr_table[,4])))
    allyr_table <- allyr_table %>% filter(.data[[margin]] =="**Total**")
    counter = 2
  } else {
    ar_u <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", ar)), perl=TRUE)
    allyr_table_2 <- as_tibble(section_table %>%  
      filter(Area == ar_u) %>% 
      distinct(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%
      arrange(desc(allyrtotal_land)) %>%
      dplyr::select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>% 
      dplyr::rename("All Year Revenue" = allyrtotal_rev, "All Year Landings (Pounds)" = allyrtotal_land) %>% 
      mutate("{margin}" := as.character(.data[[margin]])) %>% 
      ungroup())
    
    allyr_table_2 <- rbind(allyr_table_2, c("**Total**", ar, colSums(allyr_table_2[,3]), colSums(allyr_table_2[,4])))
    allyr_table_2 <- allyr_table_2 %>% filter(.data[[margin]] =="**Total**")
    allyr_table <- rbind(allyr_table, allyr_table_2)
    }
  }

  allyr_table <- allyr_table %>% select(-.data[[margin]]) %>% mutate(`All Year Revenue` = round(as.double(`All Year Revenue`), digits = -3)) %>% mutate(`All Year Landings (Pounds)` = round(as.double(`All Year Landings (Pounds)`), digits = -3))
  allyr_table <- rbind(allyr_table, c('**Total**', colSums(allyr_table[,2]), colSums(allyr_table[,3])))
  
  # Format columns
  allyr_table$`All Year Revenue` <- comma_format( prefix = "$", trim = FALSE, accuracy = 1000)(as.numeric(allyr_table$`All Year Revenue`))
  allyr_table$`All Year Landings (Pounds)` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyr_table$`All Year Landings (Pounds)`))
  
  # Make bottom rows bold
  allyr_table[nrow(allyr_table),2] <- paste0("**", allyr_table[nrow(allyr_table),2],"**")
  allyr_table[nrow(allyr_table),3] <- paste0("**", allyr_table[nrow(allyr_table),3],"**")
  
  # set dynamic varible names (cant use paste0 in rename in tidyverse)
  names(allyr_table)[names(allyr_table) == "Area"] <- paste0(proper(area_adjective), "Area")
  names(allyr_table)[names(allyr_table) == "All Year Revenue"] <- paste0(numyear, " Year Revenue")
  names(allyr_table)[names(allyr_table) == "All Year Landings (Pounds)"] <- paste0(numyear, " Year Landings (Pounds)")
  
  print(kable(allyr_table, caption = paste0(section_name, ' ', numyear,' Year Revenue and Landings '), align=c('l', 'r', 'r')))  
  
  }

```


```{r other_impacted_fmps_dynamic_text, results='asis', echo=FALSE, eval = T} 

# paste0(otherfmpsnames[-length(otherfmpsnames)], collapse = ", ")` 
# 
# paste0(" and ", otherfmpsnames[length(otherfmpsnames)])
# 
# paste0(" and ", otherfmpsnames[length(otherfmpsnames)])
# 
# ifelse(any(otherfmpsnames %in% "No Federal FMP"), paste0(" and “No Federal FMP.” The category “No Federal FMP” contains a variety of species that are not federally regulated, such as: lobster, Jonah crab, smooth and chain dogfish, whelk, and menhaden, (there are close to ", numsp," species without federal FMPs caught in the ", wind_area_name, "  area)."),".")
# 
# ifelse(any(otherfmpsnames %in% "All Others"), paste0(" The category \"All Others\" refers to FMPs with less than three permits impacted to protect data confidentiality. "),".")

# ifelse(any(otherfmpsnames %in% "No Federal FMP"), paste0(" and “No Federal FMP.” The category “No Federal FMP” contains a variety of species that are not federally regulated, such as: lobster, Jonah crab, smooth and chain dogfish, whelk, and menhaden, (there are close to ", numsp," species without federal FMPs caught in the ", wind_area_name, "  area)."),".")

otherfmpsnames <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(unique(fmp_merge$FMP) %notin% top_five_fmp_names), perl=TRUE)
otherfmpsnames[otherfmpsnames=="None"] <- "No Federal FMP"

```

<!-- ### Other Impacted FMPs  -->
 
<!-- We analyzed other impacted FMPs separately in order to better visualize the estimated landings and revenues. The other impacted FMPs are: `r paste0(otherfmpsnames[-length(otherfmpsnames)], collapse = ", ")`  -->
<!-- `r paste0(" and ", otherfmpsnames[length(otherfmpsnames)])`. `r ifelse(any(otherfmpsnames %in% "No Federal FMP"), paste0(" and “No Federal FMP.” The category “No Federal FMP” contains a variety of species that are not federally regulated, such as: lobster, Jonah crab, smooth and chain dogfish, whelk, and menhaden, (there are close to ", numsp," species without federal FMPs caught in the ", wind_area_name, " area)."),"")` -->
<!-- `r ifelse(any(otherfmpsnames %in% "All Others"), paste0(" The category \"All Others\" refers to FMPs with less than three permits or dealers impacted to protect data confidentiality. "),".")` `r revenue_deflation_note` `r rounded_message`  -->

```{r other_impacted_fmps, results='asis', eval = other_fmp_section} 

cat("<br> \n\n") 

cat("### Other Impacted FMPs \n")

cat("We analyzed other impacted FMPs separately in order to better visualize the estimated landings and revenues. The other impacted FMPs are: ", paste0(otherfmpsnames[-length(otherfmpsnames)], collapse = ", "), 
paste0(" and ", otherfmpsnames[length(otherfmpsnames)]),". ", ifelse(any(otherfmpsnames %in% "No Federal FMP"), paste0(" and “No Federal FMP.” The category “No Federal FMP” contains a variety of species that are not federally regulated, such as: lobster, Jonah crab, smooth and chain dogfish, whelk, and menhaden, (there are close to ", numsp," species without federal FMPs caught in the ", wind_area_name, " area)."),""), 
ifelse(any(otherfmpsnames %in% "All Others"), paste0("The category \"All Others\" refers to FMPs with less than three permits or dealers impacted to protect data confidentiality. "),"."), revenue_deflation_note, rounded_message)
 
cat("<br> ")

# We analyzed other impacted FMPs separately in order to better visualize the estimated landings and revenues. The other impacted FMPs are: Atlantic Herring, NE (Northeast); Monkfish, Joint; Skate, NE; NE Multispecies, Small; NE Multispecies, Large; Spiny Dogfish, Joint; Bluefish, Mid-Atlantic; Golden Tilefish, Mid-Atlantic; Red Crab, NE; River Herring, Joint; and Highly Migratory Species.

##########################################################################
# testing
# save_files = "n" #dont save files as csv or rdata
# save_files = "c"

# create new folder for section
dir.create(file.path(output_f, "otherfmp"), showWarnings = FALSE)
output_fotherfmp = file.path(output_f, "otherfmp")

section_num = section_num + 1
figure_num = 0

# Fix error with monkfish FMP by subtracting 227014.9999 from revenue

# Replace 'None' with pretty wording 
# REVENUEFILE$FMP[REVENUEFILE$FMP=="None"] <- "No Federal FMP"
##########################################################################
# Other FMP plot

#######################################
#### Set plot colors for other fmps ###
#######################################
# create custom color palette for all other unique FMPs 
# (length(unique(fmp_merge$FMP))-5)

# other FMPs ordered by revenue, grouped by area
# otherfmpbyArea <- fmp_merge %>% group_by(FMP, Area) %>%
#   dplyr::summarize(
#     REV = sum(yfa_rev, na.rm = T)
#     ) %>% 
#   ungroup %>% 
#   group_by(Area) %>% 
#   top_n(., n=((length(unique(fmp_merge$FMP))-5)*-1), wt=REV) %>%  #colors may not be unique if top 5 is grouped by area
#   arrange(Area, desc(REV)) %>% 
#   ungroup %>% 
#   mutate(FMP = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(FMP), perl=TRUE)) %>% 
#   mutate(FMP = if_else(FMP=="None","No Federal FMP", FMP))
# 
# NumUniqueMargins <- length(unique(otherfmpbyArea$FMP))
# 
# UniqueMargins <- unique(otherfmpbyArea$FMP)

# unique(fmp_merge$FMP) %notin% toupper(topfmp_names)

# other FMPs ordered by revenue, overall
otherfmp <- fmp_merge %>% group_by(FMP) %>%
  dplyr::summarize(
    REV = sum(yfa_rev, na.rm = T)
    ) %>% 
  ungroup %>% 
  top_n(., n=((length(unique(fmp_merge$FMP))-5)*-1), wt=REV) %>%  #colors may not be unique if top 5 is grouped by area
  arrange(desc(REV))
  # arrange(desc(REV)) %>% 
  # mutate(FMP = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(FMP), perl=TRUE)) %>% 
  # mutate(FMP = if_else(FMP=="None","No Federal FMP", FMP))

otherfmp_names_wrapped <- str_wrap(unique(otherfmp$FMP) %notin% names(topfmp_names_wrapped), width=30) # change extra long legend names - add a \n to halfway word to match plot


# NumUniqueMargins <- length(unique(otherfmp$FMP))
# 
# UniqueMargins <- str_wrap(unique(otherfmp$FMP) %notin% names(topfmpColors), width=30) # change extra long legend names - add a \n to halfway word to match plot
# 
# # unname(topfmpColors)
# # brewer.pal(brewer.pal.info[paletteName2, "maxcolors"], paletteName2)
# 
# # brewer.pal(brewer.pal.info[paletteName2, "maxcolors"], paletteName2) %notin% unname(topfmpColors)
# 
# # topfmpColors
# # otherfmpColors
# 
# myColors <- brewer.pal(NumUniqueMargins, paletteName2)
# 
# # make extra colors if more unique FMPs than maximum colors for palette
# # Note: colors may not be unique if top 5 is grouped by area
# # if (NumUniqueMargins > maxUniqueColors) {
# #   getPalette = colorRampPalette(brewer.pal(brewer.pal.info[paletteName2, "maxcolors"], paletteName2) %notin% unname(topfmpColors)) # make sure there are no colors from topfmp set of colors
# #   myColors <- getPalette(NumUniqueMargins)
# # } else {
# #   myColors <- brewer.pal(NumUniqueMargins, paletteName2) # create list of colors using number of unique FMPs from pallettte name
# # }
# 
# names(myColors) <- UniqueMargins # name colors for color scale
# 
# uniqueOtherfmpScale <- scale_fill_manual(name = NULL, values = myColors, guide = guide_legend(reverse = TRUE))
# 
# # quantOtherScale <- scale_fill_brewer(name = NULL, palette = "RdYlBu",
# #                       guide = guide_legend(reverse = TRUE))
# 
# otherfmpColors <- myColors
# 
# # unique(names(topfmpColors))
# # unique(names(otherfmpColors))
# 
# rm(NumUniqueMargins, UniqueMargins) # garbage collection




###################################################################################################

NumUniqueMargins <- length(unique(otherfmp$FMP))

UniqueMargins <- str_wrap(unique(otherfmp$FMP) %notin% names(topfmpColors), width=30) # change extra long legend names - add a \n to halfway word to match plot


# make extra colors if more unique FMPs than maximum colors for palette
if (NumUniqueMargins > maxUniqueColors) {
  getPalette = colorRampPalette(brewer.pal(maxUniqueColors, paletteName2))
  myColors <- getPalette(NumUniqueMargins)
} else {
  myColors <- brewer.pal(NumUniqueMargins, paletteName2) # create list of colors using number of unique FMPs from pallettte name
  }

names(myColors) <- UniqueMargins # name colors for color scale

# create custom color scale assigned to each fmp to use on all top fmp plots
uniqueOtherfmpScale <- scale_fill_manual(name = NULL, values = myColors, guide = guide_legend(reverse = TRUE))

otherfmpColors <- myColors

rm(NumUniqueMargins, UniqueMargins) # garbage collection




###########################################################


###################################################################################################

# uniqueOtherfmpScale <- make_color_scale(otherfmp_names_wrapped, scale_name = paletteName2, maxUniqueColors = maxUniqueColors, wrap_names = TRUE)

# original color scale based on revenue quanities
quantOtherScale <- scale_fill_brewer(name = NULL, palette = "RdYlBu", 
                    direction = -1, guide = guide_legend(reverse = TRUE))

# allColors <- append(topfmpColors, otherfmpColors)
# 
# if (length(unique(names(allColors))) != length(unique(unname(allColors))) ) {
#   warning("Some FMPs have multiple colors and will display as blank in plots")
# }

###########################################
#### Set plot colors for other fmps end ###
###########################################

# get names of all other fmp names other than top FMPs
otherfmpnames <- unique(fmp_merge$FMP) %notin% top_five_fmp_names

# get vector of all zones except "Other"
# allZones <- unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other" ]

# ### get only data for Hudson_North
# broadzone = "Fairways North"
# broadzone = "Fairways_South"
# broadzone = "Hudson_North"
# broadzone = "Hudson_South"
# replace underscores with space and capitalize each word (for plot title automation)
# broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE)

# filter fmp_merge table by other fmp names create above and fix text
otherFMP_table <- fmp_merge %>% 
  filter(FMP %in% otherfmpnames)
  # filter(FMP %in% otherfmpnames) %>% 
  # mutate(FMP = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(FMP), perl=TRUE)) %>% # make FMP names lowercase
  # mutate(FMP = if_else(FMP=="None","No Federal FMP", FMP))
# make FMP names lowercase
# otherFMP_table$FMP <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(otherFMP_table$FMP), perl=TRUE)
# otherFMP_table$FMP[otherFMP_table$FMP=="None"] <- "No Federal FMP"

# broadzone <- "Fairways South"
# weirdness fix
# rm(allZones)
# allZones <- unique(otherFMP_table$Area)

#### get rev and landing plots and tables for all zones
for (broadzone in allZones) {
  # allZones[2]
  figure_num = figure_num + 1
  # broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE) # make name pretty
  # cat("\raggedright")
  # cat(paste0("*", broadzone, "*", "  ", "\n\n"),"  ") # display name of broadzone on vignette
  # broadzone_underscore <- broadzone
  # broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", broadzone), perl=TRUE) # make spaces underscores in area
  broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", broadzone)), perl=TRUE) # make spaces underscores and backslashs as dashes in area 
  

# landings study area

  # ### get only data for Hudson_North
# broadzone = "Fairways_North"
# broadzone = "Fairways_South"
# broadzone = "Hudson_North"
# broadzone = "Hudson_South"
# replace underscores with space and capitalize each word (for plot title automation)
# broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE)


# order by revenue
# otherFMP <- left_join(tail(allYearsSum[order(-allYearsSum$InsideREV_total),], 
#                                nrow(allYearsSum[order(-allYearsSum$InsideREV_total),])-5), revland_area, by='FMP')

# filter by the area
otherFMP <- otherFMP_table %>% filter(Area == broadzone_underscore)

otherFMP_table_no_breaks <- otherFMP #create other fmp table without line breaks

# change extra long legend names - add a \n to halfway word 
otherFMP$FMP <- str_wrap(otherFMP$FMP, width=30)

# remove NA columns from dataset
otherFMP <- otherFMP %>% filter(!is.na(Year))

# change order of bar column stack
otherFMP$FMP <- reorder(otherFMP$FMP, otherFMP$yfa_land)
otherFMP$FMP <- factor(otherFMP$FMP, levels=levels(otherFMP$FMP))

# cat("\centering")
cat("Figure ", section_num,".", figure_num, " Landings from Other Impacted FMPs, ", broadzone, "  \n\n", sep = "")

# plot
# lp <- ggplot(otherFMP, aes(x = Year, y = yfa_land/1000000, fill = str_wrap(FMP, width = 30))) +
lp <- ggplot(otherFMP, aes(x = Year, y = yfa_land/1000000, fill = FMP)) +
  guides(fill=guide_legend(title=NULL, reverse = TRUE)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Millions of Pounds") +
  # scale_y_continuous() +
  scale_y_continuous(expand=expansion(mult=c(0, 0.1))) + 
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
  ggtitle(paste0(" Landings from Other Impacted FMPs, ", broadzone)) +
  # theme(text=element_text( size=10),
  #       panel.grid.major = element_line(colour="gray", size=0.5),
  #       # plot.title = element_text(hjust = 0.5, size=18))
  #       plot.title = element_text())
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),  
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())
        # panel.border = element_rect(colour = "black", size=0))
# lp

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale 
if (assignedColors) {
  lp <- lp + uniqueOtherfmpScale
} else {
  lp <- lp + quantOtherScale
}

# dispay plot
print(lp)

# save to file
ggsave(paste0(output_fotherfmp,"/OtherFMPLand_",substr(broadzone_underscore,0,30),".png"), plot = lp)
# save to file - base functions
# png(paste0(output_fotherfmp,"/Top5FMPLand_",broadzone,".png")
# print(lp)
# dev.off()
rm(lp)
# alternatively, save plot as png and call
# knitr::include_graphics("rrtools-steps-carbon.png")

# sort by landings
allyrland_table <- otherFMP_table_no_breaks %>%  
  distinct(FMP, allyrtotal_rev, allyrtotal_land) %>%
  arrange(desc(allyrtotal_land)) %>%
  # arrange(desc(allyearland_total)) %>%
  dplyr::select(FMP, allyrtotal_land) %>% 
  dplyr::rename("All Year Total" = allyrtotal_land) %>% 
  ungroup()
  
# %>%  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))
# TODO: add number to word function

allyrland_table <- as_tibble(allyrland_table)
# convert fmp back to charaters - add totals row - format Landings column w/ $, commas, and rounded for estimation - *non-pipe way
allyrland_table$FMP <- as.character(allyrland_table$FMP)
allyrland_table <- rbind(allyrland_table, c("**Total**", colSums(allyrland_table[,2])))
# allyrland_table$`All Year Total` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyrland_table$`All Year Total`))
allyrland_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE))) < 500,"<500", comma_format(trim = TRUE, accuracy = 1000)(as.numeric(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
allyrland_table[nrow(allyrland_table),2] <- paste0("**",allyrland_table[nrow(allyrland_table),2],"**")

# set dynamic varible names (cant use paste0 in rename in tidyverse)
# names(allyrland_table)[names(allyrland_table) == "All Year Total"] <- paste0(numyear, " Year Total")
names(allyrland_table)[names(allyrland_table) == "All Year Total"] <- paste0(numyear, " Year Landings")

cat("\n\n")

print(kable(allyrland_table, caption = paste0(numyear,' Year Total Landings (Pounds), Other Impacted FMP, ', broadzone), align=c('l', 'r')))
  
cat("\n\n\n\n\n\n")

#######################################################################################
# revenue study area
figure_num = figure_num + 1

rm(otherFMP)

# otherFMP <- left_join(tail(allYearsSum[order(-allYearsSum$InsideLANDED_total),], 
#                                nrow(allYearsSum[order(-allYearsSum$InsideLANDED_total),])-5), revland_area, by='FMP')

otherFMP <- otherFMP_table %>% filter(Area == broadzone_underscore)

otherFMP_table_no_breaks <- otherFMP #create other fmp table without line breaks

# change extra long legend names - add a \n to halfway word 
otherFMP$FMP <- str_wrap(otherFMP$FMP, width=30)

# remove NA columns from dataset
otherFMP <- otherFMP %>% filter(!is.na(Year))

# make FMP names lowercase
# otherFMP$FMP <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(otherFMP$FMP), perl=TRUE)
# otherFMP$FMP[otherFMP$FMP=="None"] <- "No Federal FMP"

# change order of bar column stack
otherFMP$FMP <- reorder(otherFMP$FMP, otherFMP$yfa_rev)
otherFMP$FMP <- factor(otherFMP$FMP, levels=levels(otherFMP$FMP))

cat("Figure ", section_num,".", figure_num, " Revenue from Other Impacted FMPs, ", broadzone, "  \n\n", sep = "")

# plot
# rp <- ggplot(otherFMP, aes(x = Year, y = yfa_rev/1000000, fill = str_wrap(FMP, width = 30))) +
rp <- ggplot(otherFMP, aes(x = Year, y = yfa_rev/1000000, fill = FMP)) +
  guides(fill=guide_legend(title=NULL, reverse = TRUE)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Revenue in Millions") +
  # scale_y_continuous(labels = dollar_format(prefix="$")) +
  scale_y_continuous(expand=expansion(mult=c(0, 0.1))) +
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
  ggtitle(paste0("Revenue from Other Impacted FMPs, ", broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())
  
# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale 
if (assignedColors) {
  rp <- rp + uniqueOtherfmpScale
} else { 
  rp <- rp + quantOtherScale
}
# dispay plot
print(rp)
# save to file
ggsave(paste0(output_fotherfmp, "/OtherFMPRev_", substr(broadzone_underscore,0,30),".png"), plot = rp)
# save to file - base functions
# png(paste0(output_fotherfmp,"/Top5FMPRev_",broadzone,".png"))
# print(rp)
# dev.off()
rm(rp)
# alternatively, save plot as png and call
# knitr::include_graphics("rrtools-steps-carbon.png")

# names(otherFMP)
# create 5 year (all years) table
allyrrev_table <- otherFMP_table_no_breaks %>% distinct(FMP, allyrtotal_rev) %>%
  arrange(desc(allyrtotal_rev)) %>%
  dplyr::rename("All Year Revenue" = allyrtotal_rev) %>% 
  ungroup()

# %>%  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))

allyrrev_table <- as_tibble(allyrrev_table)

# convert fmp back to charaters - add totals row - format revenue column w/ $, commas, and rounded for estimation - *non-pipe way
allyrrev_table$FMP <- as.character(allyrrev_table$FMP)
allyrrev_table <- rbind(allyrrev_table, c("**Total**", colSums(allyrrev_table[,2])))
# allyrrev_table$`All Year Revenue` <- comma_format( prefix = "$", trim = FALSE, accuracy = 1000)(as.numeric(allyrrev_table$`All Year Revenue`))
allyrrev_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE))) < 500,"<$500", comma_format(trim = TRUE, accuracy = 1000, prefix="$")(as.numeric(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
allyrrev_table[nrow(allyrrev_table),2] <- paste0("**",allyrrev_table[nrow(allyrrev_table),2],"**")

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(allyrrev_table)[names(allyrrev_table) == "All Year Revenue"] <- paste0(numyear, " Year Revenue")

cat("\n\n")

print(kable(allyrrev_table, caption = paste0(numyear, ' Year Total Revenue for Other Impacted FMPs, ',broadzone), align=c('l', 'r')))

cat("\n\n\n\n")

}

##########################################################################
# rm(allZones)
# allZones <- unique(otherFMP_table$Area)
# allZones <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("_"," ", allZones), perl=TRUE)

```

```{r other_fmp_summary, results='asis', eval = other_fmp_section_summary} 

section_name = "Other Impacted FMPs"
section_table <- get("otherFMP_table") %>% ungroup()
margin <- "FMP"

cat("<br>") 

cat("*Summary*")

if (single_area_summaries) {
  all_rev <- allyrrev_table %>% filter(.data[[margin]] == '**Total**') %>% select(-.data[[margin]])
  all_land <- allyrland_table %>% filter(.data[[margin]] =="**Total**") %>% select(-.data[[margin]])
  rev_land_total <- cbind(all_rev, all_land)
  row.names(rev_land_total) <- "**Total**"
  print(kable(rev_land_total, caption = paste0(numyear,' Year Landings and Revenue, ', section_name, ' '), align=c('r', 'r')))
} else {
  counter = 1
  for (ar in allZones) {
    if (counter == 1) {
      ar_u <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", ar)), perl=TRUE)
    allyr_table <- as_tibble(section_table %>%  
      select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%     # use .data[[margin]] to refer to column name stored as string
      filter(Area == ar_u) %>% 
      distinct(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%
      arrange(desc(allyrtotal_land)) %>%
      dplyr::select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>% 
      dplyr::rename("All Year Revenue" = allyrtotal_rev, "All Year Landings (Pounds)" = allyrtotal_land) %>% 
      mutate("{margin}" := as.character(.data[[margin]])) %>% # use '"{margin}" :=' to refer to a column as a string
      ungroup()) # have to convert to tibble to add up rows
    allyr_table <- rbind(allyr_table, c("**Total**", ar, colSums(allyr_table[,3]), colSums(allyr_table[,4])))
    allyr_table <- allyr_table %>% filter(.data[[margin]] =="**Total**")
    counter = 2
  } else {
    ar_u <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", ar)), perl=TRUE)
    allyr_table_2 <- as_tibble(section_table %>%  
      filter(Area == ar_u) %>% 
      distinct(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%
      arrange(desc(allyrtotal_land)) %>%
      dplyr::select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>% 
      dplyr::rename("All Year Revenue" = allyrtotal_rev, "All Year Landings (Pounds)" = allyrtotal_land) %>% 
      mutate("{margin}" := as.character(.data[[margin]])) %>% 
      ungroup())
    
    allyr_table_2 <- rbind(allyr_table_2, c("**Total**", ar, colSums(allyr_table_2[,3]), colSums(allyr_table_2[,4])))
    allyr_table_2 <- allyr_table_2 %>% filter(.data[[margin]] =="**Total**")
    allyr_table <- rbind(allyr_table, allyr_table_2)
    }
  }

  allyr_table <- allyr_table %>% select(-.data[[margin]]) %>% mutate(`All Year Revenue` = round(as.double(`All Year Revenue`), digits = -3)) %>% mutate(`All Year Landings (Pounds)` = round(as.double(`All Year Landings (Pounds)`), digits = -3))
  allyr_table <- rbind(allyr_table, c('**Total**', colSums(allyr_table[,2]), colSums(allyr_table[,3])))
  
  # Format columns
  allyr_table$`All Year Revenue` <- comma_format( prefix = "$", trim = FALSE, accuracy = 1000)(as.numeric(allyr_table$`All Year Revenue`))
  allyr_table$`All Year Landings (Pounds)` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyr_table$`All Year Landings (Pounds)`))
  
  # Make bottom rows bold
  allyr_table[nrow(allyr_table),2] <- paste0("**", allyr_table[nrow(allyr_table),2],"**")
  allyr_table[nrow(allyr_table),3] <- paste0("**", allyr_table[nrow(allyr_table),3],"**")
  
  # set dynamic varible names (cant use paste0 in rename in tidyverse)
  names(allyr_table)[names(allyr_table) == "Area"] <- paste0(proper(area_adjective), "Area")
  names(allyr_table)[names(allyr_table) == "All Year Revenue"] <- paste0(numyear, " Year Revenue")
  names(allyr_table)[names(allyr_table) == "All Year Landings (Pounds)"] <- paste0(numyear, " Year Landings (Pounds)")
  
  print(kable(allyr_table, caption = paste0(section_name, ' ', numyear,' Year Revenue and Landings '), align=c('l', 'r', 'r')))  
  
  }



```


```{r top_species_dynamic_text, results='asis', eval = top_species_section} 

#############################
###### Set Top Species ######
#############################

pii_all_yr_area_top_species <- subset(REVENUEFILE, !is.na(SPPNM)) %>% 
  # dplyr::select(SPPNM, InsideREV, InsideLANDED, PERMIT, Area ) %>% 
  dplyr::select(SPPNM, InsideREV, InsideLANDED, PERMIT, Area, DEALNUM) %>% 
  filter(Area != "Other") %>% 
  group_by(SPPNM) %>% 
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 =  ndealers < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(SPPNM_CONF = ifelse(CONF == T, 'All Others', SPPNM)) %>%
  ungroup() %>%
  group_by(SPPNM_CONF) %>%
  dplyr::summarize(
    yfa_rev = sum(InsideREV, na.rm = T),
    yfa_land = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T),
    ndealers = sum(ndealers, na.rm = T)
    ) %>% 
  dplyr::rename("Species"= SPPNM_CONF) %>% 
  arrange(desc(yfa_rev)) %>% 
  top_n(n=number_of_top_species, wt=yfa_rev) %>% 
  pull(Species)
  
top_species_names <- str_to_title(pii_all_yr_area_top_species)
top_species_names <- paste0(paste0(top_species_names %notin% tail(top_species_names, n=1), collapse = ", ") , " and ", tail(top_species_names, n=1))

```

```{r top_species, results='asis', eval = top_species_section} 

cat("<br> \n\n") 

cat("### Most Impacted Species \n")

cat("We analyzed the top ", number_of_top_species, " species due to their economic importance in the area and to isolate them from combined FMPs. The top ", number_of_top_species," species by revenue are: ", top_species_names,". The category \"All Others\" refers to species with less than three permits or dealers impacted to protect data confidentiality.", revenue_deflation_note," ", rounded_message, "\n\n\n ") 

cat("<br> ")

##########################################################################
# testing
# save_files = "n" #dont save files as csv or rdata
# save_files = "c"

# create new folder for section
dir.create(file.path(output_f, "topspecies"), showWarnings = FALSE)
output_ftopspecies = file.path(output_f, "topspecies")

# For figure numbering
section_num = section_num + 1 
figure_num = 0

#############################
###### Set Top Species ######
#############################

pii_all_yr_area_top_species <- subset(REVENUEFILE, !is.na(SPPNM)) %>%
  dplyr::select(SPPNM, Area, Year, InsideREV, InsideLANDED, PERMIT, DEALNUM) %>%
  filter(Area != "Other") %>%
  group_by(SPPNM, Year, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(SPPNM_CONF = ifelse(CONF == T, 'All Others', SPPNM)) %>%
  ungroup() %>%
  group_by(Year, SPPNM_CONF, Area) %>% 
  dplyr::summarize(
    yfa_rev = sum(InsideREV, na.rm = T),
    yfa_land = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T),
    ndealers = sum(ndealers, na.rm = T)
    ) %>% 
  dplyr::rename("Species"= SPPNM_CONF) %>% 
  dplyr::select(Species, Year, Area, yfa_rev, yfa_land) %>% 
  group_by(Species, Area) %>% 
  dplyr::summarize(
    allyrtotal_rev = sum(yfa_rev, na.rm = T),
    allyrtotal_land = sum(yfa_land, na.rm = T)) %>% 
  arrange(desc(allyrtotal_rev)) %>% 
  ungroup() %>% 
  top_n(n=number_of_top_species, wt=allyrtotal_rev) %>% 
  pull(Species)
  
#################################
###### Set Top Species end ######
#################################

#############################################################
#### Create Dataframe of Select Species with PII Removed ####
#############################################################

# PII fixed for all areas
piispecies <- subset(REVENUEFILE, !is.na(SPPNM)) %>%
  dplyr::select(SPPNM, Area, Year, InsideREV, InsideLANDED, PERMIT, DEALNUM) %>%
  filter(Area != "Other") %>% 
  # filter(SPPNM %in% selectSpecies) %>%
  filter(SPPNM %in% pii_all_yr_area_top_species) %>%
  group_by(SPPNM, Year, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 =  ndealers < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(SPPNM_CONF = ifelse(CONF == T, 'All Others', SPPNM)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("SPPNM")) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, npermits, SPPNM_CONF) %>%
  group_by(SPPNM_CONF, Year, Area) %>%
  dplyr::summarize(
    yfa_rev = sum(InsideREV, na.rm = T),
    yfa_land = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T),
    ndealers = sum(ndealers, na.rm = T)) %>% 
  dplyr::rename("Species"= SPPNM_CONF)

speciesallyr_total <- piispecies %>% dplyr::select(Species, Year, Area, yfa_rev, yfa_land) %>% 
  group_by(Species, Area) %>% 
  dplyr::summarize(
    allyrtotal_rev = sum(yfa_rev, na.rm = T),
    allyrtotal_land = sum(yfa_land, na.rm = T)
  )

# species_merge <- merge(piispecies, speciesallyr_total, by = c("Species", "Area"))
# keep as tibble - use dplyr functions insead of base
species_merge <- left_join(piispecies, speciesallyr_total, by = c("Species", "Area"))

# Fix error with monkfish FMP by subtracting 227014.9999 from revenue
# PIISPPNMAllYears[which(PIISPPNMAllYears$FMP == 'MONKFISH JOINT'),"InsideREV_total"] <- PIISPPNMAllYears[which(PIISPPNMAllYears$FMP=='MONKFISH JOINT'),"InsideREV_total"]-227014.9999

#################################################################
#### Create Dataframe of Select Species with PII Removed end ####
#################################################################

############################################
#### Set plot colors for select species ####
############################################
# create custom color palette for all other unique FMPs 
# (length(unique(species_merge$FMP))-5)
selectSpeciesbyArea <- species_merge %>% 
  group_by(Species, Area) %>%
  dplyr::summarize(
    REV = sum(yfa_rev, na.rm = T)
    ) %>% 
  ungroup %>% 
  group_by(Area) %>% 
  # top_n(., n=((length(unique(species_merge$Species))-5)*-1), wt=REV) %>% 
  arrange(Area, desc(REV)) %>% 
  ungroup %>% 
  mutate(Species = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(Species), perl=TRUE))

# count of number of unique Species between each area
uniqueTopSpeciesScale <- make_color_scale(selectSpeciesbyArea$Species, maxUniqueColors = maxUniqueColors)

# original color scale based on revenue quanities
quantSpeciesScale <- scale_fill_brewer(name = NULL, palette = "RdYlBu",
                                     direction = -1, guide = guide_legend(reverse = TRUE))

# rm(NumUniqueMargins, UniqueMargins) # garbage collection

################################################
#### Set plot colors for select species end ####
################################################

# Replace 'None' with pretty wording 
# REVENUEFILE$FMP[REVENUEFILE$FMP=="None"] <- "No Federal FMP"

# get vector of all zones except "Other"
# allZones <- unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other" ]

# ### get only data for Hudson_North
# broadzone = "Fairways North"
# broadzone = "Fairways_South"
# broadzone = "Hudson_North"
# broadzone = "Hudson_South"
# replace underscores with space and capitalize each word (for plot title automation)
# broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE)


#### get rev and landing plots and tables for all zones
for (broadzone in allZones) {
  figure_num = figure_num + 1
  # broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE) # make name pretty
  # cat("\raggedright")
  # cat(paste0("*", broadzone, "*", "  ", "\n\n"),"  ") # display name of broadzone on vignette
  # broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", broadzone), perl=TRUE) # make spaces underscores in area
  broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", broadzone)), perl=TRUE) # make spaces underscores and backslashs as dashes in area

###################################################################
# landings plot and table

# filter by area
sSpeciesArea <- species_merge %>% filter(Area == broadzone_underscore)

# make Species names lowercase
sSpeciesArea$Species <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(sSpeciesArea$Species), perl=TRUE)
# sSpeciesArea$Species[sSpeciesArea$Species=="None"] <- "No Federal FMP"

# change order of stack
sSpeciesArea$Species <- reorder(sSpeciesArea$Species, sSpeciesArea$yfa_land)
sSpeciesArea$Species <- factor(sSpeciesArea$Species, levels=levels(sSpeciesArea$Species))

# sSpeciesArea$Species <- reorder(sSpeciesArea$Species, sSpeciesArea$sum_rev)
# sSpeciesArea$Species <- factor(sSpeciesArea$Species, levels=levels(sSpeciesArea$Species))

# cat("\centering")
cat("Figure ", section_num,".", figure_num, " Landings of Top Species, ", broadzone, "  \n\n", sep = "")

# plot
lp <- ggplot(sSpeciesArea, aes(x = Year, y = yfa_land/1000000, fill=Species)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Millions of Pounds") +
  # scale_y_continuous() +
  scale_y_continuous(expand=expansion(mult=c(0, 0.1))) + 
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
  ggtitle(paste0(" Landings of Top Species, ",broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale 
if (assignedColors) {
  lp <- lp + uniqueTopSpeciesScale
} else {
  lp <- lp + quantSpeciesScale
}
# dispay plot
print(lp)

# save to file
ggsave(paste0(output_ftopspecies,"/TopSpeciesLand_", substr(broadzone_underscore,0,30),".png"), plot = lp)
# save to file - base functions
# png(paste0(output_fselectspecies,"/SpeciesLand_",broadzone,".png"))
# print(lp)
# dev.off()
rm(lp)
# alternatively, save plot as png and call
# knitr::include_graphics("rrtools-steps-carbon.png")

# sort by landings
allyrland_table <- subset(sSpeciesArea, select = -Year ) %>%  
  # select(Species, allyrtotal_rev, allyrtotal_land) %>% 
  distinct(Species, allyrtotal_rev, allyrtotal_land) %>%
  arrange(desc(allyrtotal_land)) %>%
  # arrange(desc(allyearland_total)) %>%
  dplyr::select(Species, allyrtotal_land) %>% 
  dplyr::rename("All Year Total" = allyrtotal_land) %>% 
  ungroup()
  
# %>%  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))
# TODO: add number to word function

# convert fmp back to charaters - add totals row - format Landings column w/ $, commas, and rounded for estimation - *non-pipe way
allyrland_table$Species <- as.character(allyrland_table$Species)
allyrland_table <- rbind(allyrland_table, c("**Total**", colSums(allyrland_table[,2]))) # allyrland_table must be a tibble and without year column for this to work
# allyrland_table$`All Year Total` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyrland_table$`All Year Total`))
allyrland_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE))) < 500,"<500", comma_format(trim = TRUE, accuracy = 1000)(as.numeric(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
allyrland_table[nrow(allyrland_table),2] <- paste0("**",allyrland_table[nrow(allyrland_table),2],"**")

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(allyrland_table)[names(allyrland_table) == "All Year Total"] <- paste0(numyear, " Year Landings")

cat("\n\n")

print(kable(allyrland_table, caption = paste0(numyear,' Year Total Landings (Pounds), Most Impacted Species, ',broadzone), align=c('l', 'r')))
  
cat("\n\n\n\n\n\n")
  
###################################################################
# revenue plot and table
figure_num = figure_num + 1

rm(sSpeciesArea)

sSpeciesArea <- species_merge %>% filter(Area == broadzone_underscore)

# make FMP names lowercase
sSpeciesArea$Species <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(sSpeciesArea$Species), perl=TRUE)
# sSpeciesArea$Species[sSpeciesArea$Species=="None"] <- "No Federal FMP"

# change order of stack
sSpeciesArea$Species <- reorder(sSpeciesArea$Species, sSpeciesArea$yfa_rev)
sSpeciesArea$Species <- factor(sSpeciesArea$Species, levels=levels(sSpeciesArea$Species))

cat("Figure ", section_num,".", figure_num, " Revenue from Most Impacted Species, ", broadzone, "  \n\n", sep = "")

# plot
rp <- ggplot(sSpeciesArea, aes(x = Year, y = yfa_rev/1000000, fill=Species)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Revenue in Millions") +
  # scale_y_continuous(labels = dollar_format(prefix="$")) +
  scale_y_continuous(expand=expansion(mult=c(0, 0.1))) +
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
  ggtitle(paste0("Revenue from Most Impacted Species, ", broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale 
if (assignedColors) {
  rp <- rp + uniqueTopSpeciesScale
} else {
  rp <- rp + quantSpeciesScale
}
# dispay plot
print(rp)
# save to file
ggsave(paste0(output_ftopspecies, "/TopSpeciesRev_", substr(broadzone_underscore,0,30),".png"), plot = rp)
# save to file - base functions
# png(paste0(output_ftopspecies,"/OtherSpeciesRev_",broadzone,".png"))
# print(rp)
# dev.off()
rm(rp)
# alternatively, save plot as png and call
# knitr::include_graphics("rrtools-steps-carbon.png")

##########################################################################

# sort by revenue
allyrrev_table <- subset(sSpeciesArea, select = -Year ) %>%  
  # select(Species, allyrtotal_rev, allyrtotal_land) %>% 
  distinct(Species, allyrtotal_rev) %>%
  arrange(desc(allyrtotal_rev)) %>%
  # arrange(desc(allyearland_total)) %>%
  dplyr::select(Species, allyrtotal_rev) %>% 
  dplyr::rename("All Year Total" = allyrtotal_rev) %>% 
  ungroup()
  
# %>%  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))
# TODO: add number to word function

# convert fmp back to charaters - add totals row - format Landings column w/ $, commas, and rounded for estimation - *non-pipe way
allyrrev_table$Species <- as.character(allyrrev_table$Species)
allyrrev_table <- rbind(allyrrev_table, c("**Total**", colSums(allyrrev_table[,2]))) # allyrrev_table must be a tibble and without year column for this to work
allyrrev_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE))) < 500,"<$500", comma_format(trim = TRUE, accuracy = 1000, prefix="$")(as.numeric(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
allyrrev_table[nrow(allyrrev_table),2] <- paste0("**",allyrrev_table[nrow(allyrrev_table),2],"**")

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(allyrrev_table)[names(allyrrev_table) == "All Year Total"] <- paste0(numyear, " Year Revenue")

cat("\n\n")

print(kable(allyrrev_table, caption = paste0(numyear, ' Year Total Revenue, Most Impacted Species, ', broadzone), align=c('l', 'r')))
  
cat("\n\n\n\n\n\n")

}


```

```{r top_species_summary, results='asis', eval = top_species_section_summary} 

section_name = "Most Impacted Species"
section_table <- get("species_merge") %>% ungroup()
margin <- "Species"

cat("<br>") 

cat("*Summary*")

if (single_area_summaries) {
  all_rev <- allyrrev_table %>% filter(.data[[margin]] == '**Total**') %>% select(-.data[[margin]])
  all_land <- allyrland_table %>% filter(.data[[margin]] =="**Total**") %>% select(-.data[[margin]])
  rev_land_total <- cbind(all_rev, all_land)
  row.names(rev_land_total) <- "**Total**"
  print(kable(rev_land_total, caption = paste0(numyear,' Year Landings and Revenue, ', section_name, ' '), align=c('r', 'r')))
} else {
  counter = 1
  for (ar in allZones) {
    if (counter == 1) {
      ar_u <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", ar)), perl=TRUE)
    allyr_table <- as_tibble(section_table %>%  
      select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%     # use .data[[margin]] to refer to column name stored as string
      filter(Area == ar_u) %>% 
      distinct(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%
      arrange(desc(allyrtotal_land)) %>%
      dplyr::select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>% 
      dplyr::rename("All Year Revenue" = allyrtotal_rev, "All Year Landings (Pounds)" = allyrtotal_land) %>% 
      mutate("{margin}" := as.character(.data[[margin]])) %>% # use '"{margin}" :=' to refer to a column as a string
      ungroup()) # have to convert to tibble to add up rows
    allyr_table <- rbind(allyr_table, c("**Total**", ar, colSums(allyr_table[,3]), colSums(allyr_table[,4])))
    allyr_table <- allyr_table %>% filter(.data[[margin]] =="**Total**")
    counter = 2
  } else {
    ar_u <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", ar)), perl=TRUE)
    allyr_table_2 <- as_tibble(section_table %>%  
      filter(Area == ar_u) %>% 
      distinct(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%
      arrange(desc(allyrtotal_land)) %>%
      dplyr::select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>% 
      dplyr::rename("All Year Revenue" = allyrtotal_rev, "All Year Landings (Pounds)" = allyrtotal_land) %>% 
      mutate("{margin}" := as.character(.data[[margin]])) %>% 
      ungroup())
    
    allyr_table_2 <- rbind(allyr_table_2, c("**Total**", ar, colSums(allyr_table_2[,3]), colSums(allyr_table_2[,4])))
    allyr_table_2 <- allyr_table_2 %>% filter(.data[[margin]] =="**Total**")
    allyr_table <- rbind(allyr_table, allyr_table_2)
    }
  }

  allyr_table <- allyr_table %>% select(-.data[[margin]]) %>% mutate(`All Year Revenue` = round(as.double(`All Year Revenue`), digits = -3)) %>% mutate(`All Year Landings (Pounds)` = round(as.double(`All Year Landings (Pounds)`), digits = -3))
  allyr_table <- rbind(allyr_table, c('**Total**', colSums(allyr_table[,2]), colSums(allyr_table[,3])))
  
  # Format columns
  allyr_table$`All Year Revenue` <- comma_format( prefix = "$", trim = FALSE, accuracy = 1000)(as.numeric(allyr_table$`All Year Revenue`))
  allyr_table$`All Year Landings (Pounds)` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyr_table$`All Year Landings (Pounds)`))
  
  # Make bottom rows bold
  allyr_table[nrow(allyr_table),2] <- paste0("**", allyr_table[nrow(allyr_table),2],"**")
  allyr_table[nrow(allyr_table),3] <- paste0("**", allyr_table[nrow(allyr_table),3],"**")
  
  # set dynamic varible names (cant use paste0 in rename in tidyverse)
  names(allyr_table)[names(allyr_table) == "Area"] <- paste0(proper(area_adjective), "Area")
  names(allyr_table)[names(allyr_table) == "All Year Revenue"] <- paste0(numyear, " Year Revenue")
  names(allyr_table)[names(allyr_table) == "All Year Landings (Pounds)"] <- paste0(numyear, " Year Landings (Pounds)")
  
  print(kable(allyr_table, caption = paste0(section_name, ' ', numyear,' Year Revenue and Landings '), align=c('l', 'r', 'r')))  
  
  }


```


```{r select_species_dynamic_text, results='asis', eval = select_species_section} 

################################
###### Set Select Species ######
################################

select_species_names <- str_to_title(selectSpecies)
select_species_names <- paste0(paste0(select_species_names %notin% tail(select_species_names, n=1), collapse = ", ") , " and ", tail(select_species_names, n=1))

```

```{r select_species, results='asis', eval = select_species_section} 
cat("<br> \n\n")

cat("### Select Species \n") 

cat("We analyzed select species due to their economic importance in the area and to isolate them from combined FMPs. The select species are: ", select_species_names,". The category \"All Others\" refers to species with less than three permits or dealers impacted to protect data confidentiality. ", revenue_deflation_note, " ", rounded_message, "\n\n\n") 

cat("<br>")

########################################################################## 
# testing
# save_files = "n" #dont save files as csv or rdata
# save_files = "c"

# create new folder for section
dir.create(file.path(output_f, "selectspecies"), showWarnings = FALSE)
output_fselectspecies = file.path(output_f, "selectspecies")

# For figure numbering
section_num = section_num + 1 
figure_num = 0
 
############################
#### Set Select Species ####
############################
# Select Species plot
# Select Species: Black Sea Bass, Butterfish, Lobster, Atlantic Mackerel, Ocean Quahog, Scup, Squids, and Summer Flounder. 
# data equivelent:
# tolower(sort(unique(REVENUEFILE$SPPNM)))
# gsub(',','" "',"Black Sea Bass, Butterfish, Lobster, Atlantic Mackerel, Ocean Quahog, Scup, Squids, and Summer Flounder")
# c("Black Sea Bass", "Butterfish", "Lobster", "Atlantic Mackerel", "Ocean Quahog", "Scup", "Squids", "Summer Flounder")
# all species in rev file
# sort(unique(REVENUEFILE$SPPNM))

# selectSpecies <- c("SEA BASS, BLACK", "BUTTERFISH", "LOBSTER" , "MACKEREL, ATLANTIC", "OCEAN QUAHOG", 
#                    "SCUP", "SQUID (ILLEX)", "FLOUNDER, SUMMER", "INSHORE LONGFIN SQUID")

# sort(unique(REVENUEFILE$SPPNM))[sort(unique(REVENUEFILE$SPPNM)) %in% selectSpecies] # quick check for accuracy
# species_list <- sort(unique(SPECIES$SPPNM))
################################
#### Set Select Species end ####
################################

#############################################################
#### Create Dataframe of Select Species with PII Removed ####
#############################################################

# PII fixed for all areas
piispecies <- subset(REVENUEFILE, !is.na(SPPNM)) %>%
  # dplyr::select(SPPNM, Year, InsideREV, InsideLANDED, PERMIT, Area ) %>%
  dplyr::select(SPPNM, Year, InsideREV, InsideLANDED, PERMIT, Area, DEALNUM) %>% # for dealers
  filter(Area != "Other") %>% 
  filter(SPPNM %in% selectSpecies) %>%
  group_by(SPPNM, Year, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 =  ndealers < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(SPPNM_CONF = ifelse(CONF == T, 'All Others', SPPNM)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("SPPNM")) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, npermits, SPPNM_CONF) %>%
  group_by(SPPNM_CONF, Year, Area) %>%
  dplyr::summarize(
    yfa_rev = sum(InsideREV, na.rm = T),
    yfa_land = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T),
    ndealers = sum(ndealers, na.rm = T)
    ) %>% 
  dplyr::rename("Species"= SPPNM_CONF)

speciesallyr_total <- piispecies %>% dplyr::select(Species, Year, Area, yfa_rev, yfa_land) %>% 
  group_by(Species, Area) %>% 
  dplyr::summarize(
    allyrtotal_rev = sum(yfa_rev, na.rm = T),
    allyrtotal_land = sum(yfa_land, na.rm = T)
  )

# species_merge <- merge(piispecies, speciesallyr_total, by = c("Species", "Area"))
# keep as tibble - use dplyr functions insead of base
species_merge <- left_join(piispecies, speciesallyr_total, by = c("Species", "Area"))

# Fix error with monkfish FMP by subtracting 227014.9999 from revenue
# PIISPPNMAllYears[which(PIISPPNMAllYears$FMP == 'MONKFISH JOINT'),"InsideREV_total"] <- PIISPPNMAllYears[which(PIISPPNMAllYears$FMP=='MONKFISH JOINT'),"InsideREV_total"]-227014.9999

#################################################################
#### Create Dataframe of Select Species with PII Removed end ####
#################################################################

############################################
#### Set plot colors for select species ####
############################################
# create custom color palette for all other unique FMPs 
# (length(unique(species_merge$FMP))-5)
selectSpeciesbyArea <- species_merge %>% group_by(Species, Area) %>%
  dplyr::summarize(
    REV = sum(yfa_rev, na.rm = T)
    ) %>% 
  ungroup %>% 
  group_by(Area) %>% 
  # top_n(., n=((length(unique(species_merge$Species))-5)*-1), wt=REV) %>% 
  arrange(Area, desc(REV)) %>% 
  ungroup %>% 
  mutate(Species = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(Species), perl=TRUE))

# count of number of unique Species between each area
# selectSpeciesbyArea <- within(selectSpeciesbyArea, { count <- ave(Area, Species, FUN=function(x) length(unique(x)))})
# pull(selectSpeciesbyArea[selectSpeciesbyArea$count==1,"Species"]) # get vector of Species not shared by all areas



# NumUniqueMargins <- length(unique(selectSpeciesbyArea$Species))
# 
# UniqueMargins <- unique(selectSpeciesbyArea$Species)
# 
# # make extra colors if more unique Speciess than maximum colors for palette
# if (NumUniqueMargins > maxUniqueColors) {
#   getPalette = colorRampPalette(brewer.pal(maxUniqueColors, paletteName3))
#   myColors <- getPalette(NumUniqueMargins) 
# } else {
#   myColors <- brewer.pal(NumUniqueMargins, paletteName3) # create list of colors using number of unique Speciess from pallettte name
# }
# 
# names(myColors) <- UniqueMargins # name colors for color scale
# 
# uniqueSelectSpeciesScale <- scale_fill_manual(name = NULL, values = myColors, guide = guide_legend(reverse = TRUE))


uniqueSelectSpeciesScale <- make_color_scale(selectSpeciesbyArea$Species, maxUniqueColors = maxUniqueColors)

# original color scale based on revenue quanities
quantSpeciesScale <- scale_fill_brewer(name = NULL, palette = "RdYlBu",
                                     direction = -1, guide = guide_legend(reverse = TRUE))

# rm(NumUniqueMargins, UniqueMargins) # garbage collection

################################################
#### Set plot colors for select species end ####
################################################

# Replace 'None' with pretty wording 
# REVENUEFILE$FMP[REVENUEFILE$FMP=="None"] <- "No Federal FMP"

# get vector of all zones except "Other"
# allZones <- unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other" ]

# ### get only data for Hudson_North
# broadzone = "Fairways North"
# broadzone = "Fairways_South"
# broadzone = "Hudson_North"
# broadzone = "Hudson_South"
# replace underscores with space and capitalize each word (for plot title automation)
# broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE)


#### get rev and landing plots and tables for all zones
for (broadzone in allZones) {
  figure_num = figure_num + 1
  # broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE) # make name pretty
  # cat("\raggedright")
  # cat(paste0("*", broadzone, "*", "  ", "\n\n"),"  ") # display name of broadzone on vignette
  # broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", broadzone), perl=TRUE) # make spaces underscores in area
  broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", broadzone)), perl=TRUE) # make spaces underscores and backslashs as dashes in area

###################################################################
# landings plot and table

# filter by area
sSpeciesArea <- species_merge %>% filter(Area == broadzone_underscore)

# make Species names lowercase
sSpeciesArea$Species <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(sSpeciesArea$Species), perl=TRUE)
# sSpeciesArea$Species[sSpeciesArea$Species=="None"] <- "No Federal FMP"

# change order of stack
sSpeciesArea$Species <- reorder(sSpeciesArea$Species, sSpeciesArea$yfa_land)
sSpeciesArea$Species <- factor(sSpeciesArea$Species, levels=levels(sSpeciesArea$Species))

# sSpeciesArea$Species <- reorder(sSpeciesArea$Species, sSpeciesArea$sum_rev)
# sSpeciesArea$Species <- factor(sSpeciesArea$Species, levels=levels(sSpeciesArea$Species))

# cat("\centering")
cat("Figure ", section_num,".", figure_num, " Landings of Select Species, ", broadzone, "  \n\n", sep = "")

# plot
lp <- ggplot(sSpeciesArea, aes(x = Year, y = yfa_land/1000000, fill=Species)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Millions of Pounds") +
  # scale_y_continuous() +
  scale_y_continuous(expand=expansion(mult=c(0, 0.1))) + 
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
  ggtitle(paste0(" Landings of Select Species, ",broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale 
if (assignedColors) {
  lp <- lp + uniqueSelectSpeciesScale
} else {
  lp <- lp + quantSpeciesScale
}
# dispay plot
print(lp)

# save to file
ggsave(paste0(output_fselectspecies,"/SelectSpeciesLand_",substr(broadzone_underscore,0,30),".png"), plot = lp)
# save to file - base functions
# png(paste0(output_fselectspecies,"/SpeciesLand_",broadzone,".png"))
# print(lp)
# dev.off()
rm(lp)
# alternatively, save plot as png and call
# knitr::include_graphics("rrtools-steps-carbon.png")

# sort by landings
allyrland_table <- subset(sSpeciesArea, select = -Year ) %>%  
  # select(Species, allyrtotal_rev, allyrtotal_land) %>% 
  distinct(Species, allyrtotal_rev, allyrtotal_land) %>%
  arrange(desc(allyrtotal_land)) %>%
  # arrange(desc(allyearland_total)) %>%
  dplyr::select(Species, allyrtotal_land) %>% 
  dplyr::rename("All Year Total" = allyrtotal_land) %>% 
  ungroup()
  
# %>%  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))
# TODO: add number to word function

# convert fmp back to charaters - add totals row - format Landings column w/ $, commas, and rounded for estimation - *non-pipe way
allyrland_table$Species <- as.character(allyrland_table$Species)
allyrland_table <- rbind(allyrland_table, c("**Total**", colSums(allyrland_table[,2]))) # allyrland_table must be a tibble and without year column for this to work
# allyrland_table$`All Year Total` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyrland_table$`All Year Total`))
allyrland_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE))) < 500,"<500", comma_format(trim = TRUE, accuracy = 1000)(as.numeric(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
allyrland_table[nrow(allyrland_table),2] <- paste0("**",allyrland_table[nrow(allyrland_table),2],"**")

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(allyrland_table)[names(allyrland_table) == "All Year Total"] <- paste0(numyear, " Year Total")

cat("\n\n")

print(kable(allyrland_table, caption = paste0(numyear,' Year Total Landings (Pounds), Select Species, ',broadzone), align=c('l', 'r')))
  
cat("\n\n\n\n\n\n")
  
###################################################################
# revenue plot and table
figure_num = figure_num + 1

rm(sSpeciesArea)

sSpeciesArea <- species_merge %>% filter(Area == broadzone_underscore)

# make FMP names lowercase
sSpeciesArea$Species <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(sSpeciesArea$Species), perl=TRUE)
# sSpeciesArea$Species[sSpeciesArea$Species=="None"] <- "No Federal FMP"

# change order of stack
sSpeciesArea$Species <- reorder(sSpeciesArea$Species, sSpeciesArea$yfa_rev)
sSpeciesArea$Species <- factor(sSpeciesArea$Species, levels=levels(sSpeciesArea$Species))

cat("Figure ", section_num,".", figure_num, " Revenue from Select Species, ", broadzone, "  \n\n", sep = "")

# plot
rp <- ggplot(sSpeciesArea, aes(x = Year, y = yfa_rev/1000000, fill=Species)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Revenue in Millions") +
  # scale_y_continuous(labels = dollar_format(prefix="$")) +
  scale_y_continuous(expand=expansion(mult=c(0, 0.1))) +
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
  ggtitle(paste0("Revenue from Select Species, ", broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale 
if (assignedColors) {
  rp <- rp + uniqueSelectSpeciesScale
} else {
  rp <- rp + quantSpeciesScale
}
# dispay plot
print(rp)
# save to file
ggsave(paste0(output_fselectspecies, "/SelectSpeciesRev_", substr(broadzone_underscore,0,30),".png"), plot = rp)
# save to file - base functions
# png(paste0(output_fselectspecies,"/OtherSpeciesRev_",broadzone,".png"))
# print(rp)
# dev.off()
rm(rp)
# alternatively, save plot as png and call
# knitr::include_graphics("rrtools-steps-carbon.png")

##########################################################################

# sort by revenue
allyrrev_table <- subset(sSpeciesArea, select = -Year ) %>%  
  # select(Species, allyrtotal_rev, allyrtotal_land) %>% 
  distinct(Species, allyrtotal_rev) %>%
  arrange(desc(allyrtotal_rev)) %>%
  # arrange(desc(allyearland_total)) %>%
  dplyr::select(Species, allyrtotal_rev) %>% 
  dplyr::rename("All Year Total" = allyrtotal_rev) %>% 
  ungroup()
  
# %>%  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))
# TODO: add number to word function

# convert fmp back to charaters - add totals row - format Landings column w/ $, commas, and rounded for estimation - *non-pipe way
allyrrev_table$Species <- as.character(allyrrev_table$Species)
allyrrev_table <- rbind(allyrrev_table, c("**Total**", colSums(allyrrev_table[,2]))) # allyrrev_table must be a tibble and without year column for this to work
allyrrev_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE))) < 500,"<$500", comma_format(trim = TRUE, accuracy = 1000, prefix="$")(as.numeric(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
allyrrev_table[nrow(allyrrev_table),2] <- paste0("**",allyrrev_table[nrow(allyrrev_table),2],"**")

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(allyrrev_table)[names(allyrrev_table) == "All Year Total"] <- paste0(numyear, " Year Total")

cat("\n\n")

print(kable(allyrrev_table, caption = paste0(numyear, ' Year Total Revenue, Select Species, ', broadzone), align=c('l', 'r'))) 
  
cat("\n\n\n\n\n\n")

}

cat("<br> ")


```

```{r selected_species_summary, results='asis', eval = select_species_section_summary} 

section_name = "Select Species"
section_table <- get("species_merge") %>% ungroup()
margin <- "Species"

cat("<br>") 

cat("*Summary*")

if (single_area_summaries) {
  all_rev <- allyrrev_table %>% filter(.data[[margin]] == '**Total**') %>% select(-.data[[margin]])
  all_land <- allyrland_table %>% filter(.data[[margin]] =="**Total**") %>% select(-.data[[margin]])
  rev_land_total <- cbind(all_rev, all_land)
  row.names(rev_land_total) <- "**Total**"
  print(kable(rev_land_total, caption = paste0(numyear,' Year Landings and Revenue, ', section_name, ' '), align=c('r', 'r')))
} else {
  counter = 1
  for (ar in allZones) {
    if (counter == 1) {
      ar_u <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", ar)), perl=TRUE)
    allyr_table <- as_tibble(section_table %>%  
      select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%     # use .data[[margin]] to refer to column name stored as string
      filter(Area == ar_u) %>% 
      distinct(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%
      arrange(desc(allyrtotal_land)) %>%
      dplyr::select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>% 
      dplyr::rename("All Year Revenue" = allyrtotal_rev, "All Year Landings (Pounds)" = allyrtotal_land) %>% 
      mutate("{margin}" := as.character(.data[[margin]])) %>% # use '"{margin}" :=' to refer to a column as a string
      ungroup()) # have to convert to tibble to add up rows
    allyr_table <- rbind(allyr_table, c("**Total**", ar, colSums(allyr_table[,3]), colSums(allyr_table[,4])))
    allyr_table <- allyr_table %>% filter(.data[[margin]] =="**Total**")
    counter = 2
  } else {
    ar_u <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", ar)), perl=TRUE)
    allyr_table_2 <- as_tibble(section_table %>%  
      filter(Area == ar_u) %>% 
      distinct(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%
      arrange(desc(allyrtotal_land)) %>%
      dplyr::select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>% 
      dplyr::rename("All Year Revenue" = allyrtotal_rev, "All Year Landings (Pounds)" = allyrtotal_land) %>% 
      mutate("{margin}" := as.character(.data[[margin]])) %>% 
      ungroup())
    
    allyr_table_2 <- rbind(allyr_table_2, c("**Total**", ar, colSums(allyr_table_2[,3]), colSums(allyr_table_2[,4])))
    allyr_table_2 <- allyr_table_2 %>% filter(.data[[margin]] =="**Total**")
    allyr_table <- rbind(allyr_table, allyr_table_2)
    }
  }

  allyr_table <- allyr_table %>% select(-.data[[margin]]) %>% mutate(`All Year Revenue` = round(as.double(`All Year Revenue`), digits = -3)) %>% mutate(`All Year Landings (Pounds)` = round(as.double(`All Year Landings (Pounds)`), digits = -3))
  allyr_table <- rbind(allyr_table, c('**Total**', colSums(allyr_table[,2]), colSums(allyr_table[,3])))
  
  # Format columns
  allyr_table$`All Year Revenue` <- comma_format( prefix = "$", trim = FALSE, accuracy = 1000)(as.numeric(allyr_table$`All Year Revenue`))
  allyr_table$`All Year Landings (Pounds)` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyr_table$`All Year Landings (Pounds)`))
  
  # Make bottom rows bold
  allyr_table[nrow(allyr_table),2] <- paste0("**", allyr_table[nrow(allyr_table),2],"**")
  allyr_table[nrow(allyr_table),3] <- paste0("**", allyr_table[nrow(allyr_table),3],"**")
  
  # set dynamic varible names (cant use paste0 in rename in tidyverse)
  names(allyr_table)[names(allyr_table) == "Area"] <- paste0(proper(area_adjective), "Area")
  names(allyr_table)[names(allyr_table) == "All Year Revenue"] <- paste0(numyear, " Year Revenue")
  names(allyr_table)[names(allyr_table) == "All Year Landings (Pounds)"] <- paste0(numyear, " Year Landings (Pounds)")
  
  print(kable(allyr_table, caption = paste0(section_name, ' ', numyear,' Year Revenue and Landings '), align=c('l', 'r', 'r')))  
  
  }



```


```{r select_gear_types, results='asis', eval = select_gear_section}  
# REVENUEFILE <- REVENUEFILE_backup

cat("<br> \n\n")

cat("### Select Gear Types \n") 

cat("We analyzed select gear types to better understand the type of fishing occurring in", if(number_of_areas > 1) {paste0("these areas")} else {paste0(wind_area_name)},". The select gear types are: Dredge-Other, Dredge-Clam, Dredge-Scallop, Gillnet-Sink, Gillnet-Other, Weir-Trap, Seine-Purse, Seine-Other, Handline, Hand-Other, Trawl-Bottom, Trawl-Midwater, Longline-Bottom, Longline-Pelagic, Pot-Other, and Pot-Lobster. The category \"All Others\" refers to species with less than three permits or dealers impacted to protect data confidentiality.", revenue_deflation_note, " ", rounded_message, "\n\n\n")

cat("<br>")

##########################################################################
# testing 
# save_files = "n" #dont save files as csv or rdata
# save_files = "c"

# create new folder for section
dir.create(file.path(output_f, "selectgeartype"), showWarnings = FALSE)
output_fselectgeartype = file.path(output_f, "selectgeartype")

# For figure numbering
section_num = section_num + 1
figure_num = 0

###############################
#### Set Select Gear Types ####
###############################

# New gear types specificed by Doug and Ben
select_gear_codes <- as_tibble(REVENUEFILE)

select_gear_codes <- select_gear_codes %>% 
  mutate(gearcat_new = "") %>% 
  # select(IDNUM, GEARCODE, gearcat_new) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('DRM','DRO','DRU'), 'DREDGE-OTHER', gearcat_new)) %>%
  mutate(gearcat_new = ifelse(GEARCODE %in% c('DRC'), 'DREDGE-CLAM', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('DRS', 'DTS', 'DTC', 'DSC'), 'DREDGE-SCALLOP', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('GNS'), 'GILLNET-SINK', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('GND', 'GNO','GNR','GNT'), 'GILLNET-OTHER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('FYK','WEI','TRP'), 'WEIR-TRAP', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('PUR'), 'SEINE-PURSE', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('SED','SEH','SES','STS'), 'SEINE-OTHER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('HND'), 'HANDLINE', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('RAK','DIV','HRP','CST'), 'HAND-OTHER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('OBP', 'OHS','OTB','OTC','OTF','OTO','OTR','OTS','OTT','PTB', 'TTS'), 'TRAWL-BOTTOM', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('PTM','OTM'), 'TRAWL-MIDWATER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('LLB'), 'LONGLINE-BOTTOM', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('LLP'), 'LONGLINE-PELAGIC', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('PTC','PTE','PTF','PTH', 'PTO','PTS','PTW','PTX'), 'POT-OTHER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('PTL'), 'POT-LOBSTER', gearcat_new)) %>%  
  mutate(gearcat_new = ifelse(GEARCODE %in% c('OTH'), 'OTHER', gearcat_new)) %>%  
  mutate(gearcat_new = ifelse(gearcat_new == "", '[blank]', gearcat_new)) 
  
###################################
#### Set Select Gear Types end ####
###################################


################################################################
#### Create Dataframe of Select Gear Types with PII Removed ####
################################################################

# PII fixed for all areas
piiselect_gear_codes <- subset(select_gear_codes, !is.na(gearcat_new)) %>%
  # dplyr::select(gearcat_new, Year, InsideREV, InsideLANDED, PERMIT, Area ) %>%
  dplyr::select(gearcat_new, Year, InsideREV, InsideLANDED, PERMIT, Area, DEALNUM) %>% # for dealers
  filter(Area != "Other") %>% 
  group_by(gearcat_new, Year, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 = ndealers < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(gearcat_new_CONF = ifelse(CONF == T, 'All Others', gearcat_new)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("gearcat_new")) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, npermits, gearcat_new_CONF) %>%
  group_by(gearcat_new_CONF, Year, Area) %>%
  dplyr::summarize(
    yfa_rev = sum(InsideREV, na.rm = T),
    yfa_land = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("Gear_Type"= gearcat_new_CONF)

gear_codesallyr_total <- piiselect_gear_codes %>% dplyr::select(Gear_Type, Year, Area, yfa_rev, yfa_land) %>% 
  group_by(Gear_Type, Area) %>% 
  dplyr::summarize(
    allyrtotal_rev = sum(yfa_rev, na.rm = T),
    allyrtotal_land = sum(yfa_land, na.rm = T)
  )

# gear_Type_merge <- merge(piiselect_gear_codes, gear_codesallyr_total, by = c("Gear_Type", "Area"))
# keep as tibble - use dplyr functions insead of base
gear_type_merge <- left_join(piiselect_gear_codes, gear_codesallyr_total, by = c("Gear_Type", "Area"))

# Fix error with monkfish FMP by subtracting 227014.9999 from revenue
# PIISPPNMAllYears[which(PIISPPNMAllYears$FMP == 'MONKFISH JOINT'),"InsideREV_total"] <- PIISPPNMAllYears[which(PIISPPNMAllYears$FMP=='MONKFISH JOINT'),"InsideREV_total"]-227014.9999

#################################################################
#### Create Dataframe of Select Gear_Type with PII Removed end ####
#################################################################

############################################
#### Set plot colors for select species ####
############################################
# create custom color palette for all other unique FMPs 
# (length(unique(gear_type_merge$FMP))-5)
selectGear_TypebyArea <- gear_type_merge %>% group_by(Gear_Type, Area) %>%
  dplyr::summarize(
    REV = sum(yfa_rev, na.rm = T)
    ) %>% 
  ungroup %>% 
  group_by(Area) %>% 
  # top_n(., n=((length(unique(gear_type_merge$Gear_Type))-5)*-1), wt=REV) %>% 
  arrange(Area, desc(REV)) %>% 
  ungroup %>% 
  mutate(Gear_Type = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(Gear_Type), perl=TRUE)) 

# count of number of unique Gear_Type between each area
# selectGear_TypebyArea <- within(selectGear_TypebyArea, { count <- ave(Area, Gear_Type, FUN=function(x) length(unique(x)))})
# pull(selectGear_TypebyArea[selectGear_TypebyArea$count==1,"Gear_Type"]) # get vector of Gear_Type not shared by all areas

NumUniqueMargins <- length(unique(selectGear_TypebyArea$Gear_Type))

UniqueMargins <- unique(selectGear_TypebyArea$Gear_Type)

# make extra colors if more unique Gear_Types than maximum colors for palette
if (NumUniqueMargins > maxUniqueColors) {
  getPalette = colorRampPalette(brewer.pal(maxUniqueColors, paletteName3))
  myColors <- getPalette(NumUniqueMargins) 
} else {
  myColors <- brewer.pal(NumUniqueMargins, paletteName3) # create list of colors using number of unique Gear_Types from pallettte name
}

names(myColors) <- UniqueMargins # name colors for color scale

uniqueSelectGear_TypeScale <- scale_fill_manual(name = NULL, values = myColors, guide = guide_legend(reverse = TRUE))

# original color scale based on revenue quanities
quantGear_TypeScale <- scale_fill_brewer(name = NULL, palette = "RdYlBu",
                                     direction = -1, guide = guide_legend(reverse = TRUE))

rm(NumUniqueMargins, UniqueMargins) # garbage collection

################################################
#### Set plot colors for select species end ####
################################################

# Replace 'None' with pretty wording 
# REVENUEFILE$FMP[REVENUEFILE$FMP=="None"] <- "No Federal FMP"

# get vector of all zones except "Other"
# allZones <- unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other" ]

# ### get only data for Hudson_North
# broadzone = "Fairways North"
# broadzone = "Fairways_South"
# broadzone = "Hudson_North"
# broadzone = "Hudson_South"
# replace underscores with space and capitalize each word (for plot title automation)
# broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE)


#### get rev and landing plots and tables for all zones
for (broadzone in allZones) {
  figure_num = figure_num + 1
  # broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE) # make name pretty
  # cat("\raggedright")
  # cat(paste0("*", broadzone, "*", "  ", "\n\n"),"  ") # display name of broadzone on vignette
  # broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", broadzone), perl=TRUE) # make spaces underscores in area
  broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", broadzone)), perl=TRUE) # make spaces underscores and backslashs as dashes in area

###################################################################
# landings plot and table
  
# filter by area
sGear_TypeArea <- gear_type_merge %>% filter(Area == broadzone_underscore)

# make Gear_Type names lowercase
sGear_TypeArea$Gear_Type <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(sGear_TypeArea$Gear_Type), perl=TRUE)
# sGear_TypeArea$Gear_Type[sGear_TypeArea$Gear_Type=="None"] <- "No Federal FMP"

# change order of stack
sGear_TypeArea$Gear_Type <- reorder(sGear_TypeArea$Gear_Type, sGear_TypeArea$yfa_land)
sGear_TypeArea$Gear_Type <- factor(sGear_TypeArea$Gear_Type, levels=levels(sGear_TypeArea$Gear_Type))

# sGear_TypeArea$Gear_Type <- reorder(sGear_TypeArea$Gear_Type, sGear_TypeArea$sum_rev)
# sGear_TypeArea$Gear_Type <- factor(sGear_TypeArea$Gear_Type, levels=levels(sGear_TypeArea$Gear_Type))

# cat("\centering")
cat("Figure ", section_num,".", figure_num, " Landings of Select Gear Types, ", broadzone, "  \n\n", sep = "")

# plot
lp <- ggplot(sGear_TypeArea, aes(x = Year, y = yfa_land/1000000, fill=Gear_Type)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Millions of Pounds") +
  # scale_y_continuous() +
  scale_y_continuous(expand=expansion(mult=c(0, 0.1))) + 
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
  ggtitle(paste0(" Landings of Select Gear Types, ",broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale 
if (assignedColors) {
  lp <- lp + uniqueSelectGear_TypeScale
} else {
  lp <- lp + quantGear_TypeScale
}
# dispay plot
print(lp)

# save to file
ggsave(paste0(output_fselectgeartype,"/Select_Gear_Type_Land_", substr(broadzone_underscore,0,30),".png"), plot = lp)
# save to file - base functions
# png(paste0(output_fselectgeartype,"/Gear_TypeLand_",broadzone,".png"))
# print(lp)
# dev.off()
rm(lp)
# alternatively, save plot as png and call
# knitr::include_graphics("rrtools-steps-carbon.png")

# sort by landings
allyrland_table <- subset(sGear_TypeArea, select = -Year ) %>%  
  # select(Gear_Type, allyrtotal_rev, allyrtotal_land) %>% 
  distinct(Gear_Type, allyrtotal_rev, allyrtotal_land) %>%
  arrange(desc(allyrtotal_land)) %>%
  # arrange(desc(allyearland_total)) %>%
  dplyr::select(Gear_Type, allyrtotal_land) %>% 
  dplyr::rename("All Year Total" = allyrtotal_land) %>% 
  dplyr::rename("Gear Type" = Gear_Type) %>% 
  ungroup()
  
# %>%  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))
# TODO: add number to word function

# convert fmp back to charaters - add totals row - format Landings column w/ $, commas, and rounded for estimation - *non-pipe way
allyrland_table$"Gear Type" <- as.character(allyrland_table$"Gear Type")
allyrland_table <- rbind(allyrland_table, c("**Total**", colSums(allyrland_table[,2]))) # allyrland_table must be a tibble and without year column for this to work
# allyrland_table$`All Year Total` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyrland_table$`All Year Total`))
allyrland_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE))) < 500,"<500", comma_format(trim = TRUE, accuracy = 1000)(as.numeric(as.numeric(gsub(",","", x = unlist(allyrland_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
allyrland_table[nrow(allyrland_table),2] <- paste0("**",allyrland_table[nrow(allyrland_table),2],"**")

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(allyrland_table)[names(allyrland_table) == "All Year Total"] <- paste0(numyear, " Year Landings")

cat("\n\n")

print(kable(allyrland_table, caption = paste0(numyear, ' Year Total Landings (Pounds), Select Gear Types, ',broadzone), align=c('l', 'r')))
  
cat("\n\n\n\n\n\n")
  
###################################################################
# revenue plot and table
figure_num = figure_num + 1

rm(sGear_TypeArea)

sGear_TypeArea <- gear_type_merge %>% filter(Area == broadzone_underscore)

# make FMP names lowercase
sGear_TypeArea$Gear_Type <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(sGear_TypeArea$Gear_Type), perl=TRUE)
# sGear_TypeArea$Gear_Type[sGear_TypeArea$Gear_Type=="None"] <- "No Federal FMP"

# change order of stack
sGear_TypeArea$Gear_Type <- reorder(sGear_TypeArea$Gear_Type, sGear_TypeArea$yfa_rev)
sGear_TypeArea$Gear_Type <- factor(sGear_TypeArea$Gear_Type, levels=levels(sGear_TypeArea$Gear_Type))

cat("Figure ", section_num,".", figure_num, " Revenue from Select Gear Types, ", broadzone, "  \n\n", sep = "")

# plot
rp <- ggplot(sGear_TypeArea, aes(x = Year, y = yfa_rev/1000000, fill=Gear_Type)) +
  geom_col(width=0.4) +
  xlab(NULL) +
  ylab("Revenue in Millions") +
  # scale_y_continuous(labels = dollar_format(prefix="$")) +
  scale_y_continuous(expand=expansion(mult=c(0, 0.1))) +
  theme_bw() +
  # theme_ipsum() +
  coord_flip() +
  ggtitle(paste0("Revenue from Select Gear Types, ", broadzone)) +
  # theme(text=element_text(size=10, family="serif"),
  theme(text=element_text(size=10),
        panel.grid.major = element_line(colour="gray", size=0.5),
        # plot.title = element_text(hjust = 0.5, size=18))
        plot.title = element_text())

# if assignedColors variable is set to TRUE, use custom color palette scale otherwise use original quantitive scale 
if (assignedColors) {
  rp <- rp + uniqueSelectGear_TypeScale
} else {
  rp <- rp + quantGear_TypeScale
}
# dispay plot
print(rp)
# save to file
ggsave(paste0(output_fselectgeartype, "/Select_Gear_Type_Rev_", substr(broadzone_underscore,0,30),".png"), plot = rp)
# save to file - base functions
# png(paste0(output_fselectgeartype,"/OtherGear_TypeRev_",broadzone,".png"))
# print(rp)
# dev.off()
rm(rp)
# alternatively, save plot as png and call
# knitr::include_graphics("rrtools-steps-carbon.png")

##########################################################################

# sort by revenue
allyrrev_table <- subset(sGear_TypeArea, select = -Year ) %>%  
  # select(Gear_Type, allyrtotal_rev, allyrtotal_land) %>% 
  distinct(Gear_Type, allyrtotal_rev) %>%
  arrange(desc(allyrtotal_rev)) %>%
  # arrange(desc(allyearland_total)) %>%
  dplyr::select(Gear_Type, allyrtotal_rev) %>% 
  dplyr::rename("All Year Total" = allyrtotal_rev) %>% 
  dplyr::rename("Gear Type" = Gear_Type) %>% 
  ungroup()
  
# %>%  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "Total")))
# TODO: add number to word function

# convert fmp back to charaters - add totals row - format Landings column w/ $, commas, and rounded for estimation - *non-pipe way
allyrrev_table$"Gear Type" <- as.character(allyrrev_table$"Gear Type")
allyrrev_table <- rbind(allyrrev_table, c("**Total**", colSums(allyrrev_table[,2]))) # allyrrev_table must be a tibble and without year column for this to work
allyrrev_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE))) < 500,"<$500", comma_format(trim = TRUE, accuracy = 1000, prefix="$")(as.numeric(as.numeric(gsub(",","", x = unlist(allyrrev_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
allyrrev_table[nrow(allyrrev_table),2] <- paste0("**",allyrrev_table[nrow(allyrrev_table),2],"**")

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(allyrrev_table)[names(allyrrev_table) == "All Year Total"] <- paste0(numyear, " Year Revenue")

cat("\n\n")

print(kable(allyrrev_table, caption = paste0(numyear, ' Year Total Revenue, Select Gear Types, ', broadzone), align=c('l', 'r')))
  
cat("\n\n\n\n\n\n")

}


```



```{r select_gear_code_summary, results='asis', eval = select_gear_section_summary} 

section_name = "Select Gear Types"
section_table <- get("gear_type_merge") %>% ungroup()
margin <- "Gear_Type"

cat("<br>") 

cat("*Summary*")

if (single_area_summaries) {
  all_rev <- allyrrev_table %>% filter(.data[[margin]] == '**Total**') %>% select(-.data[[margin]])
  all_land <- allyrland_table %>% filter(.data[[margin]] =="**Total**") %>% select(-.data[[margin]])
  rev_land_total <- cbind(all_rev, all_land)
  row.names(rev_land_total) <- "**Total**"
  print(kable(rev_land_total, caption = paste0(numyear,' Year Landings and Revenue, ', section_name, ' '), align=c('r', 'r')))
} else {
  counter = 1
  for (ar in allZones) {
    if (counter == 1) {
      ar_u <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", ar)), perl=TRUE)
    allyr_table <- as_tibble(section_table %>%  
      select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%     # use .data[[margin]] to refer to column name stored as string
      filter(Area == ar_u) %>% 
      distinct(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%
      arrange(desc(allyrtotal_land)) %>%
      dplyr::select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>% 
      dplyr::rename("All Year Revenue" = allyrtotal_rev, "All Year Landings (Pounds)" = allyrtotal_land) %>% 
      mutate("{margin}" := as.character(.data[[margin]])) %>% # use '"{margin}" :=' to refer to a column as a string
      ungroup()) # have to convert to tibble to add up rows
    allyr_table <- rbind(allyr_table, c("**Total**", ar, colSums(allyr_table[,3]), colSums(allyr_table[,4])))
    allyr_table <- allyr_table %>% filter(.data[[margin]] =="**Total**")
    counter = 2
  } else {
    ar_u <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", ar)), perl=TRUE)
    allyr_table_2 <- as_tibble(section_table %>%  
      filter(Area == ar_u) %>% 
      distinct(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>%
      arrange(desc(allyrtotal_land)) %>%
      dplyr::select(.data[[margin]], Area, allyrtotal_rev, allyrtotal_land) %>% 
      dplyr::rename("All Year Revenue" = allyrtotal_rev, "All Year Landings (Pounds)" = allyrtotal_land) %>% 
      mutate("{margin}" := as.character(.data[[margin]])) %>% 
      ungroup())
    
    allyr_table_2 <- rbind(allyr_table_2, c("**Total**", ar, colSums(allyr_table_2[,3]), colSums(allyr_table_2[,4])))
    allyr_table_2 <- allyr_table_2 %>% filter(.data[[margin]] =="**Total**")
    allyr_table <- rbind(allyr_table, allyr_table_2)
    }
  }

  allyr_table <- allyr_table %>% select(-.data[[margin]]) %>% mutate(`All Year Revenue` = round(as.double(`All Year Revenue`), digits = -3)) %>% mutate(`All Year Landings (Pounds)` = round(as.double(`All Year Landings (Pounds)`), digits = -3))
  allyr_table <- rbind(allyr_table, c('**Total**', colSums(allyr_table[,2]), colSums(allyr_table[,3])))
  
  # Format columns
  allyr_table$`All Year Revenue` <- comma_format( prefix = "$", trim = FALSE, accuracy = 1000)(as.numeric(allyr_table$`All Year Revenue`))
  allyr_table$`All Year Landings (Pounds)` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyr_table$`All Year Landings (Pounds)`))
  
  # Make bottom rows bold
  allyr_table[nrow(allyr_table),2] <- paste0("**", allyr_table[nrow(allyr_table),2],"**")
  allyr_table[nrow(allyr_table),3] <- paste0("**", allyr_table[nrow(allyr_table),3],"**")
  
  # set dynamic varible names (cant use paste0 in rename in tidyverse)
  names(allyr_table)[names(allyr_table) == "Area"] <- paste0(proper(area_adjective), "Area")
  names(allyr_table)[names(allyr_table) == "All Year Revenue"] <- paste0(numyear, " Year Revenue")
  names(allyr_table)[names(allyr_table) == "All Year Landings (Pounds)"] <- paste0(numyear, " Year Landings (Pounds)")
  
  print(kable(allyr_table, caption = paste0(section_name, ' ', numyear,' Year Revenue and Landings '), align=c('l', 'r', 'r')))  
  
  }
```

```{r bottom_tending_mobile_gear, results='asis', eval = F} 

cat("### Bottom Tending Mobile Gear")

cat("Due to the impact wind turbine construction may have on the ocean floor, we isolated revenue and landings accomplished with mobile bottom tending gear. The following gear were isolated and presented by area:

* Dredges: ocean quahog/surfclam, mussel, sea scallop, urchin, modified and unmodified chain-mat scallop, scallop with turtle deflector, and other
* Otter trawls: bottom (fish, scallop, shrimp, other), including those with haddock separator, Ruhle trawl, beam trawl, twin trawls, pair trawls, and other")

##########################################################################
# testing
# save_files = "n" #dont save files as csv or rdata
# save_files = "c" 

# create new folder for section
dir.create(file.path(output_f, "bottomgear"), showWarnings = FALSE)
output_fbottomgear = file.path(output_f, "bottomgear")

##########################################################################
# Bottom tending gear tables

# all gearids in rev file
# sort(unique(REVENUEFILE$GEARCODE))

# requested gear types
bottomGear <- c("DRO", "DRS", "DSC", "DTC", "DTS", "OHS", "OTB", "OTC", "OTF", "OTO", "OTR", "OTS", "OTT")

# quick check
# sort(unique(REVENUEFILE$GEARCODE))[sort(unique(REVENUEFILE$GEARCODE)) %in% bottomGear]
# length(bottomGear) == length(sort(unique(REVENUEFILE$GEARCODE))[sort(unique(REVENUEFILE$GEARCODE)) %in% bottomGear])

# Fix error with monkfish FMP by subtracting 227014.9999 from revenue
# PIISPPNMAllYears[which(PIISPPNMAllYears$FMP == 'MONKFISH JOINT'),"InsideREV_total"] <- PIISPPNMAllYears[which(PIISPPNMAllYears$FMP=='MONKFISH JOINT'),"InsideREV_total"]-227014.9999

# PII fixed for all areas
piigearids <- REVENUEFILE %>%
  dplyr::select(FMP, GEARCODE, Year, InsideREV, InsideLANDED, PERMIT, Area) %>%
  # dplyr::select(GEARCODE, Year, InsideREV, InsideLANDED, PERMIT, DEALNUM) %>% # for dealers
  filter(Area != "Other") %>% 
  filter(GEARCODE %in% bottomGear) %>%
  group_by(FMP, Year, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    # ndealers = length(unique(DEALNUM))
    ) %>%
  mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 =  ndealers < 3) %>%
  mutate(FMP_CONF = ifelse(CONF == T, 'All Others', FMP)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("GEARCODE")) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, npermits, GEARCODE_CONF) %>%
  group_by(FMP_CONF, Year, Area) %>%
  dplyr::summarize(
    yfa_rev = sum(InsideREV, na.rm = T),
    yfa_land = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("FMP"= FMP_CONF)

gearidsallyr_total <- piigearids %>% dplyr::select(FMP, Year, Area, yfa_rev, yfa_land) %>% 
  group_by(FMP, Area) %>% 
  dplyr::summarize(
    allyrtotal_rev = sum(yfa_rev, na.rm = T),
    allyrtotal_land = sum(yfa_land, na.rm = T)
  )

# gear_Type_merge <- merge(piigearids, gear_codesallyr_total, by = c("Species", "Area"))
# keep as tibble - use dplyr functions insead of base
gearids_merge <- left_join(piigearids, gearidsallyr_total, by = c("FMP", "Area"))

# rm(gearids_merge)

###############################################################################################################################################################

# Replace 'None' with pretty wording 
# REVENUEFILE$FMP[REVENUEFILE$FMP=="None"] <- "No Federal FMP"

# get vector of all zones except "Other"
# allZones <- unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other" ]

# ### get only data for Hudson_North
# broadzone = "Fairways_North"
# broadzone = "Fairways_South"
# broadzone = "Hudson_North"
# broadzone = "Hudson_South"
# broadzone = "OCS_A_0486"
# replace underscores with space and capitalize each word (for plot title automation)
# broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE)


#### get rev and landing plots and tables for all zones
for (broadzone in allZones) {
  # broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE) # make name pretty
  # cat("\raggedright")
  # cat(paste0("*", broadzone, "*", "  ", "\n\n"),"  ") # display name of broadzone on vignette
  # broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", broadzone), perl=TRUE) # make spaces underscores in area
  broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", broadzone)), perl=TRUE) # make spaces underscores and backslashs as dashes in area
  
######################################################################################################################################
######################################################################################################################################
# landings plot and table
  
# filter by area
gearidArea <- gearids_merge %>% filter(Area == broadzone_underscore)
# rm(gearidArea)
# TODO: save as speadsheet

# remove uneeded columns
# allyrgearid_table <- gearidArea %>%  dplyr::select(-c("npermits", "Year", "Area", "yfa_rev", "yfa_land"))
allyrgearid_table <- gearidArea[ , !(names(gearidArea) %in% c("npermits", "Year", "Area", "yfa_rev", "yfa_land") )]

allyrgearid_table <- allyrgearid_table %>% 
  distinct(FMP, allyrtotal_rev, allyrtotal_land) %>% 
  dplyr::rename('All Year Revenue' = allyrtotal_rev, 'All Year Landings (Pounds)' = allyrtotal_land ) %>% 
  arrange(desc(`All Year Revenue`, .by_group = TRUE)) # sort by revenue
  # subset(allyrgearid_table, allyrgearid_table$`All Year Revenue`<500)[order(allyrgearid_table$FMP, allyrgearid_table$`All Year Revenue` < 500), ] #order fmps alphabetically if less then $500

# rm(allyrgearid_table)

# uncomment below if alphabetical sorting is requested
# allyrgearid_table <- allyrgearid_table %>% arrange(FMP, .by_group = TRUE)

# TODO: export as speadsheet
# save to csv
if (save_files == "c" | save_files == "b" ) {
  write.csv(allyrgearid_table, file=file.path(output_fbottomgear,
                                     paste0(gsub(pattern="[a-z]?", replacement="", broadzone_underscore),
                                            "_bottomgear.csv")), row.names=FALSE)
}
# for text box
highestfmp_nm <- head(allyrgearid_table$FMP, 1)
highestfmp_rev <- head(allyrgearid_table$`All Year Revenue`, 1)
rev_total <- allyrgearid_table %>% 
  dplyr::summarize(rev_total = sum(`All Year Revenue`, na.rm = T)) %>% 
  pull(rev_total)
land_total <- allyrgearid_table %>% 
  dplyr::summarize(land_total = sum(`All Year Landings (Pounds)`, na.rm = T)) %>% 
  pull(land_total)

# make FMP names lowercase
allyrgearid_table$FMP[allyrgearid_table$FMP=="None"] <- "No Federal FMP"
allyrgearid_table$FMP <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(allyrgearid_table$FMP), perl=TRUE)
# allyrgearid_table$FMP[allyrgearid_table$FMP=="None"] <- "No Federal FMP"
allyrgearid_table <- rbind(allyrgearid_table, c("**Total**", colSums(allyrgearid_table[,2]), colSums(allyrgearid_table[,3])))
allyrgearid_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrgearid_table[2], use.names = FALSE))) < 500,"<$500", comma_format(trim = TRUE, accuracy = 1000, prefix="$")(as.numeric(as.numeric(gsub(",","", x = unlist(allyrgearid_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
allyrgearid_table[,3] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrgearid_table[3], use.names = FALSE))) < 500,"<500", comma_format(trim = TRUE, accuracy = 1000)(as.numeric(as.numeric(gsub(",","", x = unlist(allyrgearid_table[3], use.names = FALSE)))))) # add less than sign if revenue is less than $500
# allyrgearid_table$`All Year Revenue` <- comma_format( prefix = "$", trim = FALSE, accuracy = 1000)(as.numeric(allyrgearid_table$`All Year Revenue`))
# allyrgearid_table$`All Year Landings (Pounds)` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyrgearid_table$`All Year Landings (Pounds)`))
# Make bottom rows bold
allyrgearid_table[nrow(allyrgearid_table),2] <- paste0("**",allyrgearid_table[nrow(allyrgearid_table),2],"**")
allyrgearid_table[nrow(allyrgearid_table),3] <- paste0("**",allyrgearid_table[nrow(allyrgearid_table),3],"**")

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(allyrgearid_table)[names(allyrgearid_table) == "All Year Revenue"] <- paste0(numyear, " Year Revenue")
names(allyrgearid_table)[names(allyrgearid_table) == "All Year Landings (Pounds)"] <- paste0(numyear, " Year Landings (Pounds)")

cat("\n\n")
cat("This table displays each FMP’s ",numbers2words(length(START.YEAR:END.YEAR))," year total revenue and total landings when only considering bottom tending gear. ", trimws(gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(highestfmp_nm), perl=TRUE)), " FMP had the greatest revenue and gross landings by bottom tending gear, comprising approximately ", number_format(accuracy = 1)(highestfmp_rev/rev_total*100)," percent of total associated revenue. A total of ", numbersuffix(round(land_total, -3))," pounds were landed in ",broadzone," by bottom tending gear during the ",numbers2words(length(START.YEAR:END.YEAR))," year period of analysis, generating an estimated ", paste0("$",numbersuffix(round(land_total, -3)), sep=""),". ",sep = "")

cat("\n\n")

print(kable(allyrgearid_table, caption = paste0('Revenue and Landings by Bottom Tending Gear ',START.YEAR,"-", END.YEAR, " ", broadzone), align=c('l', 'r', 'r')))

cat("\n\n")

######################################################################################################################################
######################################################################################################################################

}


```


```{r totals_dynamic_text, results='asis', eval = T} 

piiarea <- subset(REVENUEFILE, !is.na(Year)) %>% 
  # dplyr::select(InsideREV, InsideLANDED, PERMIT, Area) %>%
  dplyr::select(InsideREV, InsideLANDED, PERMIT, Area, DEALNUM) %>%
  filter(Area != "Other") %>% 
  group_by(Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T), 
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
                      ) %>% 
  # mutate(CONF =  npermits < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(Area_CONF = ifelse(CONF == T, 'All Others', Area)) %>%
  dplyr::select(-Area) %>% 
  dplyr::rename("Area"= Area_CONF) %>% 
  ungroup() %>%
  group_by(Area) %>%
  dplyr::summarize(
    'All Year Revenue' = sum(InsideREV, na.rm = T),
    'All Year Landings (Pounds)' = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  ungroup() %>% 
  dplyr::select(-npermits)

# Create dynamic text for totals
# Take top landing area name and landings amount
top_landing_area_name <- gsub("_"," ", piiarea %>% top_n(., n=1, wt=`All Year Landings (Pounds)`) %>% pull(Area))
top_landing_area_land <- piiarea %>% top_n(., n=1, wt=`All Year Landings (Pounds)`) %>% pull(`All Year Landings (Pounds)`)

# Take top revenue area name and revenue amount
top_revenue_area_name <- gsub("_"," ",piiarea %>% top_n(., n=1, wt=`All Year Revenue`) %>% pull(Area))
top_revenue_area_rev <- piiarea %>% top_n(., n=1, wt=`All Year Revenue`) %>% pull(`All Year Revenue`)

if (top_landing_area_name == top_revenue_area_name) {
  totals_dynamic_text <- paste0(top_revenue_area_name, " totals the most pounds landed, ", offshoreWind::numbersuffix(top_landing_area_land), ", and the most revenue derived from within", a_or_an, area_adjective,"area, $", offshoreWind::numbersuffix(top_revenue_area_rev), ". ")
}

if (top_landing_area_name != top_revenue_area_name) {
  totals_dynamic_text <- paste0(top_revenue_area_name, " totals the most pounds landed, ", offshoreWind::numbersuffix(top_landing_area_land), ". ", top_revenue_area_name, " totals the most revenue derived from within", a_or_an, area_adjective, "area, $", offshoreWind::numbersuffix(top_revenue_area_rev), ". ")
}

```

<br> 

### Totals

The following tables display the given year total revenue and total landed pounds of all species by all gear types within `r if(number_of_areas > 1) {paste0("each")} else {paste0("the")}` `r area_adjective`area. 
`r totals_dynamic_text` `r rounded_message` 

```{r totals, results='asis', eval = t} 

##########################################################################
# testing
# save_files = "n" #dont save files as csv or rdata 
# save_files = "c"

# create new folder for section
dir.create(file.path(output_f, "totals"), showWarnings = FALSE)
output_ftotals = file.path(output_f, "totals")

# Fix error with monkfish FMP by subtracting 227014.9999 from revenue
# PIISPPNMAllYears[which(PIISPPNMAllYears$FMP == 'MONKFISH JOINT'),"InsideREV_total"] <- PIISPPNMAllYears[which(PIISPPNMAllYears$FMP=='MONKFISH JOINT'),"InsideREV_total"]-227014.9999

# PII fixed for all areas
piiyears <- subset(REVENUEFILE, !is.na(Year)) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, PERMIT, Area) %>%
  dplyr::select(Year, InsideREV, InsideLANDED, PERMIT, Area, DEALNUM) %>% # for dealers
  filter(Area != "Other") %>% 
  group_by(Year, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 = ndealers < 3) %>%
  mutate(CONF = npermits < 3 | ndealers < 3) %>%
  mutate(Year_CONF = ifelse(CONF == T, 'All Others', Year)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("GEARCODE")) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, npermits, GEARCODE_CONF) %>%
  group_by(Year_CONF, Area) %>%
  dplyr::summarize(
    'All Year Revenue' = sum(InsideREV, na.rm = T),
    'All Year Landings (Pounds)' = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("Year"= Year_CONF) %>% 
  ungroup()


# save to csv
if (save_files == "c" | save_files == "b" ) {
  write.csv(piiyears, file=file.path(output_ftotals,"totals.csv"), row.names=FALSE)
}
###############################################################################################################################################################

# Replace 'None' with pretty wording 
# REVENUEFILE$FMP[REVENUEFILE$FMP=="None"] <- "No Federal FMP"

# get vector of all zones except "Other"
# allZones <- unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other" ]

# ### get only data for Hudson_North
# broadzone = "Fairways North"
# broadzone = "Fairways_South"
# broadzone = "Hudson_North"
# broadzone = "Hudson_South"
# replace underscores with space and capitalize each word (for plot title automation)
# broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE)

#### get rev and landing plots and tables for all zones
for (broadzone in allZones) {
  # broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE) # make name pretty
  # broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", broadzone), perl=TRUE) # make spaces underscores in area
  broadzone_underscore <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("\\s","_", gsub("/","-", broadzone)), perl=TRUE) # make spaces underscores and backslashs as dashes in area
  
  ######################################################################################################################################
  # revenue amd landings by area table
  
  # filter by area
  allyrsArea <- piiyears %>% filter(Area == broadzone_underscore)
  
  # TODO: save as speadsheet
  
  # remove uneeded columns
  # allyrs_table <- allyrsArea %>%  dplyr::select(-c("npermits", "Year", "Area")) # dplyr way
  allyrs_table <- allyrsArea[ , !(names(allyrsArea) %in% c("npermits", "Area") )]

  # TODO: export as speadsheet
  
  allyrs_table <- rbind(allyrs_table, c("**Total**", colSums(allyrs_table[,2]), colSums(allyrs_table[,3])))
  # allyrs_table$`All Year Revenue` <- comma_format( prefix = "$", trim = FALSE, accuracy = 1000)(as.numeric(allyrs_table$`All Year Revenue`))
  # allyrs_table$`All Year Landings (Pounds)` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyrs_table$`All Year Landings (Pounds)`))
  allyrs_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrs_table[2], use.names = FALSE))) < 500,"<$500", comma_format(trim = TRUE, accuracy = 1000, prefix="$")(as.numeric(as.numeric(gsub(",","", x = unlist(allyrs_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
  allyrs_table[,3] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrs_table[3], use.names = FALSE))) < 500,"<500", comma_format(trim = TRUE, accuracy = 1000)(as.numeric(as.numeric(gsub(",","", x = unlist(allyrs_table[3], use.names = FALSE)))))) # add less than sign if revenue is less than $500
  # Make bottom rows bold
  allyrs_table[nrow(allyrs_table),2] <- paste0("**",allyrs_table[nrow(allyrs_table),2],"**")
  allyrs_table[nrow(allyrs_table),3] <- paste0("**",allyrs_table[nrow(allyrs_table),3],"**")
  
  # set dynamic varible names (cant use paste0 in rename in tidyverse)
  # Set year number text for column names
  # names(allyrs_table)[names(allyrs_table) == "All Year Revenue"] <- paste0(numyear, " Year Revenue")
  # names(allyrs_table)[names(allyrs_table) == "All Year Landings (Pounds)"] <- paste0(numyear, " Year Landings (Pounds)")
  # set column names to just Revenue and Landings text
  names(allyrs_table)[names(allyrs_table) == "All Year Revenue"] <- paste0("Revenue")
  names(allyrs_table)[names(allyrs_table) == "All Year Landings (Pounds)"] <- paste0("Landings")
  
  cat("\n\n")
  
  print(kable(allyrs_table, caption = paste0(numyear, ' Year Total Revenue and Landings (Pounds), ', broadzone), align=c('l', 'r', 'r')))
  
  cat("\n\n")

######################################################################################################################################

} # end of loop for areas

######################################################################################################################################
######################################################################################################################################
# revenue amd landings all areas table

allyrs_table <- piiyears %>% dplyr::select(Year, Area, `All Year Revenue`, `All Year Landings (Pounds)`) %>% 
  group_by(Year) %>% 
  dplyr::summarize(
    'All Year Revenue' = sum(`All Year Revenue`, na.rm = T),
    'All Year Landings (Pounds)' = sum(`All Year Landings (Pounds)`, na.rm = T) 
  ) %>% 
  ungroup()

# TODO: export as speadsheet

allyrs_table <- rbind(allyrs_table, c("**Total**", colSums(allyrs_table[,2]), colSums(allyrs_table[,3])))
# allyrs_table$`All Year Revenue` <- comma_format( prefix = "$", trim = FALSE, accuracy = 1000)(as.numeric(allyrs_table$`All Year Revenue`))
# allyrs_table$`All Year Landings (Pounds)` <- comma_format(trim = TRUE, accuracy = 1000)(as.numeric(allyrs_table$`All Year Landings (Pounds)`))
allyrs_table[,2] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrs_table[2], use.names = FALSE))) < 500,"<$500", comma_format(trim = TRUE, accuracy = 1000, prefix="$")(as.numeric(as.numeric(gsub(",","", x = unlist(allyrs_table[2], use.names = FALSE)))))) # add less than sign if revenue is less than $500
allyrs_table[,3] <- ifelse(as.numeric(gsub(",","", x = unlist(allyrs_table[3], use.names = FALSE))) < 500,"<500", comma_format(trim = TRUE, accuracy = 1000)(as.numeric(as.numeric(gsub(",","", x = unlist(allyrs_table[3], use.names = FALSE)))))) # add less than sign if revenue is less than $500
# Make bottom rows bold
allyrs_table[nrow(allyrs_table),2] <- paste0("**",allyrs_table[nrow(allyrs_table),2],"**")
allyrs_table[nrow(allyrs_table),3] <- paste0("**",allyrs_table[nrow(allyrs_table),3],"**")

# set dynamic varible names (cant use paste0 in rename in tidyverse)
# names(allyrs_table)[names(allyrs_table) == "All Year Revenue"] <- paste0(numyear, " Year Revenue")
# names(allyrs_table)[names(allyrs_table) == "All Year Landings (Pounds)"] <- paste0(numyear, " Year Landings (Pounds)")
names(allyrs_table)[names(allyrs_table) == "All Year Revenue"] <- paste0("Revenue")
names(allyrs_table)[names(allyrs_table) == "All Year Landings (Pounds)"] <- paste0("Landings (Pounds)")

if (number_of_areas > 1) { 
cat("\n\n")
print(kable(allyrs_table, caption = paste0(numyear, " Year Total Revenue and Landings, All ", proper(area_adjective), "Areas"), align=c('l', 'r', 'r')))
cat("\n\n")
} # end number of areas check



```

<br> 

```{r revenues_by_port_dynamic_text, results='asis', eval = T} 
 
piiports <- subset(REVENUEFILE, !is.na(PORTLANDED)) %>%
  # dplyr::select(PORTLANDED, InsideREV, PERMIT, Area) %>%
  dplyr::select(PORTLANDED, InsideREV, PERMIT, Area, DEALNUM) %>% # for dealers
  filter(Area != "Other") %>% 
  group_by(PORTLANDED, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 = ndealers < 3) %>%
  mutate(CONF = npermits < 3 | ndealers < 3) %>%
  mutate(PORTLANDED_CONF = ifelse(CONF == T, 'All Others', PORTLANDED)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("GEARCODE")) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, npermits, GEARCODE_CONF) %>%
  group_by(PORTLANDED_CONF, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("City"= PORTLANDED_CONF) %>% 
  ungroup() %>% 
  group_by(City) %>%
  dplyr::summarize(InsideREV = sum(InsideREV, na.rm = T)) %>% 
  arrange(desc( InsideREV, .by_group = TRUE))
  

# Create dynamic text for ports

# Take top revenue area name and revenue amount
top_revenue_city_name <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub(",.*","", piiports %>% top_n(., n=1, wt=InsideREV) %>% pull(City))), perl=TRUE)

top_revenue_city_rev <- piiports %>% top_n(., n=1, wt=InsideREV) %>% pull(InsideREV)

ports_dynamic_text <- paste0(top_revenue_city_name," receives the highest value of landings of any port, with $",offshoreWind::numbersuffix(top_revenue_city_rev)," from ",START.YEAR, "-", END.YEAR,". ")


```

### Revenue by Port

The ten most impacted (by revenue) ports are listed below. These ports are estimated to receive the most landings from fishing done within the `r wind_area_name` `r if(number_of_areas > 1) {paste0("areas")} else {paste0("area")}`. The table below displays each port’s landings breakdown by `r area_adjective`area. Both tables present the cumulative revenues from `r paste0(START.YEAR, "-", END.YEAR )`. `r ports_dynamic_text` `r rounded_message`   


```{r revenues_by_port, results='asis', eval = t} 

##########################################################################
# testing
# save_files = "n" #dont save files as csv or rdata
# save_files = "c"

# create new folder for section
dir.create(file.path(output_f, "ports"), showWarnings = FALSE)
output_fports = file.path(output_f, "ports")

# all pii info
piiportsConf <- subset(REVENUEFILE, !is.na(PORTLANDED)) %>%
  # dplyr::select(PORTLANDED, InsideREV, PERMIT, Area) %>%
  dplyr::select(PORTLANDED, InsideREV, PERMIT, Area, DEALNUM) %>% # for dealers
  filter(Area != "Other") %>%
  group_by(PORTLANDED, Area) %>%
  dplyr::summarize(
    'Total All Year Revenue' = sum(InsideREV, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF = npermits < 3) %>%
  # mutate(CONF2 = ndealers < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(PORTLANDED_CONF = ifelse(CONF == T, 'All Others', PORTLANDED)) %>%
  ungroup()

if (save_files == "c" | save_files == "b" ) {
  write.csv(piiportsConf, file=file.path(output_fports,"portlandingsconf.csv"), row.names=FALSE)
}

# pii for ports
# TODO: may need to consider pii for dealers
piiports <- subset(REVENUEFILE, !is.na(PORTLANDED)) %>%
  # dplyr::select(PORTLANDED, InsideREV, PERMIT, Area) %>%
  dplyr::select(PORTLANDED, InsideREV, PERMIT, Area, DEALNUM) %>% # for dealers
  filter(Area != "Other") %>% 
  group_by(PORTLANDED, Area) %>%
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 = ndealers < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(PORTLANDED_CONF = ifelse(CONF == T, 'All Others', PORTLANDED)) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("GEARCODE")) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, npermits) %>%
  group_by(PORTLANDED_CONF, Area) %>%
  dplyr::summarize(
    'Total All Year Revenue' = sum(InsideREV, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("City"= PORTLANDED_CONF) %>% 
  ungroup()


if (save_files == "c" | save_files == "b" ) {
  write.csv(piiports, file=file.path(output_fports,"portlandings.csv"), row.names=FALSE)
}

piiports$State <- trimws(gsub(".*,","", piiports$City))

piiports$State <- ifelse(piiports$State == "All Others","",piiports$State)

# gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", gsub(",.*","", unique(piiports$City)))), perl=TRUE)

# make ports proper case and remove state abbrivations after comma 
piiports$City <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub(",.*","", piiports$City)), perl=TRUE)

# Most Impacted Ports, by Landings Revenues
revbyport <-  piiports %>% group_by(City, State) %>% dplyr::summarize(
      'Total All Year Revenue' = sum(`Total All Year Revenue`, na.rm = T)
) %>% 
  arrange(desc(`Total All Year Revenue`))

# get top ten cities with state abrevs
# top10portcities <- head(revbyport, 10) %>% transmute(new = paste0(City, ", ", State)) %>% pull
top10portcities <- str_replace(head(revbyport, 10) %>% transmute(new = paste0(City, ", ", State)) %>% pull, "All Others, ", "All Others") #fix state-city concatination issue

revbyport[,3] <- ifelse(as.numeric(gsub(",","", x = unlist(revbyport[3], use.names = FALSE))) < 500,"<$500", comma_format(trim = TRUE, accuracy = 1000, prefix="$")(as.numeric(as.numeric(gsub(",","", x = unlist(revbyport[3], use.names = FALSE)))))) # add less than sign if revenue is less than $500

# set dynamic varible names (cant use paste0 in rename in tidyverse)
# names(revbyport)[names(revbyport) == "All Year Revenue"] <- paste0(numyear, " Year Revenue")
names(revbyport)[names(revbyport) == "Total All Year Revenue"] <- paste0(numyear, " Year Revenue")

print(kable(head(revbyport, 10), caption = "Most Impacted Ports, by Landings Revenues", align=c('l', 'l', 'r')))

cat("\n\n")
# Landings by area -  
# TODO: may need to account for pii of dealers
# combine port city and state into one column for landings by area
piiports$Port <- ifelse(piiports$City == "All Others","All Others", paste0(piiports$City, ", ", piiports$State))

piiports$Area <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", piiports$Area)), perl=TRUE)

# create table of area revenues by port
landingsbyarea <- piiports %>% filter(Port %in% top10portcities) %>%  
  group_by(Port, Area) %>% 
  dplyr::summarize(
  `Total All Year Revenue` = sum(`Total All Year Revenue`, na.rm = T)) %>% 
  pivot_wider(names_from = Area, values_from = `Total All Year Revenue`)

landingsbyarea <- landingsbyarea[match(top10portcities, landingsbyarea$Port),]  

# add formatting to area columns
for (area in 1:length(unique(piiports$Area))) {
  landingsbyarea[,area+1] <- ifelse(as.numeric(gsub(",","", x = unlist(landingsbyarea[area+1], use.names = FALSE))) < 500,"<$500", comma_format(trim = TRUE, accuracy = 1000, prefix="$")(as.numeric(as.numeric(gsub(",","", x = unlist(landingsbyarea[area+1], use.names = FALSE)))))) # add less than sign if revenue is less than $500
}

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(landingsbyarea)[names(landingsbyarea) == "All Year Revenue"] <- paste0(numyear, " Year Revenue")
if (number_of_areas > 1) {
print(kable(landingsbyarea, caption = paste0("Landings by ", proper(area_adjective),"Area"), align=c('l', 'r', 'r', 'r', 'r')))
cat("\n\n")
} # end number of areas check

```

<br> 

### Percentage of Revenue by Permit

We also analyzed the percentage of each permit’s total commercial fishing revenue coming from within the `r wind_area_name` `r area_adjective` `r if(number_of_areas > 1) {paste0("areas")} else {paste0("area")}` (see boxplots figures and tables below). Boxplots are important statistical summaries because they provide information about the distribution of the percentages. The boxplots below begin at the 1st quartile, or the value beneath which 25 percent of all observations fall. A thick line within the box identifies the median, the observation at which 50 percent of observations are above or beneath. The box ends at the 3rd quartile, or the observation beneath which 75 percent of observations fall. 
Nonparametric estimates of the minimum and maximum values are also indicated by the “whiskers” (dashed line terminating in a vertical line) that jut out from each side of the box. Any points outside of these whiskers are observations that are considered outliers.
In our tables, however, the maximum values are inclusive of outliers. The table below presents the minimum, 1st quartile, median, 3rd quartile, and maximum values for `r if(number_of_areas > 1) {paste0("each")} else {paste0("the")}` `r area_adjective`area. These are the `r numbers2words(abs(END.YEAR-START.YEAR)+1)` year revenue percentages. The boxplots in the figures below further separate `r if(number_of_areas > 1) {paste0("each")} else {paste0("the")}` `r area_adjective`area out by year. 

<br> 

```{r percent_of_revenue_by_permit, results='asis', eval = T}  

##########################################################################
# testing
# save_files = "n" #dont save files as csv or rdata 
# save_files = "c"

# create new folder for section
dir.create(file.path(output_f, "permit"), showWarnings = FALSE)
output_fpermit = file.path(output_f, "permit")


# pii for permits
# TODO: may need to consider pii for dealers

###########################################################################
############################## Boxplot table ##############################
###########################################################################

# # PII fixed for all areas
# piipermit <- subset(REVENUEFILE, !is.na(FMP)) %>%
#   dplyr::select(Year,REVENUE, InsideREV, InsideLANDED, PERMIT, Area) %>%
#   # dplyr::select(FMP, Year, InsideREV, InsideLANDED, PERMIT, DEALNUM) %>% # for dealers
#   # dplyr::select(Year, PERMIT, Area) %>%
#   filter(Area != "Other") %>% 
#   group_by(Year, Area) %>%
#   dplyr::summarize(
#     AllREV = sum(REVENUE, na.rm = T),
#     InsideREV = sum(InsideREV, na.rm = T),
#     InsideLANDED = sum(InsideLANDED, na.rm = T),
#     npermits = length(unique(PERMIT)),
#     # ndealers = length(unique(DEALNUM))
#     ) %>%
#   mutate(CONF =  npermits < 3) %>%
#   # mutate(CONF2 =  ndealers < 3) %>%
#   # mutate(FMP_CONF = ifelse(CONF == T, 'All Others', FMP)) %>%
#   ungroup() %>%
#   # dplyr::select(-starts_with("FMP")) %>%
#   # dplyr::select(Year, InsideREV, InsideLANDED, npermits, FMP_CONF) %>%
#   group_by(Year, Area) %>%
#   dplyr::summarize(
#     yfa_AllREV = sum(AllREV, na.rm = T),
#     yfa_rev = sum(InsideREV, na.rm = T),
#     yfa_land = sum(InsideLANDED, na.rm = T),
#     npermits = sum(npermits, na.rm = T)) %>% 
#   mutate(PercOfTotal = (yfa_rev/yfa_AllREV)*100) %>% 
#   arrange(desc(PercOfTotal))
# 
# if (save_files == "c" | save_files == "b" ) {
#   write.csv(piipermit, file=file.path(output_f,"permitareas.csv"), row.names=FALSE)
# }

# PII fixed for all areas
piipermitAllyear <- REVENUEFILE %>%
  dplyr::select(Year, REVENUE, InsideREV, InsideLANDED, PERMIT, Area) %>%
  # dplyr::select(FMP, Year, InsideREV, InsideLANDED, PERMIT, DEALNUM) %>% # for dealers
  # dplyr::select(Year, PERMIT, Area) %>%
  filter(Area != "Other") %>% 
  group_by(PERMIT, Area,Year) %>% 
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    # ndealers = length(unique(DEALNUM))
    ) %>%
  mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 =  ndealers < 3) %>%
  # mutate(FMP_CONF = ifelse(CONF == T, 'All Others', FMP)) %>%
  ungroup()

permittot <- aggregate(FIN$REVENUE~FIN$Year+FIN$PERMIT, FUN=sum)
names(permittot) <-c("Year","PERMIT","AllREV")
piipermitAllyear <- merge(piipermitAllyear,permittot, by=c("Year","PERMIT"),all.x=TRUE, all.y=FALSE)

piipermitAllyear <- piipermitAllyear %>%
  group_by(PERMIT, Area) %>% 
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    AllREV = sum(AllREV,na.rm=T)
    # ndealers = length(unique(DEALNUM))
    ) %>%
  mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 =  ndealers < 3) %>%
  # mutate(FMP_CONF = ifelse(CONF == T, 'All Others', FMP)) %>%
  ungroup()

piipermitAllyear$Percent <- piipermitAllyear$InsideREV/piipermitAllyear$AllREV*100

if (save_files == "c" | save_files == "b" ) {
  write.csv(piipermitAllyear, file=file.path(output_f,"permitareas.csv"), row.names=FALSE)
}

# this creates a table of summary statistics for percent of revenues of permits in the areas 
# *** values in the table that are less than .01 are displayed as 0 
# * values in the table are rounded to .01
# * values in the table that are greater than .99 are displayed as whole numbers
for (aa in unique(piipermitAllyear$Area)) { #loop through all areas
  broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", aa)), perl=TRUE)
  permitarea <- piipermitAllyear %>% filter(Area == aa)
  # create stat table for area
  firsttable <- as_tibble(lapply(list("Min" = min(permitarea$Percent, na.rm = TRUE), 
                             "1st Quartile" = unname(quantile(permitarea$Percent, 0.25, na.rm = TRUE)),
                             "Median" = median(permitarea$Percent, na.rm = TRUE),
                             "3rd Quartile" = unname(quantile(permitarea$Percent, 0.75, na.rm = TRUE)),
                             "Max" = max(permitarea$Percent, na.rm = TRUE))
                 , function(num) 
                   if (num < .01) {number_format(trim = TRUE, accuracy = 1)(num)}
  else if (num < 1) {number_format(trim = TRUE, accuracy = .01)(num)} 
  else {number_format(trim = TRUE, accuracy = 1)(num)}))
  firsttable <- firsttable %>% mutate(`Area` = broadz) %>% dplyr::select(`Area`, everything())
  # append stat tables for all areas
  if (aa == unique(piipermitAllyear$Area)[1]) { # check if first area in loop
    allstattables <- firsttable
  } else {
    allstattables <- rbind(allstattables, firsttable)
  }
}

# set dynamic varible names (cant use paste0 in rename in tidyverse)
names(allstattables)[names(allstattables) == "Area"] <- paste0(proper(area_adjective), "Area")

if (save_files == "c" | save_files == "b" ) {
  write.csv(allstattables, file=file.path(output_f,"stattables.csv"), row.names=FALSE)
}

print(kable(allstattables), caption = paste0("Analysis of ", numyear, " Year Permit Revenue Percentage Boxplots, by ",proper(area_adjective),"Area"), align=c('c', 'c', 'c', 'c', 'c', 'c'))

rm(list=c("firsttable", "allstattables")) # garbage collection

# # process broken down
# permitarea <- piipermitAllyear %>% filter(Area == "Fairways_North")
# # summary(permitarea$Percent)
# quint <- quantile(permitarea$Percent, c(0.25,0.75), na.rm = TRUE) # find quintiles
# max(permitarea$Percent, na.rm = TRUE)
# min(permitarea$Percent, na.rm = TRUE)
# median(permitarea$Percent, na.rm = TRUE)
# unname(quint["25%"])
# unname(quint["75%"])
# 
# as_tibble(lapply(
#   list("Min" = min(permitarea$Percent, na.rm = TRUE), 
#                "1st Quartile" = unname(quantile(permitarea$Percent, 0.25, na.rm = TRUE)),
#                "Median" = median(permitarea$Percent, na.rm = TRUE), 
#                "3rd Quartile" = unname(quantile(permitarea$Percent, 0.75, na.rm = TRUE)),
#                "Max" = max(permitarea$Percent, na.rm = TRUE))
#                  , function(num) if (num < .01) {
#   number_format(trim = TRUE, accuracy = 1)(num)
# } else if  (num < 1) {
#   number_format(trim = TRUE, accuracy = .01)(num)
# } else {
#   number_format(trim = TRUE, accuracy = 1)(num)
# }))



################################################################################
################################### Boxplots ###################################
################################################################################

# dplyr version
# piipermitareayear <- subset(REVENUEFILE, !is.na(FMP)) %>%
#   dplyr::select(Year, REVENUE, InsideREV, InsideLANDED, PERMIT, Area) %>%
#   # dplyr::select(FMP, Year, InsideREV, InsideLANDED, PERMIT, DEALNUM) %>% # for dealers
#   # dplyr::select(Year, PERMIT, Area) %>%
#   filter(Area != "Other") %>% 
#   group_by(PERMIT, Area, Year) %>%
#   dplyr::summarize(
#     AllREV = sum(REVENUE, na.rm = T),
#     InsideREV = sum(InsideREV, na.rm = T),
#     InsideLANDED = sum(InsideLANDED, na.rm = T),
#     npermits = length(unique(PERMIT)),
#     # ndealers = length(unique(DEALNUM))
#     ) %>%
#   mutate(CONF =  npermits < 3) %>%
#   mutate(Percent = (InsideREV/AllREV)*100) %>% 
#   # mutate(CONF2 =  ndealers < 3) %>%
#   # mutate(FMP_CONF = ifelse(CONF == T, 'All Others', FMP)) %>%
#   ungroup()


# Generate date for boxplots # adapted from Katie's notes
PermitInsideRev <- aggregate(REVENUEFILE$InsideREV~REVENUEFILE$Year+REVENUEFILE$PERMIT+REVENUEFILE$Area, FUN=sum)
PermitOutsideRev <- aggregate(FIN$REVENUE~FIN$Year+FIN$PERMIT, FUN=sum)
names(PermitInsideRev) <-c("Year","PERMIT","Zone","InsideRev")
names(PermitOutsideRev) <-c("Year","PERMIT","OutsideRev")
# glimpse(PermitInsideRev)
PermitInsideRev <-merge(PermitInsideRev,PermitOutsideRev,by=c("PERMIT","Year"), all.x=TRUE, all.y=FALSE)
PermitInsideRev$Percent <- round((PermitInsideRev$InsideRev/PermitInsideRev$OutsideRev)*100,0)
PermitInsideRev$InsideRev <- round(PermitInsideRev$InsideRev,2)
PermitInsideRev <- PermitInsideRev %>% filter(Zone != "Other")

# # broadzone = "Fairways_North"
# # broadzone = "Fairways_South"
# broadzone = "Hudson_North"
# # broadzone = "Hudson_South"
# # ### replace underscores with space and capitalize each word (for plot title automation)
# broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", broadzone)), perl=TRUE)
# 
# # ggplot version
# PermitHN <- PermitInsideRev %>% filter(Zone=="Hudson_North")
# ggplot(data = PermitHN, mapping = aes(x = Year, y = Percent, fill=Year)) + 
#   # geom_boxplot(linetype = "dashed", outlier.shape = 1) +
#   stat_boxplot(geom ='errorbar') + 
#   geom_boxplot(show.legend = F) + 
#   # geom_boxplot(linetype = "dotted", color = "red") +
#   # geom_boxplot(aes(ymin=..lower.., ymax=..upper..)) + 
#   scale_fill_brewer(name = NULL, palette = "PuBu", 
#                     guide = guide_legend(reverse = TRUE)) +
#   
#   coord_flip() +
#   xlab(NULL) +
#   ylab("Percent Total Revenue by Permit") + 
#   theme_bw() +
#   ggtitle(paste0("Annual Permit Revenue Percentage Boxplots, ", broadz)) +
#   theme(text=element_text(size=10),
#         plot.title = element_text(hjust = 0.5, size=16))
# 
# 
# ggplot(data = PermitHN, aes(x = Year, y = Percent, fill=Year)) +
#   geom_boxplot(linetype = "dashed", outlier.shape = 1) +
#   stat_boxplot(aes(ymin = ..lower.., ymax = ..upper..), outlier.shape = 1) +
#   stat_boxplot(geom = "errorbar", aes(ymin = ..ymax..)) +
#   stat_boxplot(geom = "errorbar", aes(ymax = ..ymin..)) +
#   # scale_y_continuous(breaks = seq(4.5, 8.0, 0.5)) +
#   scale_fill_brewer(name = NULL, palette = "PuBu", 
#                     guide = guide_legend(reverse = TRUE)) +
#   coord_flip() +
#   labs(title = paste0("Annual Permit Revenue Percentage Boxplots, ", broadz),
#        x = NULL,
#        y = "Percent Total Revenue by Permit") +
#   theme_bw() +
#   # theme_classic() + # remove panel background and gridlines
#   theme(legend.position="none", plot.title = element_text(hjust = 0.5,  # hjust = 0.5 centers the title
#                                   size = 14,
#                                   face = "bold"),
#         panel.border = element_rect(linetype = "solid",
#                                     colour = "black", fill = "NA", size = 0.5))
# 
# # base version
# boxplot(PermitHN$Percent~PermitHN$Year, 
#         horizontal=TRUE, 
#         main=broadz,
#         xlab='Percent Total Revenue by Permit', 
#         col=c("cadetblue1","cadetblue2","cadetblue3","cadetblue","cadetblue4"))
cat("\n\n")

# iterate over all areas and produce box plot
for (z in unique(PermitInsideRev$Zone)) {
  Permitboxplot <- PermitInsideRev %>% filter(Zone==z)
  broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", z)), perl=TRUE)
### ggplot version ###
  # par(family = "serif")
  # windowsFonts(Times=windowsFont("Times New Roman"))
  boxplot <- ggplot(data = Permitboxplot, aes(x = Year, y = Percent, fill=Year)) +
  geom_boxplot(linetype = "dashed", outlier.shape = 1) +
  stat_boxplot(aes(ymin = ..lower.., ymax = ..upper..), outlier.shape = 1) +
  stat_boxplot(geom = "errorbar", aes(ymin = ..ymax..)) +
  stat_boxplot(geom = "errorbar", aes(ymax = ..ymin..)) +
  # scale_y_continuous(breaks = seq(4.5, 8.0, 0.5)) +
  scale_fill_brewer(name = NULL, palette = "PuBu",
                    guide = guide_legend(reverse = TRUE)) +
  coord_flip() +
  labs(title = paste0("Annual Permit Revenue Percentage Boxplots, ", broadz),
       x = NULL,
       y = "Percent Total Revenue by Permit") +
  theme_bw() +
  # theme_classic() + # remove panel background and gridlines
  # theme(text=element_text(family="serif"),
  theme(text=element_text(size=10),
        legend.position="none", plot.title = element_text(hjust = 0.5,size = 14), # hjust = 0.5 centers the title
        panel.border = element_rect(linetype = "solid",
                                    colour = "black", 
                                    fill = "NA", 
                                    size = 0.5))
  
# ### base version ###
# boxplot <- boxplot(Permitboxplot$Percent~Permitboxplot$Year,
#         horizontal=TRUE,
#         main=broadz,
#         xlab='Percent Total Revenue by Permit',
#         col=c("cadetblue1","cadetblue2","cadetblue3","cadetblue","cadetblue4"))

print(boxplot)
# save to file
ggsave(paste0(output_fpermit, "/boxplot_", substr(broadzone_underscore,0,30),".png"), plot = boxplot)
# save to file - base functions
# png(paste0(output_fpermit,"/boxplot_",broadzone,".png"))
# print(boxplot)
# dev.off()
rm(boxplot)
# alternatively, save plot as png and call
# knitr::include_graphics("rrtools-steps-carbon.png")
# cat("\n\n")
}


cat("\n\n")


# from original rscript - permit percentages are off
# PERMIT_DATA <- aggregate(InsideREV~Year+PERMIT+Area, data=REVENUEFILE[REVENUEFILE$Area!='Other',],FUN=sum)
# PERMIT_TOTAL <- aggregate(REVENUE~Year+PERMIT, data=FIN, FUN=sum)
# PERMIT_DATA <- merge(PERMIT_DATA,PERMIT_TOTAL,
#                    by.x=c('Year','PERMIT'),by.y=c('YEAR','PERMIT'), all.x=TRUE, all.y=FALSE)
# PERMIT_DATA$PERMIT_PCT <- 100*PERMIT_DATA$InsideREV/PERMIT_DATA$REVENUE
# ZONE_NAMES <- unique(REVENUEFILE$Area)[!unique(REVENUEFILE$Area) %in% "Other"]
# 
# for (i in ZONE_NAMES) {
#   TEMP <- PERMIT_DATA[PERMIT_DATA$Area==i,]
#   NCOLORS <- length(unique(TEMP$Year))
#   myColours <- brewer.pal( NCOLORS,"RdBu")
#   pdf(file.path(output_f, paste0(project_name,"_REV_PCT_PERMIT_",i,".pdf")))
#   print(boxplot(PERMIT_PCT~Year, horizontal=TRUE,data=TEMP,
#                 xlab='Percent Total PERMIT Revenue',par.settings = my.settings,las=2,par(mar=c(5,11,4,2)+0.1),col=myColours))
#   dev.off()
#   rm(TEMP)
# }
  


```

```{r fishery_dependence, results='asis', eval=fishery_dependence_section} 
 
# create new folder for section
dir.create(file.path(output_f, "fisheryd"), showWarnings = FALSE)
output_ffisherydependence = file.path(output_f, "fisheryd")

# add effort tables of trips and vessels
add_effort_tables = TRUE

# seperate tables by year
seperate_tables_by_year = TRUE

cat("<br> ")

cat("\n\n")

cat("### Species Dependence \n")

cat("\n\n")

cat("The tables below indicate the top ten species deriving the most revenue from ", if(number_of_areas > 1) {paste0("each")} else {paste0("the")}," area by year. Additional information includes landings, and effort (Days-at-Sea, or DAS), occurring within the ",if(number_of_areas > 1) {paste0("areas")} else {paste0("area")}," of interest, as a percentage of totals generated by that species across the entire region by year",if(add_effort_tables) {paste0("and the total number of trips and vessels from ", if(number_of_areas > 1) {paste0("each")} else {paste0("the")}," area by year, FMP, species, and port. Trips with less than three permits or dealers have been removed to protect data confidentiality.")} else {paste0(".")}," The category \"All Others\" refers to gear type categories with less than three permits or dealers impacted to protect data confidentiality.") 

cat("\n\n\n")


# test <- REVENUEFILE %>% filter(is.na(TRIPID))

vessel_trip_all_areas_by_year <- REVENUEFILE %>% 
  # filter(Area == zone) %>%   # filter by area
  filter(Area != "Other") %>% 
  dplyr::select(IDNUM, PERMIT, Year, Area) %>%
  group_by(Year, Area) %>%
  dplyr::summarize(
    nTrips = length(unique(IDNUM)),
    nVessels = length(unique(PERMIT)),
    ) %>% 
  arrange(desc(Year)) %>% 
  mutate(nTrips = comma_format(trim = TRUE)(as.numeric(nTrips))) %>%
  mutate(nVessels = comma_format(trim = TRUE)(as.numeric(nVessels))) %>%
  ungroup() %>% 
  dplyr::rename("Number of Trips"= nTrips,
                "Number of Vessels" = nVessels)

vessel_trip_all_areas_by_year_fmp <- REVENUEFILE %>%
  # filter(Area == zone) %>% 
  filter(Area != "Other") %>% 
  dplyr::select(IDNUM, FMP, PERMIT, Year, Area, DEALNUM) %>%
  group_by(Year, FMP, Area) %>%
  dplyr::summarize(
    nTrips = length(unique(IDNUM)),
    nVessels = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM)),
    ) %>% 
  # mutate(CONF = nVessels < 3 | nTrips < 3) %>%
  mutate(CONF = nVessels < 3 | ndealers < 3) %>%
  mutate(FMP_CONF = ifelse(CONF == T, 'All Others', FMP)) %>%
  filter(FMP_CONF != 'All Others') %>% 
  ungroup() %>%
  dplyr::select(Year, FMP_CONF, nTrips, nVessels, Area) %>%
  group_by(FMP_CONF, Year, Area) %>%
  dplyr::summarize(
    nTrips = sum(nTrips, na.rm = T),
    nVessels = sum(nVessels, na.rm = T)) %>% 
  dplyr::rename("FMP"= FMP_CONF) %>% 
  relocate(Year, Area, FMP, nTrips, nVessels) %>%
  arrange(desc(Year)) %>% 
  mutate(nTrips = comma_format(trim = TRUE)(as.numeric(nTrips))) %>%
  mutate(nVessels = comma_format(trim = TRUE)(as.numeric(nVessels))) %>%
  ungroup() %>% 
  dplyr::rename("Number of Trips"= nTrips,
                "Number of Vessels" = nVessels)

vessel_trip_all_areas_by_year_sppnm <- REVENUEFILE %>%
  # filter(Area == zone) %>% 
  filter(Area != "Other") %>% 
  dplyr::select(IDNUM, SPPNM, PERMIT, Year, Area, DEALNUM) %>%
  mutate(SPPNM = ifelse(is.na(SPPNM), 'All Others', SPPNM)) %>%
  group_by(Year, Area, SPPNM) %>%
  dplyr::summarize(
    nTrips = length(unique(IDNUM)),
    nVessels = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM)),
    ) %>% 
  # mutate(CONF = nVessels < 3 | nTrips < 3) %>%
  # mutate(CONF = nVessels < 3) %>%
  mutate(CONF = nVessels < 3 | ndealers < 3) %>%
  mutate(SPPNM_CONF = ifelse(CONF == T, 'All Others', SPPNM)) %>%
  filter(SPPNM_CONF != 'All Others') %>% 
  ungroup() %>%
  dplyr::select(Year, SPPNM_CONF, nTrips, nVessels, Area) %>%
  group_by(SPPNM_CONF, Year, Area) %>%
  dplyr::summarize(
    nTrips = sum(nTrips, na.rm = T),
    nVessels = sum(nVessels, na.rm = T)) %>% 
  mutate(SPPNM_CONF = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(SPPNM_CONF), perl=TRUE)) %>% 
  dplyr::rename("Species"= SPPNM_CONF) %>% 
  relocate(Year, Area, Species, nTrips, nVessels) %>% 
  arrange(desc(Year)) %>% 
  mutate(nTrips = comma_format(trim = TRUE)(as.numeric(nTrips))) %>%
  mutate(nVessels = comma_format(trim = TRUE)(as.numeric(nVessels))) %>%
  ungroup() %>% 
  dplyr::rename("Number of Trips"= nTrips,
                "Number of Vessels" = nVessels)

vessel_trip_all_areas_by_year_port <- REVENUEFILE %>%
  # filter(Area == zone) %>% 
  filter(Area != "Other") %>% 
  dplyr::select(Year, PORTLND1, STATE1, IDNUM, PERMIT, Area, DEALNUM) %>%
  mutate("PORTLND1" = str_to_title(PORTLND1)) %>% 
  mutate("PORTLANDED" = str_c(PORTLND1, ", ", STATE1)) %>% 
  group_by(Year, Area, PORTLANDED) %>%
  dplyr::summarize(
    nTrips = length(unique(IDNUM)),
    nVessels = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM)),
    ) %>% 
  # mutate(CONF = nVessels < 3 | nTrips < 3) %>%
  # mutate(CONF = nVessels < 3) %>%
  mutate(CONF = nVessels < 3 | ndealers < 3) %>%
  mutate(PORTLANDED_CONF = ifelse(CONF == T, 'All Others', PORTLANDED)) %>%
  ungroup() %>%
  dplyr::select(Year, PORTLANDED_CONF, nTrips, nVessels, Area) %>%
  group_by(PORTLANDED_CONF, Year, Area) %>%
  filter(PORTLANDED_CONF != 'All Others') %>%
  dplyr::summarize(
    nTrips = sum(nTrips, na.rm = T),
    nVessels = sum(nVessels, na.rm = T)) %>% 
  dplyr::rename("Port"= PORTLANDED_CONF) %>% 
  relocate(Year, Area, Port, nTrips, nVessels) %>% 
  arrange(desc(Year)) %>% 
  mutate(nTrips = comma_format(trim = TRUE)(as.numeric(nTrips))) %>%
  mutate(nVessels = comma_format(trim = TRUE)(as.numeric(nVessels))) %>%
  ungroup() %>% 
  dplyr::rename("Number of Trips"= nTrips,
                "Number of Vessels" = nVessels)

# use species_of_interest table
# species_of_interest$SPPNAME <- gsub("[[:space:]]$", "", species_of_interest$SPPNAME) # trim all possible whitespaces at end 
species_of_interest <- offshoreWind::species_of_interest
# write.csv(species_of_interest, file="C:/Users/dennis.corvi/Documents/R/Projects/OffshoreWindDev/offshorew_package_output/fisheryd/soi.csv", row.names = FALSE)
species_of_interest <- species_of_interest %>% dplyr::select(SPPNAME, NESPP3)

# as_tibble(REVENUEFILE)
# Days at Sea are rounded up to the nearest day
# PII fixed for all areas

piisppnm <- subset(REVENUEFILE, !is.na(SPPNM)) %>%
  # dplyr::select(NESPP3, Year, REVENUE, QTYKEPT, InsideREV, InsideLANDED, PERMIT, Area, DAS, InsideDAS) %>%
  dplyr::select(NESPP3, Year, REVENUE, QTYKEPT, InsideREV, InsideLANDED, PERMIT, Area, DAS, InsideDAS, DEALNUM) %>% # for dealers
  filter(Area != "Other") %>% 
  # filter(NESPP3 %in% species_of_interest$NESPP3) %>%
  left_join(., species_of_interest, by="NESPP3" ) %>% #join to getter better species names
  # mutate(NESPP3 = as.character(NESPP3)) %>% 
  mutate(NESPP3 = ifelse(NESPP3 %in% species_of_interest$NESPP3, NESPP3, "NULL")) %>% # lump everything that isnt a species of interest together 
  mutate(SPPNM = ifelse(NESPP3 %in% species_of_interest$NESPP3, SPPNAME, "All Others")) %>% # do same as above but for names
  group_by(Year, SPPNM, NESPP3, Area) %>%
  # mutate_if(is.numeric, as.character) %>% 
  dplyr::summarize(
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    InsideDAS = sum(InsideDAS, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 =  ndealers < 3) %>%
  mutate(CONF =  npermits < 3 | ndealers < 3) %>%
  mutate(NESPP3_CONF = ifelse(CONF == T, 'NULL', NESPP3)) %>%
  mutate(SPPNM_CONF = ifelse(CONF == T, 'All Others', SPPNM)) %>% #have to do same as above toget names into next sum round
  ungroup() 
  
spptotal <- FIN %>% left_join(., species_of_interest, by="NESPP3" ) %>% 
	mutate(NESPP3 = ifelse(NESPP3 %in% species_of_interest$NESPP3, NESPP3, "NULL")) %>%
	  group_by(Year, NESPP3) %>%
  # mutate_if(is.numeric, as.character) %>% 
  dplyr::summarize(
    AllREV = sum(REVENUE, na.rm = T),
    AllLand = sum(QTYKEPT, na.rm = T),
    AllDAS = sum(DAS, na.rm = T)
       ) %>%
    ungroup() 
	
piisppnm <- merge(piisppnm,spptotal, all=TRUE,by.x=c("Year","NESPP3"),by.y=c("Year","NESPP3"))	
piisppnm <- piisppnm %>% group_by(Year, SPPNM_CONF, NESPP3_CONF, Area) %>%
  dplyr::summarize(
    ysa_AllREV = sum(AllREV, na.rm = T),
    ysa_AllLAND = sum(AllLand, na.rm = T),
    ysa_AllDAS = sum(AllDAS, na.rm = T),
    ysa_rev = sum(InsideREV, na.rm = T),
    ysa_land = sum(InsideLANDED, na.rm = T),
    ysa_das = sum(InsideDAS, na.rm = T),
    npermits = sum(npermits, na.rm = T)) %>% 
  dplyr::rename("SPPNM"= SPPNM_CONF, "NESPP3"=NESPP3_CONF) %>% 
  mutate(RevPercOfTotal = (ysa_rev/ysa_AllREV)*100) %>% 
  mutate(LandPercOfTotal = (ysa_land/ysa_AllLAND)*100) %>% 
  mutate(DASPercOfTotal = (ysa_das/ysa_AllDAS)*100) %>% 
  arrange(desc(RevPercOfTotal))
  
# piisppnm

if (save_files == "c" | save_files == "b" ) {
  write.csv(piisppnm, file=file.path(output_ffisherydependence,"stattables.csv"), row.names=FALSE)
}

# Percent columns columns
# remove permit number column
allareasppnm_table <- piisppnm[ , !(names(piisppnm) %in% "npermits" )] %>% 
  ungroup() %>% 
  dplyr::rename("Species"= SPPNM, 
           "All Revenue" = ysa_AllREV, "All Landings (Pounds)" = ysa_AllLAND, "All Days at Sea" = ysa_AllDAS, 
           "Inside Revenue" = ysa_rev, "Inside Landings (Pounds)" = ysa_land, "Inside DAS" = ysa_das,
           "Revenue as % of Total" = RevPercOfTotal, "Landings as % of Total" = LandPercOfTotal, 
         "DAS as % of Total" = DASPercOfTotal) %>% 
  dplyr::select(Year, Area, Species, `Revenue as % of Total`, `Landings as % of Total`, `DAS as % of Total`)

#### get rev and landing percentage tables for all areas
#   selectsppnm_table <- allareasppnm_table %>% 
#     arrange(desc(Year, `Revenue as % of Total`)) %>% 
#     # top_n(., n=10, wt=`Revenue as % of Total`) %>% 
#     mutate(Species = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(Species), perl=TRUE)) %>% 
#     mutate(Area = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", Area)), perl=TRUE)) %>% 
#     mutate(`Revenue as % of Total` = comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(`Revenue as % of Total`))) %>% 
#     mutate(`Landings as % of Total` = comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(`Landings as % of Total`))) %>% 
#     mutate(`DAS as % of Total` = comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(`DAS as % of Total`)))
#   
# write.csv(selectsppnm_table, file=file.path(output_ffisherydependence,"selectsppnm_table.csv"), row.names=FALSE)

for (zone in allZones) {
  figure_num = figure_num + 1
  zone <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub(" ","_", zone), perl=TRUE) # make name pretty
  broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("_"," ", zone), perl=TRUE) # make name pretty
  # cat("\raggedright")
  # cat(paste0("*", broadz, "*", "  ", "\n\n"),"  ") # display name of area
  # filter by area
  allsppnm_table <- allareasppnm_table %>% 
    filter(Area == zone) %>% 
    arrange(desc(Year, `Revenue as % of Total`))
  
  if (add_effort_tables) {
  vessel_trip_by_year <- vessel_trip_all_areas_by_year %>% filter(Area == zone) %>% dplyr::select(-Area)
  cat("\n\n")
  # cat("#### Total Number of Trips and Vessels by Year \n\n")
  print(kable(vessel_trip_by_year, caption = paste0('Total Number of Trips and Vessels by Year, ', broadz), align=c('l', 'r', 'r')))
  cat("\n\n")
  cat("\n\n") }
  
  for (yr in sort(as.numeric(unique(allsppnm_table$Year)), decreasing = TRUE))  { # cycle through years
    # cat(paste0("*", yr, "*", "  ", "\n\n"),"  ") # display year of area data
    allsppnm_table_yr <- allsppnm_table %>% 
      filter(yr == Year) %>% 
      dplyr::select(-Year) %>%
      arrange(desc(`Revenue as % of Total`)) %>% 
      top_n(., n=10, wt=`Revenue as % of Total`) %>% 
      mutate(Species = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(Species), perl=TRUE)) %>% 
      mutate(Area = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", Area)), perl=TRUE)) %>% 
      mutate(`Revenue as % of Total` = comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(`Revenue as % of Total`))) %>% 
      mutate(`Landings as % of Total` = comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(`Landings as % of Total`))) %>% 
      mutate(`DAS as % of Total` = comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(`DAS as % of Total`)))
      
    # uncomment below if alphabetical sorting is require(package)
    # allsppnm_table <- allsppnm_table %>% arrange(Species, .by_group = TRUE)
    # make Species names lowercase and areas proper case
    # allsppnm_table$Species <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(allsppnm_table$Species), perl=TRUE)
    # allsppnm_table$Area <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", allsppnm_table$Area)), perl=TRUE)
    # ##### allsppnm_table <- rbind(allsppnm_table, c("**Total**", colSums(allsppnm_table[,4]), colSums(allsppnm_table[,4])))
    # allsppnm_table$`Revenue as % of Total` <- comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(allsppnm_table$`Revenue as % of Total`))
    # allsppnm_table$`Landings as % of Total` <- comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(allsppnm_table$`Landings as % of Total`))
    # allsppnm_table$`DAS as % of Total` <- comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(allsppnm_table$`DAS as % of Total`))
    cat("\n\n")
    allsppnm_table_yr <- allsppnm_table_yr %>% dplyr::select(Species, `Revenue as % of Total`, `Landings as % of Total`, `DAS as % of Total`)
    
    print(kable(allsppnm_table_yr, caption = paste0('Percentages of Total, Revenue, Landings, and Days-at-Sea for Species of Interest, ', broadz, ', ', yr), align=c('l', 'l', 'l', 'l')))
  cat("\n\n")
  
    if (add_effort_tables) {
    vessel_trip_by_year_fmp <- vessel_trip_all_areas_by_year_fmp %>% filter(Area == zone) %>% dplyr::select(-Area)
    vessel_trip_by_year_sppnm <- vessel_trip_all_areas_by_year_sppnm %>% filter(Area == zone) %>% dplyr::select(-Area)
    vessel_trip_by_year_port <- vessel_trip_all_areas_by_year_port %>% filter(Area == zone) %>% dplyr::select(-Area)
    if (seperate_tables_by_year) {
      cat("\n\n")
      # cat("#### Total Number of Trips and Vessels by FMP")
      vessel_trip_by_year_fmp_table <- vessel_trip_by_year_fmp %>% filter(Year == yr) %>% dplyr::select(-Year)
      print(kable(vessel_trip_by_year_fmp_table, caption = paste0('Total Number of Trips and Vessels by FMP, ', broadz, ', ',yr), align=c('l', 'r', 'r')))
      cat("\n\n")
      cat("\n\n")
      # cat("#### Total Number of Trips and Vessels by Species")
      vessel_trip_by_year_sppnm_table <- vessel_trip_by_year_sppnm %>% filter(Year == yr) %>% dplyr::select(-Year)
      print(kable(vessel_trip_by_year_sppnm_table, caption = paste0('Total Number of Trips and Vessels by Species, ', broadz, ', ',yr), align=c('l', 'r', 'r')))
      cat("\n\n")
      cat("\n\n")
      # cat("#### Total Number of Trips and Vessels by Port")
      vessel_trip_by_year_port_table <- vessel_trip_by_year_port %>% filter(Year == yr) %>% dplyr::select(-Year)
      print(kable(vessel_trip_by_year_port_table, caption = paste0('Total Number of Trips and Vessels by Port, ', broadz, ', ',yr), align=c('l', 'r', 'r')))
  } else {
    cat("#### Total Number of Trips and Vessels by FMP")
    print(kable(vessel_trip_by_year_fmp, caption = paste0('Total Number of Trips and Vessels by Year and FMP, ', broadz), align=c('l','l', 'r', 'r')))
    cat("\n\n")
    cat("\n\n")
    cat("#### Total Number of Trips and Vessels by Species")
    print(kable(vessel_trip_by_year_sppnm, caption = paste0('Total Number of Trips and Vessels by Year and Species, ', broadz), align=c('l','l', 'r', 'r')))
    cat("\n\n")
    cat("\n\n")
    cat("#### Total Number of Trips and Vessels by Port")
    print(kable(vessel_trip_by_year_port, caption = paste0('Total Number of Trips and Vessels by Year and Port, ', broadz), align=c('l','l', 'r', 'r')))
      } # end seperate_tables_by_year
    } # end add_effort_tables
  
  }
  # print(kable(allsppnm_table, caption = paste0('Percentages of Total, Revenue, Landings, and Days-at-Sea for Species of Interest, ', broadz), align=c('l', 'l', 'l', 'l', 'l')))
  cat("\n\n")
  

  } # end area for loop

cat("<br> ")

```







```{r select_gear_custom_table, include=FALSE, eval = select_gear_custom}  
###############################
#### Set Select Gear Types ####
###############################

# New gear types specificed by Doug and Ben
select_gear_codes <- as_tibble(REVENUEFILE)

select_gear_codes <- select_gear_codes %>% 
  mutate(gearcat_new = "") %>% 
  # select(IDNUM, GEARCODE, gearcat_new) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('DRM','DRO','DRU'), 'DREDGE-OTHER', gearcat_new)) %>%
  mutate(gearcat_new = ifelse(GEARCODE %in% c('DRC'), 'DREDGE-CLAM', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('DRS', 'DTS', 'DTC', 'DSC'), 'DREDGE-SCALLOP', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('GNS'), 'GILLNET-SINK', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('GND', 'GNO','GNR','GNT'), 'GILLNET-OTHER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('FYK','WEI','TRP'), 'WEIR-TRAP', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('PUR'), 'SEINE-PURSE', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('SED','SEH','SES','STS'), 'SEINE-OTHER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('HND'), 'HANDLINE', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('RAK','DIV','HRP','CST'), 'HAND-OTHER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('OBP', 'OHS','OTB','OTC','OTF','OTO','OTR','OTS','OTT','PTB', 'TTS'), 'TRAWL-BOTTOM', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('PTM','OTM'), 'TRAWL-MIDWATER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('LLB'), 'LONGLINE-BOTTOM', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('LLP'), 'LONGLINE-PELAGIC', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('PTC','PTE','PTF','PTH', 'PTO','PTS','PTW','PTX'), 'POT-OTHER', gearcat_new)) %>% 
  mutate(gearcat_new = ifelse(GEARCODE %in% c('PTL'), 'POT-LOBSTER', gearcat_new)) %>%  
  mutate(gearcat_new = ifelse(GEARCODE %in% c('OTH'), 'OTHER', gearcat_new)) %>%  
  mutate(gearcat_new = ifelse(gearcat_new == "", '[blank]', gearcat_new)) 
  
###################################
#### Set Select Gear Types end ####
###################################

################################################################
#### Create Dataframe of ALL QTYKEPT and REVENUE, aggregated by REGIME 
## 96 observations: 16 GEAR, 2 Regimes, 3 months   ####
################################################################

select_gear_codes2<-select_gear_codes %>%
    mutate(REGIME = ifelse(Year <= 2014, 1, 2)) %>%
    dplyr::select(gearcat_new, REGIME, MONTH, PERMIT, DEALNUM, IDNUM, QTYKEPT, REVENUE) %>% # for dealers
    dplyr::distinct(gearcat_new, REGIME, MONTH, PERMIT, DEALNUM, IDNUM, QTYKEPT, REVENUE)

# PII fixed for all areas; aggregated at the REGIME level (2010-2014 and 2015-2019)
allactive <- subset(select_gear_codes2, !is.na(gearcat_new)) %>%
  # dplyr::select(gearcat_new, Year, InsideREV, InsideLANDED, PERMIT, Area ) %>%
  dplyr::select(gearcat_new, REGIME, MONTH, PERMIT, DEALNUM, IDNUM, QTYKEPT, REVENUE) %>% # for dealers
  filter(MONTH  >=9 & MONTH<=11) %>% 
  group_by(gearcat_new, REGIME, MONTH) %>%
  dplyr::summarize(
    nTrips = length(unique(IDNUM)),
    TotalRev = sum(REVENUE, na.rm = T),
    TotalLand = sum(QTYKEPT, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # mutate(CONF =  npermits < 3) %>%
  # mutate(CONF2 = ndealers < 3) %>%
  ungroup() %>%
  # dplyr::select(-starts_with("gearcat_new")) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, npermits, gearcat_new_CONF) %>%
  group_by(gearcat_new, REGIME, MONTH) %>%
  dplyr::summarize(
    Revenue_SM = sum(TotalRev, na.rm = T),
    Pounds_SM = sum(TotalLand, na.rm = T),
    npermits_SM = sum(npermits, na.rm = T),
    ntrips_SM = sum(nTrips, na.rm = T)) %>% 
  dplyr::rename("Gear_Type"= gearcat_new) 





################################################################
#### Create Dataframe of ALL QTYKEPT and REVENUE, aggregated by REGIME Inside each Area
## 96 observations: 16 GEAR, 2 Regimes, 3 months, 4 Area   ####
################################################################

# PII fixed for all areas; aggregated at the REGIME level (2010-2014 and 2015-2019)
piiselect_gear_codes <- subset(select_gear_codes, !is.na(gearcat_new)) %>%
  mutate(REGIME = ifelse(Year <= 2014, 1, 2)) %>%
  # dplyr::select(gearcat_new, Year, InsideREV, InsideLANDED, PERMIT, Area ) %>%
  dplyr::select(gearcat_new, REGIME, MONTH, InsideREV, InsideLANDED, PERMIT, Area, DEALNUM, IDNUM) %>% # for dealers
  filter(Area != "Other") %>% 
  filter(MONTH  >=9 & MONTH<=11) %>% 

  group_by(gearcat_new, REGIME, MONTH, Area) %>%
  dplyr::summarize(
    nTrips = length(unique(IDNUM)),
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  # dplyr::select(-starts_with("gearcat_new")) %>%
  # dplyr::select(Year, InsideREV, InsideLANDED, npermits, gearcat_new_CONF) %>%
    ungroup() %>%
  group_by(gearcat_new, REGIME, MONTH,Area) %>%
  dplyr::summarize(
    Revenue = sum(InsideREV, na.rm = T),
    Pounds = sum(InsideLANDED, na.rm = T),
    npermits = sum(npermits, na.rm = T),
    ntrips = sum(nTrips, na.rm = T)) %>% 
  dplyr::rename("Gear_Type"= gearcat_new) 



################################################################
#### Create Dataframe of ALL QTYKEPT and REVENUE, aggregated by REGIME in OTHER months 
################################################################

# PII fixed for all areas; aggregated at the REGIME level (2010-2014 and 2015-2019)
piiselect_gear_codes3 <- subset(select_gear_codes, !is.na(gearcat_new)) %>%
  mutate(REGIME = ifelse(Year <= 2014, 1, 2)) %>%
  # dplyr::select(gearcat_new, Year, InsideREV, InsideLANDED, PERMIT, Area ) %>%
  dplyr::select(gearcat_new, REGIME, MONTH, InsideREV, InsideLANDED, PERMIT, Area, DEALNUM, IDNUM) %>% # for dealers
  filter(Area != "Other") %>% 
  filter(MONTH  <9 | MONTH>11) %>% 

  group_by(gearcat_new, REGIME, Area) %>%
  dplyr::summarize(
    nTrips = length(unique(IDNUM)),
    InsideREV = sum(InsideREV, na.rm = T),
    InsideLANDED = sum(InsideLANDED, na.rm = T),
    npermits = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM))
    ) %>%
  ungroup() %>%
  group_by(gearcat_new, REGIME, Area) %>%
  dplyr::summarize(
    Revenue_OM = sum(InsideREV, na.rm = T),
    Pounds_OM = sum(InsideLANDED, na.rm = T),
    npermits_OM = sum(npermits, na.rm = T),
    ntrips_OM = sum(nTrips, na.rm = T)) %>% 
  dplyr::rename("Gear_Type"= gearcat_new) 

areaname<-unique(piiselect_gear_codes$Area)

# expand allarea by 4 and fillin Regime
allactive<-data.frame(Area=areaname) %>% 
  tidyr::crossing(allactive) 




colnames(piiselect_gear_codes)
colnames(allactive)
# expand piiselect_gear_codes3 3 and fillin MONTHS

select_months<-unique(piiselect_gear_codes$MONTH)
piiselect_gear_codes3<-data.frame(MONTH=select_months) %>% 
  tidyr::crossing(piiselect_gear_codes3) 

colnames(piiselect_gear_codes3)


final_table<-base::merge(piiselect_gear_codes,piiselect_gear_codes3, by=c("Gear_Type", "REGIME", "MONTH", "Area"),all=TRUE)

final_table<-base::merge(final_table,allactive, by=c("Gear_Type", "REGIME", "MONTH","Area"),all=TRUE)


final_table[is.na(final_table)] <- 0

final_table$insidePounds_over_totalSM<-final_table$Pounds/(final_table$Pounds_SM)
final_table$insidePounds_over_totalOM<-final_table$Pounds/(final_table$Pounds+final_table$Pounds_OM)

final_table$insideR_over_totalSM<-final_table$Revenue/(final_table$Revenue_SM)
final_table$insideR_over_totalOM<-final_table$Revenue/(final_table$Revenue+final_table$Revenue_OM)


write.csv(final_table, file=file.path(root.table.path,paste0("table_update",todaysdate,".csv")), row.names=FALSE)
#Have to save this somewhere


  

```





















```{r unique_permits_and_DOCIDs_tables, results='asis', eval=trip_and_vessel_section} 

# cat("\\newpage") 
cat("### Number of Trips and Vessels \n")

cat("The tables below indicate the total number of trips and vessels from ", if(number_of_areas > 1) {paste0("each")} else {paste0("the")}," area by year, FMP, species, and port. Trips with less than three permits or dealers have been removed to protect data confidentiality.") 

cat("\n\n\n")

cat("<br> ")

# seperate tables by year
seperate_tables_by_year = TRUE

vessel_trip_all_areas_by_year <- REVENUEFILE %>% 
  # filter(Area == zone) %>%   # filter by area
  filter(Area != "Other") %>% 
  dplyr::select(IDNUM, PERMIT, Year, Area) %>%
  group_by(Year, Area) %>%
  dplyr::summarize(
    nTrips = length(unique(IDNUM)),
    nVessels = length(unique(PERMIT)),
    ) %>% 
  arrange(desc(Year)) %>% 
  mutate(nTrips = comma_format(trim = TRUE)(as.numeric(nTrips))) %>%
  mutate(nVessels = comma_format(trim = TRUE)(as.numeric(nVessels))) %>%
  ungroup() %>% 
  dplyr::rename("Number of Trips"= nTrips,
                "Number of Vessels" = nVessels)

vessel_trip_all_areas_by_year_fmp <- REVENUEFILE %>%
  # filter(Area == zone) %>% 
  filter(Area != "Other") %>% 
  # dplyr::select(IDNUM, FMP, PERMIT, Year, Area) %>%
  dplyr::select(IDNUM, FMP, PERMIT, Year, Area, DEALNUM) %>%
  group_by(Year, FMP, Area) %>%
  dplyr::summarize(
    nTrips = length(unique(IDNUM)),
    nVessels = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM)),
    ) %>% 
  # mutate(CONF = nVessels < 3 | nTrips < 3) %>%
  # mutate(CONF = nVessels < 3) %>%
  mutate(CONF = nVessels < 3 | ndealers < 3) %>%
  mutate(FMP_CONF = ifelse(CONF == T, 'All Others', FMP)) %>%
  filter(FMP_CONF != 'All Others') %>% 
  ungroup() %>%
  dplyr::select(Year, FMP_CONF, nTrips, nVessels, Area) %>%
  group_by(FMP_CONF, Year, Area) %>%
  dplyr::summarize(
    nTrips = sum(nTrips, na.rm = T),
    nVessels = sum(nVessels, na.rm = T)) %>% 
  dplyr::rename("FMP"= FMP_CONF) %>% 
  relocate(Year, Area, FMP, nTrips, nVessels) %>%
  arrange(desc(Year)) %>% 
  mutate(nTrips = comma_format(trim = TRUE)(as.numeric(nTrips))) %>%
  mutate(nVessels = comma_format(trim = TRUE)(as.numeric(nVessels))) %>%
  ungroup() %>% 
  dplyr::rename("Number of Trips"= nTrips,
                "Number of Vessels" = nVessels)

vessel_trip_all_areas_by_year_sppnm <- REVENUEFILE %>%
  # filter(Area == zone) %>% 
  filter(Area != "Other") %>% 
  # dplyr::select(IDNUM, SPPNM, PERMIT, Year, Area) %>%
  dplyr::select(IDNUM, SPPNM, PERMIT, Year, Area, DEALNUM) %>%
  mutate(SPPNM = ifelse(is.na(SPPNM), 'All Others', SPPNM)) %>%
  group_by(Year, Area, SPPNM) %>%
  dplyr::summarize(
    nTrips = length(unique(IDNUM)),
    nVessels = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM)),
    ) %>% 
  # mutate(CONF = nVessels < 3 | nTrips < 3) %>%
  # mutate(CONF = nVessels < 3) %>%
  mutate(CONF = nVessels < 3 | ndealers < 3) %>%
  mutate(SPPNM_CONF = ifelse(CONF == T, 'All Others', SPPNM)) %>%
  filter(SPPNM_CONF != 'All Others') %>% 
  ungroup() %>%
  dplyr::select(Year, SPPNM_CONF, nTrips, nVessels, Area) %>%
  group_by(SPPNM_CONF, Year, Area) %>%
  dplyr::summarize(
    nTrips = sum(nTrips, na.rm = T),
    nVessels = sum(nVessels, na.rm = T)) %>% 
  mutate(SPPNM_CONF = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(SPPNM_CONF), perl=TRUE)) %>% 
  dplyr::rename("Species"= SPPNM_CONF) %>% 
  relocate(Year, Area, Species, nTrips, nVessels) %>% 
  arrange(desc(Year)) %>% 
  mutate(nTrips = comma_format(trim = TRUE)(as.numeric(nTrips))) %>%
  mutate(nVessels = comma_format(trim = TRUE)(as.numeric(nVessels))) %>%
  ungroup() %>% 
  dplyr::rename("Number of Trips"= nTrips,
                "Number of Vessels" = nVessels)

vessel_trip_all_areas_by_year_port <- REVENUEFILE %>%
  # filter(Area == zone) %>% 
  filter(Area != "Other") %>% 
  # dplyr::select(Year, PORTLND1, STATE1, IDNUM, PERMIT, Area) %>%
  dplyr::select(Year, PORTLND1, STATE1, IDNUM, PERMIT, Area, DEALNUM) %>% # for dealers
  mutate("PORTLND1" = str_to_title(PORTLND1)) %>% 
  mutate("PORTLANDED" = str_c(PORTLND1, ", ", STATE1)) %>% 
  group_by(Year, Area, PORTLANDED) %>%
  dplyr::summarize(
    nTrips = length(unique(IDNUM)),
    nVessels = length(unique(PERMIT)),
    ndealers = length(unique(DEALNUM)),
    ) %>% 
  # mutate(CONF = nVessels < 3 | nTrips < 3) %>%
  # mutate(CONF = nVessels < 3) %>%
  mutate(CONF = nVessels < 3 | ndealers < 3) %>%
  mutate(PORTLANDED_CONF = ifelse(CONF == T, 'All Others', PORTLANDED)) %>%
  ungroup() %>%
  dplyr::select(Year, PORTLANDED_CONF, nTrips, nVessels, Area) %>%
  group_by(PORTLANDED_CONF, Year, Area) %>%
  filter(PORTLANDED_CONF != 'All Others') %>%
  dplyr::summarize(
    nTrips = sum(nTrips, na.rm = T),
    nVessels = sum(nVessels, na.rm = T)) %>% 
  dplyr::rename("Port"= PORTLANDED_CONF) %>% 
  relocate(Year, Area, Port, nTrips, nVessels) %>% 
  arrange(desc(Year)) %>% 
  mutate(nTrips = comma_format(trim = TRUE)(as.numeric(nTrips))) %>%
  mutate(nVessels = comma_format(trim = TRUE)(as.numeric(nVessels))) %>%
  ungroup() %>% 
  dplyr::rename("Number of Trips"= nTrips,
                "Number of Vessels" = nVessels)

#### get number of vessels and trip tables for all areas
for (zone in allZones) {
  zone <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub(" ","_", zone), perl=TRUE) # make name pretty
  broadz <- gsub("(?<=\\b)([a-z])", "\\U\\1", gsub("_"," ", zone), perl=TRUE) # make name pretty
  # cat("\raggedright") 
  # cat(paste0("*", broadz, "*", "  ", "\n\n"),"  ") # display name of area
  vessel_trip_by_year <- vessel_trip_all_areas_by_year %>% filter(Area == zone) %>% dplyr::select(-Area)
  vessel_trip_by_year_fmp <- vessel_trip_all_areas_by_year_fmp %>% filter(Area == zone) %>% dplyr::select(-Area)
  vessel_trip_by_year_sppnm <- vessel_trip_all_areas_by_year_sppnm %>% filter(Area == zone) %>% dplyr::select(-Area)
  vessel_trip_by_year_port <- vessel_trip_all_areas_by_year_port %>% filter(Area == zone) %>% dplyr::select(-Area)

  cat("\n\n")
  cat("#### Total Number of Trips and Vessels by Year \n\n")
  print(kable(vessel_trip_by_year, caption = paste0('Total Number of Trips and Vessels by Year, ', broadz), align=c('l', 'r', 'r')))
  cat("\n\n")
  cat("\n\n")
      
if (seperate_tables_by_year) {
  cat("#### Total Number of Trips and Vessels by FMP")
  for (yr in sort(as.numeric(unique(vessel_trip_by_year_fmp$Year)), decreasing = TRUE))  { #cycle through years
    vessel_trip_by_year_fmp_table <- vessel_trip_by_year_fmp %>% filter(Year == yr) %>% dplyr::select(-Year)
    print(kable(vessel_trip_by_year_fmp_table, caption = paste0('Total Number of Trips and Vessels by FMP, ', broadz, ', ',yr), align=c('l', 'r', 'r')))
  cat("\n\n")
  cat("\n\n")
  }
  cat("#### Total Number of Trips and Vessels by Species")
  for (yr in sort(as.numeric(unique(vessel_trip_by_year_sppnm$Year)), decreasing = TRUE))  { #cycle through years
    vessel_trip_by_year_sppnm_table <- vessel_trip_by_year_sppnm %>% filter(Year == yr) %>% dplyr::select(-Year)
    print(kable(vessel_trip_by_year_sppnm_table, caption = paste0('Total Number of Trips and Vessels by Species, ', broadz, ', ',yr), align=c('l', 'r', 'r')))
  cat("\n\n")
  cat("\n\n")
  }
  cat("#### Total Number of Trips and Vessels by Port")
  for (yr in sort(as.numeric(unique(vessel_trip_by_year_port$Year)), decreasing = TRUE))  { #cycle through years
    vessel_trip_by_year_port_table <- vessel_trip_by_year_port %>% filter(Year == yr) %>% dplyr::select(-Year)
    print(kable(vessel_trip_by_year_port_table, caption = paste0('Total Number of Trips and Vessels by Port, ', broadz, ', ',yr), align=c('l', 'r', 'r')))
  }
} else {
  cat("#### Total Number of Trips and Vessels by FMP")
  print(kable(vessel_trip_by_year_fmp, caption = paste0('Total Number of Trips and Vessels by Year and FMP, ', broadz), align=c('l','l', 'r', 'r')))
  cat("\n\n")
  cat("\n\n")
  cat("#### Total Number of Trips and Vessels by Species")
  print(kable(vessel_trip_by_year_sppnm, caption = paste0('Total Number of Trips and Vessels by Year and Species, ', broadz), align=c('l','l', 'r', 'r')))
  cat("\n\n")
  cat("\n\n")
  cat("#### Total Number of Trips and Vessels by Port")
  print(kable(vessel_trip_by_year_port, caption = paste0('Total Number of Trips and Vessels by Year and Port, ', broadz), align=c('l','l', 'r', 'r')))
}
    

  
#   for (yr in sort(as.numeric(unique(allsppnm_table$Year)), decreasing = TRUE))  { #cycle through years
#     # cat(paste0("*", yr, "*", "  ", "\n\n"),"  ") # display year of area data
#     allsppnm_table_yr <- allsppnm_table %>% 
#       filter(yr == Year) %>% 
#       dplyr::select(-Year) %>%
#       arrange(desc(`Revenue as % of Total`)) %>% 
#       top_n(., n=10, wt=`Revenue as % of Total`) %>% 
#       mutate(Species = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(Species), perl=TRUE)) %>% 
#       mutate(Area = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", Area)), perl=TRUE)) %>% 
#       mutate(`Revenue as % of Total` = comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(`Revenue as % of Total`))) %>% 
#       mutate(`Landings as % of Total` = comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(`Landings as % of Total`))) %>% 
#       mutate(`DAS as % of Total` = comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(`DAS as % of Total`)))
#       
#     # uncomment below if alphabetical sorting is require(package)
#     # allsppnm_table <- allsppnm_table %>% arrange(Species, .by_group = TRUE)
#     # make Species names lowercase and areas proper case
#     # allsppnm_table$Species <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(allsppnm_table$Species), perl=TRUE)
#     # allsppnm_table$Area <- gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(gsub("_"," ", allsppnm_table$Area)), perl=TRUE)
#     # ##### allsppnm_table <- rbind(allsppnm_table, c("**Total**", colSums(allsppnm_table[,4]), colSums(allsppnm_table[,4])))
#     # allsppnm_table$`Revenue as % of Total` <- comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(allsppnm_table$`Revenue as % of Total`))
#     # allsppnm_table$`Landings as % of Total` <- comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(allsppnm_table$`Landings as % of Total`))
#     # allsppnm_table$`DAS as % of Total` <- comma_format(trim = TRUE, accuracy = 0.01)(as.numeric(allsppnm_table$`DAS as % of Total`))
#     cat("\n\n")
#     allsppnm_table_yr <- allsppnm_table_yr %>% dplyr::select(Species, `Revenue as % of Total`, `Landings as % of Total`, `DAS as % of Total`)
#     
#     print(kable(allsppnm_table_yr, caption = paste0('Percentages of Total, Revenue, Landings, and Days-at-Sea for Species of Interest, ', broadz, ', ', yr), align=c('l', 'l', 'l', 'l')))
#   cat("\n\n")
#   }
#   # print(kable(allsppnm_table, caption = paste0('Percentages of Total, Revenue, Landings, and Days-at-Sea for Species of Interest, ', broadz), align=c('l', 'l', 'l', 'l', 'l')))
#   cat("\n\n")
# }

  } # end - create effort section
  
rm(FIN, REVENUEFILE)

```
